<!DOCTYPE html>
<html lang="fa" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <meta name="theme-color" content="#0D9488">
    <title>ğŸï¸ Ø³ÙØ±ÛŒÙ†Ùˆ - Ù…Ø¯ÛŒØ±ÛŒØª Ù‡Ø²ÛŒÙ†Ù‡â€ŒÙ‡Ø§ÛŒ Ø³ÙØ±</title>
    
    <link rel="icon" href="data:image/svg+xml,<svg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 100 100'><text y='.9em' font-size='90'>ğŸï¸</text></svg>">
    <link href="https://cdn.jsdelivr.net/gh/rastikerdar/vazirmatn@v33.003/Vazirmatn-font-face.css" rel="stylesheet">

    <style>
        :root {
            --primary: #0D9488;
            --primary-light: #14B8A6;
            --primary-dark: #0F766E;
            --secondary: #F97316;
            --accent: #EAB308;
            --success: #10B981;
            --danger: #EF4444;
            --dark: #0F172A;
            --dark-light: #1E293B;
            --gray: #64748B;
            --gray-light: #94A3B8;
            --light: #F1F5F9;
            --white: #FFFFFF;
            --glass: rgba(255, 255, 255, 0.1);
            --glass-border: rgba(255, 255, 255, 0.2);
        }

        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Vazirmatn', system-ui, sans-serif;
            background: linear-gradient(135deg, var(--dark) 0%, var(--dark-light) 100%);
            min-height: 100vh;
            color: var(--white);
            line-height: 1.6;
        }

        .container {
            max-width: 480px;
            margin: 0 auto;
            padding: 16px;
        }

        /* Screens */
        .screen {
            display: none;
            min-height: 100vh;
            padding-bottom: 100px;
        }

        .screen.active {
            display: block;
        }

        /* Intro Screen */
        .intro-container {
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            min-height: 100vh;
            padding: 40px 20px;
            text-align: center;
        }

        .intro-logo {
            font-size: 5rem;
            margin-bottom: 20px;
            animation: float 3s ease-in-out infinite;
        }

        @keyframes float {
            0%, 100% { transform: translateY(0); }
            50% { transform: translateY(-10px); }
        }

        .intro-title {
            font-size: 2rem;
            font-weight: 800;
            background: linear-gradient(135deg, var(--primary-light), var(--accent));
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
            margin-bottom: 8px;
        }

        .intro-subtitle {
            color: var(--gray-light);
            margin-bottom: 40px;
        }

        .intro-buttons {
            display: flex;
            flex-direction: column;
            gap: 12px;
            width: 100%;
            max-width: 300px;
        }

        /* Buttons */
        .btn {
            display: inline-flex;
            align-items: center;
            justify-content: center;
            gap: 8px;
            padding: 14px 28px;
            border-radius: 50px;
            font-size: 1rem;
            font-weight: 600;
            font-family: inherit;
            border: none;
            cursor: pointer;
            transition: all 0.3s ease;
            text-decoration: none;
        }

        .btn-primary {
            background: linear-gradient(135deg, var(--primary) 0%, var(--primary-dark) 100%);
            color: var(--white);
            box-shadow: 0 4px 15px rgba(13, 148, 136, 0.4);
        }

        .btn-primary:hover {
            transform: translateY(-2px);
            box-shadow: 0 6px 20px rgba(13, 148, 136, 0.5);
        }

        .btn-outline {
            background: transparent;
            border: 2px solid var(--glass-border);
            color: var(--white);
        }

        .btn-outline:hover {
            background: var(--glass);
            border-color: var(--primary);
        }

        .btn-success {
            background: linear-gradient(135deg, var(--success) 0%, #059669 100%);
            color: var(--white);
        }

        .btn-secondary {
            background: linear-gradient(135deg, var(--secondary) 0%, #EA580C 100%);
            color: var(--white);
        }

        .btn-sm {
            padding: 8px 16px;
            font-size: 0.85rem;
        }

        .btn-icon {
            width: 44px;
            height: 44px;
            padding: 0;
            border-radius: 12px;
        }

        /* Modal */
        .modal {
            display: none;
            position: fixed;
            inset: 0;
            background: rgba(0, 0, 0, 0.8);
            backdrop-filter: blur(4px);
            z-index: 2000;
            align-items: flex-end;
            justify-content: center;
        }

        .modal.active {
            display: flex;
        }

        .modal-content {
            background: var(--dark-light);
            border-radius: 24px 24px 0 0;
            width: 100%;
            max-width: 480px;
            max-height: 90vh;
            overflow-y: auto;
            animation: slideUp 0.3s ease;
        }

        @keyframes slideUp {
            from { transform: translateY(100%); }
            to { transform: translateY(0); }
        }

        .modal-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 20px;
            border-bottom: 1px solid var(--glass-border);
            position: sticky;
            top: 0;
            background: var(--dark-light);
        }

        .modal-title {
            font-size: 1.2rem;
            font-weight: 600;
        }

        .modal-close {
            width: 36px;
            height: 36px;
            display: flex;
            align-items: center;
            justify-content: center;
            background: var(--dark);
            border: none;
            border-radius: 50%;
            color: var(--gray-light);
            font-size: 1.5rem;
            cursor: pointer;
        }

        .modal-close:hover {
            background: var(--danger);
            color: var(--white);
        }

        .modal-body {
            padding: 20px;
        }

        /* Forms */
        .form-group {
            margin-bottom: 16px;
        }

        .form-label {
            display: block;
            margin-bottom: 8px;
            font-size: 0.9rem;
            font-weight: 500;
            color: var(--gray-light);
        }

        .form-input {
            width: 100%;
            padding: 14px 16px;
            background: var(--dark);
            border: 2px solid var(--glass-border);
            border-radius: 12px;
            color: var(--white);
            font-size: 1rem;
            font-family: inherit;
            transition: all 0.3s ease;
        }

        .form-input:focus {
            outline: none;
            border-color: var(--primary);
        }

        .form-input::placeholder {
            color: var(--gray);
        }

        /* Header */
        .header {
            padding: 24px 0 16px;
            text-align: center;
        }

        .header-title {
            font-size: 1.75rem;
            font-weight: 800;
            background: linear-gradient(135deg, var(--primary-light), var(--accent));
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
        }

        /* Trip Header */
        .trip-header {
            background: linear-gradient(135deg, var(--primary) 0%, var(--primary-dark) 100%);
            border-radius: 24px;
            padding: 24px;
            margin-bottom: 20px;
            position: relative;
            overflow: hidden;
        }

        .trip-header::before {
            content: 'ğŸï¸';
            position: absolute;
            top: -20px;
            left: -20px;
            font-size: 100px;
            opacity: 0.1;
        }

        .trip-name {
            font-size: 1.5rem;
            font-weight: 700;
            margin-bottom: 8px;
        }

        .trip-info {
            display: flex;
            gap: 16px;
            font-size: 0.9rem;
            opacity: 0.9;
        }

        /* Stats Grid */
        .stats-grid {
            display: grid;
            grid-template-columns: repeat(2, 1fr);
            gap: 12px;
            margin-bottom: 20px;
        }

        .stat-card {
            background: var(--glass);
            backdrop-filter: blur(10px);
            border: 1px solid var(--glass-border);
            border-radius: 16px;
            padding: 16px;
            text-align: center;
        }

        .stat-icon {
            font-size: 1.5rem;
            margin-bottom: 8px;
        }

        .stat-value {
            font-size: 1.25rem;
            font-weight: 700;
        }

        .stat-label {
            font-size: 0.75rem;
            color: var(--gray-light);
        }

        .stat-card.success .stat-value { color: var(--success); }
        .stat-card.danger .stat-value { color: var(--danger); }
        .stat-card.warning .stat-value { color: var(--accent); }

        /* Section */
        .section {
            background: var(--glass);
            border: 1px solid var(--glass-border);
            border-radius: 24px;
            padding: 20px;
            margin-bottom: 16px;
        }

        .section-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 16px;
        }

        .section-title {
            font-size: 1.1rem;
            font-weight: 600;
        }

        /* List Item */
        .list-item {
            display: flex;
            align-items: center;
            gap: 12px;
            padding: 14px;
            background: var(--dark);
            border-radius: 12px;
            margin-bottom: 8px;
        }

        .list-icon {
            width: 44px;
            height: 44px;
            border-radius: 12px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 1.3rem;
            background: var(--glass);
        }

        .list-content {
            flex: 1;
        }

        .list-title {
            font-weight: 500;
        }

        .list-meta {
            font-size: 0.8rem;
            color: var(--gray-light);
        }

        .list-amount {
            font-weight: 700;
        }

        /* Card */
        .card {
            background: var(--dark);
            border: 1px solid var(--glass-border);
            border-radius: 16px;
            padding: 16px;
            margin-bottom: 12px;
        }

        .card-header {
            display: flex;
            align-items: center;
            gap: 12px;
            margin-bottom: 12px;
        }

        .card-avatar {
            width: 48px;
            height: 48px;
            background: var(--glass);
            border-radius: 12px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 1.5rem;
        }

        .card-title {
            font-weight: 600;
        }

        .card-subtitle {
            font-size: 0.8rem;
            color: var(--gray-light);
        }

        .card-actions {
            display: flex;
            gap: 8px;
            margin-top: 12px;
            padding-top: 12px;
            border-top: 1px solid var(--glass-border);
        }

        /* Bottom Navigation */
        .bottom-nav {
            position: fixed;
            bottom: 0;
            left: 0;
            right: 0;
            background: var(--dark-light);
            border-top: 1px solid var(--glass-border);
            display: flex;
            justify-content: space-around;
            padding: 8px 0;
            padding-bottom: max(8px, env(safe-area-inset-bottom));
            z-index: 1000;
        }

        .nav-item {
            display: flex;
            flex-direction: column;
            align-items: center;
            gap: 4px;
            padding: 8px 16px;
            color: var(--gray);
            font-size: 0.7rem;
            cursor: pointer;
            border: none;
            background: none;
            font-family: inherit;
            transition: color 0.3s;
        }

        .nav-item.active {
            color: var(--primary-light);
        }

        .nav-item .icon {
            font-size: 1.4rem;
        }

        /* FAB */
        .btn-fab {
            position: fixed;
            bottom: 80px;
            left: 50%;
            transform: translateX(-50%);
            width: 56px;
            height: 56px;
            border-radius: 50%;
            font-size: 1.5rem;
            padding: 0;
            z-index: 100;
            box-shadow: 0 4px 20px rgba(13, 148, 136, 0.5);
        }

        /* Avatar Grid */
        .avatar-grid {
            display: grid;
            grid-template-columns: repeat(6, 1fr);
            gap: 8px;
        }

        .avatar-option {
            aspect-ratio: 1;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 1.8rem;
            background: var(--dark);
            border: 2px solid var(--glass-border);
            border-radius: 12px;
            cursor: pointer;
            transition: all 0.3s;
        }

        .avatar-option:hover, .avatar-option.selected {
            border-color: var(--primary);
            background: var(--primary);
        }

        /* Category Grid */
        .category-grid {
            display: grid;
            grid-template-columns: repeat(3, 1fr);
            gap: 8px;
        }

        .category-option {
            display: flex;
            flex-direction: column;
            align-items: center;
            gap: 6px;
            padding: 14px 8px;
            background: var(--dark);
            border: 2px solid var(--glass-border);
            border-radius: 12px;
            cursor: pointer;
            transition: all 0.3s;
        }

        .category-option:hover, .category-option.selected {
            border-color: var(--primary);
            background: var(--primary);
        }

        .category-option .icon { font-size: 1.5rem; }
        .category-option .label { font-size: 0.75rem; }

        /* Checkbox Group */
        .checkbox-group {
            display: flex;
            flex-wrap: wrap;
            gap: 8px;
        }

        .checkbox-item {
            display: flex;
            align-items: center;
            gap: 8px;
            padding: 10px 14px;
            background: var(--dark);
            border: 2px solid var(--glass-border);
            border-radius: 50px;
            cursor: pointer;
            transition: all 0.3s;
            font-size: 0.9rem;
        }

        .checkbox-item:has(input:checked) {
            background: var(--primary);
            border-color: var(--primary);
        }

        .checkbox-item input { display: none; }

        /* Settlement */
        .settlement-card {
            background: linear-gradient(135deg, var(--success) 0%, #059669 100%);
            border-radius: 16px;
            padding: 20px;
            margin-bottom: 12px;
        }

        .settlement-flow {
            display: flex;
            align-items: center;
            justify-content: space-between;
        }

        .settlement-person {
            text-align: center;
        }

        .settlement-person .avatar { font-size: 2rem; }
        .settlement-person .name { font-size: 0.85rem; }

        .settlement-amount {
            background: var(--white);
            color: var(--success);
            padding: 6px 16px;
            border-radius: 50px;
            font-weight: 700;
        }

        /* Balance Card */
        .balance-card {
            border-radius: 16px;
            padding: 16px;
            text-align: center;
            border: 2px solid;
        }

        .balance-card.positive {
            background: rgba(16, 185, 129, 0.1);
            border-color: var(--success);
        }

        .balance-card.negative {
            background: rgba(239, 68, 68, 0.1);
            border-color: var(--danger);
        }

        .balance-card.zero {
            background: var(--dark);
            border-color: var(--gray);
        }

        .balance-avatar { font-size: 2.5rem; margin-bottom: 8px; }
        .balance-name { font-weight: 600; margin-bottom: 4px; }
        .balance-amount { font-size: 1.1rem; font-weight: 700; }

        /* Empty State */
        .empty-state {
            text-align: center;
            padding: 40px 20px;
            color: var(--gray);
        }

        .empty-state .icon {
            font-size: 4rem;
            margin-bottom: 16px;
            opacity: 0.5;
        }

        /* Toast */
        .toast {
            position: fixed;
            bottom: 100px;
            left: 50%;
            transform: translateX(-50%) translateY(100px);
            background: var(--dark-light);
            border: 1px solid var(--glass-border);
            padding: 14px 24px;
            border-radius: 50px;
            font-size: 0.9rem;
            z-index: 3000;
            opacity: 0;
            transition: all 0.3s;
        }

        .toast.show {
            transform: translateX(-50%) translateY(0);
            opacity: 1;
        }

        /* Share */
        .share-box {
            background: var(--dark);
            border-radius: 12px;
            padding: 16px;
            margin-bottom: 16px;
        }

        .share-link {
            display: flex;
            gap: 8px;
            margin-bottom: 12px;
        }

        .share-link input {
            flex: 1;
            padding: 12px;
            background: var(--dark-light);
            border: 1px solid var(--glass-border);
            border-radius: 12px;
            color: var(--white);
            font-family: inherit;
            font-size: 0.8rem;
        }

        .share-buttons {
            display: flex;
            gap: 8px;
        }

        .share-buttons .btn { flex: 1; }

        .qr-container {
            background: var(--white);
            border-radius: 12px;
            padding: 20px;
            display: flex;
            justify-content: center;
        }

        /* Footer */
        .footer-credit {
            text-align: center;
            padding: 20px;
            color: var(--gray);
            font-size: 0.8rem;
        }

        .footer-credit a {
            color: var(--primary-light);
            text-decoration: none;
        }

        /* Admin */
        .admin-only { display: none; }
        .is-admin .admin-only { display: flex; }

        /* Form Select */
        .form-select {
            appearance: none;
            background-image: url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' fill='none' viewBox='0 0 24 24' stroke='%2394A3B8'%3E%3Cpath stroke-linecap='round' stroke-linejoin='round' stroke-width='2' d='M19 9l-7 7-7-7'%3E%3C/path%3E%3C/svg%3E");
            background-repeat: no-repeat;
            background-position: left 12px center;
            background-size: 20px;
            padding-left: 40px;
        }

        /* Report */
        .report-summary {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 12px;
            margin-bottom: 20px;
        }

        .report-item {
            background: var(--dark);
            padding: 16px;
            border-radius: 12px;
            text-align: center;
        }

        .report-item .value {
            font-size: 1.2rem;
            font-weight: 700;
            color: var(--primary-light);
        }

        .report-item .label {
            font-size: 0.8rem;
            color: var(--gray-light);
        }
    </style>
</head>
<body>
    <div class="toast" id="toast"></div>

    <!-- ============ INTRO SCREEN ============ -->
    <div class="screen active" id="introScreen">
        <div class="container">
            <div class="intro-container">
                <div class="intro-logo">ğŸï¸</div>
                <h1 class="intro-title">Ø³ÙØ±ÛŒÙ†Ùˆ</h1>
                <p class="intro-subtitle">Ù…Ø¯ÛŒØ±ÛŒØª Ù‡Ø²ÛŒÙ†Ù‡â€ŒÙ‡Ø§ÛŒ Ú¯Ø±ÙˆÙ‡ÛŒ Ø³ÙØ±</p>
                
                <div class="intro-buttons">
                    <button class="btn btn-primary" onclick="openModal('createTrip')">
                        âœ¨ Ø§ÛŒØ¬Ø§Ø¯ Ø³ÙØ± Ø¬Ø¯ÛŒØ¯
                    </button>
                    <button class="btn btn-outline" onclick="openModal('joinTrip')">
                        ğŸ”— ÙˆØ±ÙˆØ¯ Ø¨Ø§ Ù„ÛŒÙ†Ú©
                    </button>
                </div>

                <div class="footer-credit" style="margin-top: 60px;">
                    <p>Ø·Ø±Ø§Ø­ÛŒ Ùˆ Ø¨Ø±Ù†Ø§Ù…Ù‡â€ŒÙ†ÙˆÛŒØ³ÛŒ</p>
                    <p><strong>Ù…Ø­Ù…Ø¯ Ø¹Ø¨Ø§Ø³ÛŒ</strong> | Mohamad Abbasi</p>
                </div>
            </div>
        </div>
    </div>

    <!-- ============ MAIN SCREEN ============ -->
    <div class="screen" id="mainScreen">
        <div class="container">
            <div class="header">
                <h1 class="header-title">Ø³ÙØ±ÛŒÙ†Ùˆ</h1>
            </div>

            <div class="trip-header">
                <h2 class="trip-name" id="tripName">Ø³ÙØ± Ù…Ù†</h2>
                <div class="trip-info">
                    <span>ğŸ‘¥ <span id="memberCountHeader">0</span> Ù†ÙØ±</span>
                    <span>ğŸ“… <span id="tripDate"></span></span>
                </div>
                <div style="margin-top: 12px; display: flex; gap: 8px;">
                    <button class="btn btn-sm btn-outline" onclick="openModal('share')" style="flex: 1;">
                        ğŸ“¤ Ø§Ø´ØªØ±Ø§Ú©â€ŒÚ¯Ø°Ø§Ø±ÛŒ
                    </button>
                    <button class="btn btn-sm btn-outline" onclick="openModal('adminLogin')" id="adminBtn">
                        ğŸ”
                    </button>
                </div>
            </div>

            <div class="stats-grid">
                <div class="stat-card success">
                    <div class="stat-icon">ğŸ’°</div>
                    <div class="stat-value" id="totalDeposits">Û°</div>
                    <div class="stat-label">Ú©Ù„ ÙˆØ§Ø±ÛŒØ²ÛŒ</div>
                </div>
                <div class="stat-card danger">
                    <div class="stat-icon">ğŸ›’</div>
                    <div class="stat-value" id="totalExpenses">Û°</div>
                    <div class="stat-label">Ú©Ù„ Ù‡Ø²ÛŒÙ†Ù‡</div>
                </div>
                <div class="stat-card warning">
                    <div class="stat-icon">ğŸ’µ</div>
                    <div class="stat-value" id="fundBalance">Û°</div>
                    <div class="stat-label">Ù…Ø§Ù†Ø¯Ù‡ ØµÙ†Ø¯ÙˆÙ‚</div>
                </div>
                <div class="stat-card">
                    <div class="stat-icon">ğŸ‘¥</div>
                    <div class="stat-value" id="memberCount">Û°</div>
                    <div class="stat-label">ØªØ¹Ø¯Ø§Ø¯ Ø§Ø¹Ø¶Ø§</div>
                </div>
            </div>

            <div id="tabContent"></div>

            <div class="footer-credit">
                <p>Ø·Ø±Ø§Ø­ÛŒ Ùˆ Ø¨Ø±Ù†Ø§Ù…Ù‡â€ŒÙ†ÙˆÛŒØ³ÛŒ: <a href="#">Ù…Ø­Ù…Ø¯ Ø¹Ø¨Ø§Ø³ÛŒ</a> | Mohamad Abbasi</p>
            </div>
        </div>

        <button class="btn btn-primary btn-fab admin-only" onclick="openModal('fabMenu')">â•</button>

        <nav class="bottom-nav">
            <button class="nav-item active" data-tab="expenses" onclick="switchTab('expenses')">
                <span class="icon">ğŸ›’</span>
                <span>Ù‡Ø²ÛŒÙ†Ù‡â€ŒÙ‡Ø§</span>
            </button>
            <button class="nav-item" data-tab="members" onclick="switchTab('members')">
                <span class="icon">ğŸ‘¥</span>
                <span>Ø§Ø¹Ø¶Ø§</span>
            </button>
            <button class="nav-item" data-tab="settlement" onclick="switchTab('settlement')">
                <span class="icon">âš–ï¸</span>
                <span>ØªØ³ÙˆÛŒÙ‡</span>
            </button>
            <button class="nav-item" data-tab="reports" onclick="switchTab('reports')">
                <span class="icon">ğŸ“Š</span>
                <span>Ú¯Ø²Ø§Ø±Ø´</span>
            </button>
        </nav>
    </div>

    <!-- ============ MODALS ============ -->
    
    <!-- Create Trip Modal -->
    <div class="modal" id="modal-createTrip">
        <div class="modal-content">
            <div class="modal-header">
                <h3 class="modal-title">âœ¨ Ø§ÛŒØ¬Ø§Ø¯ Ø³ÙØ± Ø¬Ø¯ÛŒØ¯</h3>
                <button class="modal-close" onclick="closeModal('createTrip')">Ã—</button>
            </div>
            <div class="modal-body">
                <form id="createTripForm" onsubmit="createTrip(event)">
                    <div class="form-group">
                        <label class="form-label">Ù†Ø§Ù… Ø³ÙØ±</label>
                        <input type="text" class="form-input" id="newTripName" required placeholder="Ù…Ø«Ø§Ù„: Ø³ÙØ± Ù‚Ø´Ù…">
                    </div>
                    <div class="form-group">
                        <label class="form-label">Ø±Ù…Ø² Ø¹Ø¨ÙˆØ± Ù…Ø¯ÛŒØ± (Û´ ØªØ§ Û¶ Ø±Ù‚Ù…)</label>
                        <input type="password" class="form-input" id="newTripPassword" required 
                               pattern="[0-9]{4,6}" inputmode="numeric" placeholder="Ù…Ø«Ø§Ù„: Û±Û²Û³Û´">
                    </div>
                    <button type="submit" class="btn btn-primary" style="width: 100%;">
                        ğŸš€ Ø§ÛŒØ¬Ø§Ø¯ Ø³ÙØ±
                    </button>
                </form>
            </div>
        </div>
    </div>

    <!-- Join Trip Modal -->
    <div class="modal" id="modal-joinTrip">
        <div class="modal-content">
            <div class="modal-header">
                <h3 class="modal-title">ğŸ”— ÙˆØ±ÙˆØ¯ Ø¨Ø§ Ù„ÛŒÙ†Ú©</h3>
                <button class="modal-close" onclick="closeModal('joinTrip')">Ã—</button>
            </div>
            <div class="modal-body">
                <form onsubmit="joinTrip(event)">
                    <div class="form-group">
                        <label class="form-label">Ú©Ø¯ ÛŒØ§ Ù„ÛŒÙ†Ú© Ø³ÙØ±</label>
                        <input type="text" class="form-input" id="tripCodeInput" required placeholder="Ú©Ø¯ Ø³ÙØ± Ø±Ø§ ÙˆØ§Ø±Ø¯ Ú©Ù†ÛŒØ¯">
                    </div>
                    <button type="submit" class="btn btn-primary" style="width: 100%;">ÙˆØ±ÙˆØ¯</button>
                </form>
            </div>
        </div>
    </div>

    <!-- Admin Login Modal -->
    <div class="modal" id="modal-adminLogin">
        <div class="modal-content">
            <div class="modal-header">
                <h3 class="modal-title">ğŸ” ÙˆØ±ÙˆØ¯ Ù…Ø¯ÛŒØ±</h3>
                <button class="modal-close" onclick="closeModal('adminLogin')">Ã—</button>
            </div>
            <div class="modal-body">
                <form onsubmit="adminLogin(event)">
                    <div class="form-group">
                        <label class="form-label">Ø±Ù…Ø² Ø¹Ø¨ÙˆØ±</label>
                        <input type="password" class="form-input" id="adminPasswordInput" required inputmode="numeric" placeholder="Ø±Ù…Ø² Û´ Ø±Ù‚Ù…ÛŒ">
                    </div>
                    <button type="submit" class="btn btn-primary" style="width: 100%;">ÙˆØ±ÙˆØ¯</button>
                </form>
            </div>
        </div>
    </div>

    <!-- FAB Menu Modal -->
    <div class="modal" id="modal-fabMenu">
        <div class="modal-content" style="max-height: auto;">
            <div class="modal-body">
                <div style="display: flex; flex-direction: column; gap: 12px;">
                    <button class="btn btn-secondary" onclick="closeModal('fabMenu'); openModal('addExpense');">
                        ğŸ›’ Ø«Ø¨Øª Ù‡Ø²ÛŒÙ†Ù‡
                    </button>
                    <button class="btn btn-success" onclick="closeModal('fabMenu'); openModal('addDeposit');">
                        ğŸ’³ Ø«Ø¨Øª ÙˆØ§Ø±ÛŒØ²ÛŒ
                    </button>
                    <button class="btn btn-outline" onclick="closeModal('fabMenu'); openModal('addMember');">
                        ğŸ‘¤ Ø§ÙØ²ÙˆØ¯Ù† Ø¹Ø¶Ùˆ
                    </button>
                </div>
            </div>
        </div>
    </div>

    <!-- Add Member Modal -->
    <div class="modal" id="modal-addMember">
        <div class="modal-content">
            <div class="modal-header">
                <h3 class="modal-title">ğŸ‘¤ Ø§ÙØ²ÙˆØ¯Ù† Ø¹Ø¶Ùˆ</h3>
                <button class="modal-close" onclick="closeModal('addMember')">Ã—</button>
            </div>
            <div class="modal-body">
                <form onsubmit="addMember(event)">
                    <div class="form-group">
                        <label class="form-label">Ù†Ø§Ù…</label>
                        <input type="text" class="form-input" id="memberName" required placeholder="Ù†Ø§Ù… Ø´Ø®Øµ">
                    </div>
                    <div class="form-group">
                        <label class="form-label">Ø¢ÙˆØ§ØªØ§Ø±</label>
                        <div class="avatar-grid" id="avatarGrid"></div>
                    </div>
                    <button type="submit" class="btn btn-primary" style="width: 100%;">âœ… Ø§ÙØ²ÙˆØ¯Ù†</button>
                </form>
            </div>
        </div>
    </div>

    <!-- Add Deposit Modal -->
    <div class="modal" id="modal-addDeposit">
        <div class="modal-content">
            <div class="modal-header">
                <h3 class="modal-title">ğŸ’³ Ø«Ø¨Øª ÙˆØ§Ø±ÛŒØ²ÛŒ</h3>
                <button class="modal-close" onclick="closeModal('addDeposit')">Ã—</button>
            </div>
            <div class="modal-body">
                <form onsubmit="addDeposit(event)">
                    <div class="form-group">
                        <label class="form-label">ÙˆØ§Ø±ÛŒØ²Ú©Ù†Ù†Ø¯Ù‡</label>
                        <select class="form-input form-select" id="depositMember" required></select>
                    </div>
                    <div class="form-group">
                        <label class="form-label">Ù…Ø¨Ù„Øº (ØªÙˆÙ…Ø§Ù†)</label>
                        <input type="number" class="form-input" id="depositAmount" required inputmode="numeric" placeholder="Ù…Ø«Ø§Ù„: Û±Û°Û°Û°Û°Û°Û°">
                    </div>
                    <div class="form-group">
                        <label class="form-label">ØªÙˆØ¶ÛŒØ­Ø§Øª</label>
                        <input type="text" class="form-input" id="depositDesc" placeholder="Ø§Ø®ØªÛŒØ§Ø±ÛŒ">
                    </div>
                    <button type="submit" class="btn btn-success" style="width: 100%;">âœ… Ø«Ø¨Øª</button>
                </form>
            </div>
        </div>
    </div>

    <!-- Add Expense Modal -->
    <div class="modal" id="modal-addExpense">
        <div class="modal-content">
            <div class="modal-header">
                <h3 class="modal-title">ğŸ›’ Ø«Ø¨Øª Ù‡Ø²ÛŒÙ†Ù‡</h3>
                <button class="modal-close" onclick="closeModal('addExpense')">Ã—</button>
            </div>
            <div class="modal-body">
                <form onsubmit="addExpense(event)">
                    <div class="form-group">
                        <label class="form-label">Ø¹Ù†ÙˆØ§Ù†</label>
                        <input type="text" class="form-input" id="expenseTitle" required placeholder="Ù…Ø«Ø§Ù„: Ù†Ø§Ù‡Ø§Ø±">
                    </div>
                    <div class="form-group">
                        <label class="form-label">Ø¯Ø³ØªÙ‡â€ŒØ¨Ù†Ø¯ÛŒ</label>
                        <div class="category-grid" id="categoryGrid"></div>
                    </div>
                    <div class="form-group">
                        <label class="form-label">Ù…Ø¨Ù„Øº (ØªÙˆÙ…Ø§Ù†)</label>
                        <input type="number" class="form-input" id="expenseAmount" required inputmode="numeric" placeholder="Ù…Ø«Ø§Ù„: ÛµÛ°Û°Û°Û°Û°">
                    </div>
                    <div class="form-group">
                        <label class="form-label">Ù¾Ø±Ø¯Ø§Ø®Øª Ø§Ø²</label>
                        <select class="form-input form-select" id="expensePaidBy" required></select>
                    </div>
                    <div class="form-group">
                        <label class="form-label">ØªÙ‚Ø³ÛŒÙ… Ø¨ÛŒÙ† <button type="button" class="btn btn-sm btn-outline" onclick="selectAllMembers()" style="float:left;">Ù‡Ù…Ù‡</button></label>
                        <div class="checkbox-group" id="expenseSplitMembers"></div>
                    </div>
                    <button type="submit" class="btn btn-secondary" style="width: 100%;">âœ… Ø«Ø¨Øª Ù‡Ø²ÛŒÙ†Ù‡</button>
                </form>
            </div>
        </div>
    </div>

    <!-- Share Modal -->
    <div class="modal" id="modal-share">
        <div class="modal-content">
            <div class="modal-header">
                <h3 class="modal-title">ğŸ“¤ Ø§Ø´ØªØ±Ø§Ú©â€ŒÚ¯Ø°Ø§Ø±ÛŒ</h3>
                <button class="modal-close" onclick="closeModal('share')">Ã—</button>
            </div>
            <div class="modal-body">
                <div class="share-box">
                    <p style="margin-bottom: 12px; color: var(--gray-light);">Ù„ÛŒÙ†Ú© Ø³ÙØ±:</p>
                    <div class="share-link">
                        <input type="text" id="shareLink" readonly>
                        <button type="button" class="btn btn-primary btn-icon" onclick="copyLink()">ğŸ“‹</button>
                    </div>
                    <div class="share-buttons">
                        <button class="btn btn-success" onclick="shareWhatsApp()">ÙˆØ§ØªØ³Ø§Ù¾ ğŸ’¬</button>
                    </div>
                </div>
                <div class="qr-container" id="qrContainer"></div>
            </div>
        </div>
    </div>

    <!-- Report Share Modal -->
    <div class="modal" id="modal-reportShare">
        <div class="modal-content">
            <div class="modal-header">
                <h3 class="modal-title">ğŸ“¤ Ø§Ø±Ø³Ø§Ù„ Ú¯Ø²Ø§Ø±Ø´</h3>
                <button class="modal-close" onclick="closeModal('reportShare')">Ã—</button>
            </div>
            <div class="modal-body">
                <div style="display: flex; flex-direction: column; gap: 12px;">
                    <button class="btn btn-success" onclick="shareReport('summary')">ğŸ“Š Ø®Ù„Ø§ØµÙ‡ Ø³ÙØ±</button>
                    <button class="btn btn-success" onclick="shareReport('settlement')">âš–ï¸ ØªØ³ÙˆÛŒÙ‡ Ø­Ø³Ø§Ø¨</button>
                    <button class="btn btn-success" onclick="shareReport('full')">ğŸ“‹ Ú¯Ø²Ø§Ø±Ø´ Ú©Ø§Ù…Ù„</button>
                </div>
            </div>
        </div>
    </div>

    <!-- ============ FIREBASE & APP ============ -->
    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.0/firebase-app.js";
        import { getDatabase, ref, set, get, remove, onValue } from "https://www.gstatic.com/firebasejs/10.7.0/firebase-database.js";

        const firebaseConfig = {
            apiKey: "AIzaSyDbe52llu3IoCyjtyT4-QAnsJV0z7VWmbo",
            authDomain: "qeshm-trip.firebaseapp.com",
            databaseURL: "https://qeshm-trip-default-rtdb.firebaseio.com",
            projectId: "qeshm-trip",
            storageBucket: "qeshm-trip.firebasestorage.app",
            messagingSenderId: "1017400189320",
            appId: "1:1017400189320:web:62fbe9d077fc91be1cda3d"
        };

        const app = initializeApp(firebaseConfig);
        const db = getDatabase(app);

        // App State
        const state = {
            tripId: null,
            tripData: null,
            isAdmin: false,
            currentTab: 'expenses',
            selectedAvatar: 'ğŸ‘¨',
            selectedCategory: 'food'
        };

        // Categories
        const categories = [
            { id: 'food', icon: 'ğŸ”', label: 'ØºØ°Ø§' },
            { id: 'transport', icon: 'ğŸš—', label: 'Ø­Ù…Ù„â€ŒÙˆÙ†Ù‚Ù„' },
            { id: 'stay', icon: 'ğŸ¨', label: 'Ø§Ù‚Ø§Ù…Øª' },
            { id: 'fun', icon: 'ğŸ¢', label: 'ØªÙØ±ÛŒØ­' },
            { id: 'shopping', icon: 'ğŸ›ï¸', label: 'Ø®Ø±ÛŒØ¯' },
            { id: 'other', icon: 'ğŸ“¦', label: 'Ø³Ø§ÛŒØ±' }
        ];

        // Avatars
        const avatars = ['ğŸ‘¨', 'ğŸ‘©', 'ğŸ‘¦', 'ğŸ‘§', 'ğŸ§”', 'ğŸ‘´', 'ğŸ‘µ', 'ğŸ§‘', 'ğŸ‘±', 'ğŸ‘²', 'ğŸ§•', 'ğŸ¤µ'];

        // Utility Functions
        const formatNumber = num => new Intl.NumberFormat('fa-IR').format(num || 0);
        const generateId = () => Date.now().toString(36) + Math.random().toString(36).substr(2, 9);
        
        const getJalaliDate = () => {
            const d = new Date();
            return d.toLocaleDateString('fa-IR');
        };

        const showToast = (msg, type = 'success') => {
            const toast = document.getElementById('toast');
            toast.textContent = msg;
            toast.style.borderColor = type === 'error' ? 'var(--danger)' : 'var(--success)';
            toast.classList.add('show');
            setTimeout(() => toast.classList.remove('show'), 3000);
        };

        const getCategoryInfo = id => categories.find(c => c.id === id) || categories[5];

        // Modal Functions
        window.openModal = id => {
            document.getElementById('modal-' + id).classList.add('active');
            if (id === 'addDeposit' || id === 'addExpense') populateSelects();
            if (id === 'share') generateShareLink();
        };

        window.closeModal = id => {
            document.getElementById('modal-' + id).classList.remove('active');
        };

        // Close modal on backdrop click
        document.querySelectorAll('.modal').forEach(m => {
            m.addEventListener('click', e => {
                if (e.target === m) m.classList.remove('active');
            });
        });

        // Initialize UI Elements
        function initUI() {
            // Avatar Grid
            const avatarGrid = document.getElementById('avatarGrid');
            avatarGrid.innerHTML = avatars.map((a, i) => 
                `<div class="avatar-option ${i === 0 ? 'selected' : ''}" data-avatar="${a}">${a}</div>`
            ).join('');

            avatarGrid.addEventListener('click', e => {
                const opt = e.target.closest('.avatar-option');
                if (opt) {
                    avatarGrid.querySelectorAll('.avatar-option').forEach(o => o.classList.remove('selected'));
                    opt.classList.add('selected');
                    state.selectedAvatar = opt.dataset.avatar;
                }
            });

            // Category Grid
            const categoryGrid = document.getElementById('categoryGrid');
            categoryGrid.innerHTML = categories.map((c, i) => 
                `<div class="category-option ${i === 0 ? 'selected' : ''}" data-category="${c.id}">
                    <span class="icon">${c.icon}</span>
                    <span class="label">${c.label}</span>
                </div>`
            ).join('');

            categoryGrid.addEventListener('click', e => {
                const opt = e.target.closest('.category-option');
                if (opt) {
                    categoryGrid.querySelectorAll('.category-option').forEach(o => o.classList.remove('selected'));
                    opt.classList.add('selected');
                    state.selectedCategory = opt.dataset.category;
                }
            });

            // Set date
            document.getElementById('tripDate').textContent = getJalaliDate();
        }

        // Trip Functions
        window.createTrip = async e => {
            e.preventDefault();
            const name = document.getElementById('newTripName').value.trim();
            const password = document.getElementById('newTripPassword').value.trim();

            if (!name || !password) return showToast('Ù„Ø·ÙØ§Ù‹ Ù‡Ù…Ù‡ ÙÛŒÙ„Ø¯Ù‡Ø§ Ø±Ø§ Ù¾Ø± Ú©Ù†ÛŒØ¯', 'error');

            const tripId = generateId();
            const tripData = {
                name,
                password,
                createdAt: Date.now(),
                members: {},
                deposits: {},
                expenses: {}
            };

            try {
                await set(ref(db, 'trips/' + tripId), tripData);
                state.tripId = tripId;
                state.tripData = tripData;
                state.isAdmin = true;
                localStorage.setItem('lastTrip', tripId);
                localStorage.setItem('admin_' + tripId, 'true');
                closeModal('createTrip');
                showMainScreen();
                showToast('Ø³ÙØ± Ø§ÛŒØ¬Ø§Ø¯ Ø´Ø¯! âœ¨');
            } catch (err) {
                console.error(err);
                showToast('Ø®Ø·Ø§ Ø¯Ø± Ø§ÛŒØ¬Ø§Ø¯ Ø³ÙØ±', 'error');
            }
        };

        window.joinTrip = async e => {
            e.preventDefault();
            let code = document.getElementById('tripCodeInput').value.trim();
            if (code.includes('trip=')) code = code.split('trip=')[1].split('&')[0];

            try {
                const snap = await get(ref(db, 'trips/' + code));
                if (snap.exists()) {
                    state.tripId = code;
                    state.tripData = snap.val();
                    state.isAdmin = localStorage.getItem('admin_' + code) === 'true';
                    localStorage.setItem('lastTrip', code);
                    closeModal('joinTrip');
                    showMainScreen();
                    showToast('Ø®ÙˆØ´ Ø¢Ù…Ø¯ÛŒØ¯! ğŸ‰');
                } else {
                    showToast('Ø³ÙØ± ÛŒØ§ÙØª Ù†Ø´Ø¯', 'error');
                }
            } catch (err) {
                console.error(err);
                showToast('Ø®Ø·Ø§ Ø¯Ø± ÙˆØ±ÙˆØ¯', 'error');
            }
        };

        window.adminLogin = e => {
            e.preventDefault();
            const pass = document.getElementById('adminPasswordInput').value;
            if (state.tripData?.password === pass) {
                state.isAdmin = true;
                localStorage.setItem('admin_' + state.tripId, 'true');
                closeModal('adminLogin');
                updateAdminUI();
                showToast('ÙˆØ±ÙˆØ¯ Ù…ÙˆÙÙ‚! ğŸ”“');
            } else {
                showToast('Ø±Ù…Ø² Ø§Ø´ØªØ¨Ø§Ù‡ Ø§Ø³Øª', 'error');
            }
        };

        // Member Functions
        window.addMember = async e => {
            e.preventDefault();
            const name = document.getElementById('memberName').value.trim();
            if (!name) return;

            const id = generateId();
            try {
                await set(ref(db, `trips/${state.tripId}/members/${id}`), {
                    name,
                    avatar: state.selectedAvatar,
                    createdAt: Date.now()
                });
                document.getElementById('memberName').value = '';
                closeModal('addMember');
                showToast('Ø¹Ø¶Ùˆ Ø§Ø¶Ø§ÙÙ‡ Ø´Ø¯! ğŸ‘¤');
            } catch (err) {
                showToast('Ø®Ø·Ø§', 'error');
            }
        };

        window.deleteMember = async id => {
            if (!confirm('Ø­Ø°Ù Ø´ÙˆØ¯ØŸ')) return;
            try {
                await remove(ref(db, `trips/${state.tripId}/members/${id}`));
                showToast('Ø­Ø°Ù Ø´Ø¯');
            } catch (err) {
                showToast('Ø®Ø·Ø§', 'error');
            }
        };

        // Deposit Functions
        window.addDeposit = async e => {
            e.preventDefault();
            const memberId = document.getElementById('depositMember').value;
            const amount = parseInt(document.getElementById('depositAmount').value);
            const desc = document.getElementById('depositDesc').value || 'ÙˆØ§Ø±ÛŒØ²';

            if (!memberId || !amount) return showToast('Ø§Ø·Ù„Ø§Ø¹Ø§Øª Ù†Ø§Ù‚Øµ', 'error');

            try {
                await set(ref(db, `trips/${state.tripId}/deposits/${generateId()}`), {
                    memberId, amount, description: desc, date: Date.now()
                });
                document.getElementById('depositAmount').value = '';
                document.getElementById('depositDesc').value = '';
                closeModal('addDeposit');
                showToast('ÙˆØ§Ø±ÛŒØ²ÛŒ Ø«Ø¨Øª Ø´Ø¯! ğŸ’³');
            } catch (err) {
                showToast('Ø®Ø·Ø§', 'error');
            }
        };

        window.deleteDeposit = async id => {
            if (!confirm('Ø­Ø°Ù Ø´ÙˆØ¯ØŸ')) return;
            try {
                await remove(ref(db, `trips/${state.tripId}/deposits/${id}`));
                showToast('Ø­Ø°Ù Ø´Ø¯');
            } catch (err) {
                showToast('Ø®Ø·Ø§', 'error');
            }
        };

        // Expense Functions
        window.addExpense = async e => {
            e.preventDefault();
            const title = document.getElementById('expenseTitle').value.trim();
            const amount = parseInt(document.getElementById('expenseAmount').value);
            const paidBy = document.getElementById('expensePaidBy').value;

            const selectedMembers = [];
            document.querySelectorAll('#expenseSplitMembers input:checked').forEach(cb => {
                selectedMembers.push(cb.value);
            });

            if (!title || !amount || selectedMembers.length === 0) {
                return showToast('Ø§Ø·Ù„Ø§Ø¹Ø§Øª Ù†Ø§Ù‚Øµ', 'error');
            }

            const splitAmount = amount / selectedMembers.length;
            const splits = {};
            selectedMembers.forEach(id => splits[id] = splitAmount);

            try {
                await set(ref(db, `trips/${state.tripId}/expenses/${generateId()}`), {
                    title,
                    amount,
                    category: state.selectedCategory,
                    paidBy,
                    splits,
                    date: Date.now()
                });
                document.getElementById('expenseTitle').value = '';
                document.getElementById('expenseAmount').value = '';
                closeModal('addExpense');
                showToast('Ù‡Ø²ÛŒÙ†Ù‡ Ø«Ø¨Øª Ø´Ø¯! ğŸ›’');
            } catch (err) {
                showToast('Ø®Ø·Ø§', 'error');
            }
        };

        window.deleteExpense = async id => {
            if (!confirm('Ø­Ø°Ù Ø´ÙˆØ¯ØŸ')) return;
            try {
                await remove(ref(db, `trips/${state.tripId}/expenses/${id}`));
                showToast('Ø­Ø°Ù Ø´Ø¯');
            } catch (err) {
                showToast('Ø®Ø·Ø§', 'error');
            }
        };

        window.selectAllMembers = () => {
            document.querySelectorAll('#expenseSplitMembers input').forEach(cb => cb.checked = true);
        };

        // Populate Selects
        function populateSelects() {
            const members = state.tripData?.members || {};
            const arr = Object.entries(members);

            // Deposit
            const depositSel = document.getElementById('depositMember');
            depositSel.innerHTML = '<option value="">Ø§Ù†ØªØ®Ø§Ø¨ Ú©Ù†ÛŒØ¯...</option>' + 
                arr.map(([id, m]) => `<option value="${id}">${m.avatar} ${m.name}</option>`).join('');

            // Expense Paid By
            const expenseSel = document.getElementById('expensePaidBy');
            expenseSel.innerHTML = '<option value="fund">ğŸ’° ØµÙ†Ø¯ÙˆÙ‚</option>' +
                arr.map(([id, m]) => `<option value="${id}">${m.avatar} ${m.name}</option>`).join('');

            // Split Members
            const splitDiv = document.getElementById('expenseSplitMembers');
            splitDiv.innerHTML = arr.map(([id, m]) => 
                `<label class="checkbox-item"><input type="checkbox" value="${id}" checked>${m.avatar} ${m.name}</label>`
            ).join('');
        }

        // Navigation
        window.switchTab = tab => {
            state.currentTab = tab;
            document.querySelectorAll('.nav-item').forEach(n => 
                n.classList.toggle('active', n.dataset.tab === tab)
            );
            renderTab();
        };

        // Show Screens
        function showMainScreen() {
            document.getElementById('introScreen').classList.remove('active');
            document.getElementById('mainScreen').classList.add('active');
            updateAdminUI();
            listenToTrip();
        }

        function updateAdminUI() {
            document.body.classList.toggle('is-admin', state.isAdmin);
            document.getElementById('adminBtn').textContent = state.isAdmin ? 'ğŸ”“' : 'ğŸ”';
        }

        // Listen to Firebase
        function listenToTrip() {
            if (!state.tripId) return;
            onValue(ref(db, 'trips/' + state.tripId), snap => {
                if (snap.exists()) {
                    state.tripData = snap.val();
                    updateUI();
                }
            });
        }

        // Update UI
        function updateUI() {
            const data = state.tripData;
            if (!data) return;

            const members = data.members || {};
            const deposits = data.deposits || {};
            const expenses = data.expenses || {};

            document.getElementById('tripName').textContent = data.name || 'Ø³ÙØ±';
            document.getElementById('memberCountHeader').textContent = Object.keys(members).length;

            const totalDep = Object.values(deposits).reduce((s, d) => s + (d.amount || 0), 0);
            const totalExp = Object.values(expenses).filter(e => e.paidBy === 'fund').reduce((s, e) => s + (e.amount || 0), 0);

            document.getElementById('totalDeposits').textContent = formatNumber(totalDep);
            document.getElementById('totalExpenses').textContent = formatNumber(totalExp);
            document.getElementById('fundBalance').textContent = formatNumber(totalDep - totalExp);
            document.getElementById('memberCount').textContent = Object.keys(members).length;

            renderTab();
        }

        // Render Tabs
        function renderTab() {
            const container = document.getElementById('tabContent');
            const data = state.tripData || {};
            const members = data.members || {};
            const deposits = data.deposits || {};
            const expenses = data.expenses || {};

            let html = '';

            if (state.currentTab === 'expenses') {
                html = `<div class="section"><div class="section-header"><h3 class="section-title">ğŸ’³ ÙˆØ§Ø±ÛŒØ²ÛŒâ€ŒÙ‡Ø§</h3></div>`;
                const depArr = Object.entries(deposits);
                if (depArr.length === 0) {
                    html += `<div class="empty-state"><p>Ù‡Ù†ÙˆØ² ÙˆØ§Ø±ÛŒØ²ÛŒ Ø«Ø¨Øª Ù†Ø´Ø¯Ù‡</p></div>`;
                } else {
                    depArr.forEach(([id, d]) => {
                        const m = members[d.memberId];
                        if (!m) return;
                        html += `<div class="list-item">
                            <div class="list-icon" style="background:rgba(16,185,129,0.2)">ğŸ’³</div>
                            <div class="list-content">
                                <div class="list-title">${m.avatar} ${m.name}</div>
                                <div class="list-meta">${d.description}</div>
                            </div>
                            <div class="list-amount" style="color:var(--success)">+${formatNumber(d.amount)}</div>
                            ${state.isAdmin ? `<button class="btn btn-sm btn-outline" onclick="deleteDeposit('${id}')">ğŸ—‘ï¸</button>` : ''}
                        </div>`;
                    });
                }
                html += `</div>`;

                html += `<div class="section"><div class="section-header"><h3 class="section-title">ğŸ›’ Ù‡Ø²ÛŒÙ†Ù‡â€ŒÙ‡Ø§</h3></div>`;
                const expArr = Object.entries(expenses);
                if (expArr.length === 0) {
                    html += `<div class="empty-state"><p>Ù‡Ù†ÙˆØ² Ù‡Ø²ÛŒÙ†Ù‡â€ŒØ§ÛŒ Ø«Ø¨Øª Ù†Ø´Ø¯Ù‡</p></div>`;
                } else {
                    expArr.sort((a, b) => b[1].date - a[1].date).forEach(([id, e]) => {
                        const cat = getCategoryInfo(e.category);
                        const payer = e.paidBy === 'fund' ? 'ğŸ’° ØµÙ†Ø¯ÙˆÙ‚' : (members[e.paidBy]?.avatar + ' ' + members[e.paidBy]?.name || '?');
                        const count = e.splits ? Object.keys(e.splits).length : 0;
                        html += `<div class="list-item">
                            <div class="list-icon" style="background:var(--glass)">${cat.icon}</div>
                            <div class="list-content">
                                <div class="list-title">${e.title}</div>
                                <div class="list-meta">${payer} â€¢ ${count} Ù†ÙØ±</div>
                            </div>
                            <div class="list-amount" style="color:var(--danger)">-${formatNumber(e.amount)}</div>
                            ${state.isAdmin ? `<button class="btn btn-sm btn-outline" onclick="deleteExpense('${id}')">ğŸ—‘ï¸</button>` : ''}
                        </div>`;
                    });
                }
                html += `</div>`;
            }

            else if (state.currentTab === 'members') {
                html = `<div class="section"><div class="section-header"><h3 class="section-title">ğŸ‘¥ Ø§Ø¹Ø¶Ø§</h3></div>`;
                const memArr = Object.entries(members);
                if (memArr.length === 0) {
                    html += `<div class="empty-state"><div class="icon">ğŸ‘¥</div><p>Ù‡Ù†ÙˆØ² Ø¹Ø¶ÙˆÛŒ Ø§Ø¶Ø§ÙÙ‡ Ù†Ø´Ø¯Ù‡</p></div>`;
                } else {
                    memArr.forEach(([id, m]) => {
                        const dep = Object.values(deposits).filter(d => d.memberId === id).reduce((s, d) => s + d.amount, 0);
                        let share = 0;
                        Object.values(expenses).forEach(e => { if (e.splits?.[id]) share += e.splits[id]; });
                        html += `<div class="card">
                            <div class="card-header">
                                <div class="card-avatar">${m.avatar}</div>
                                <div><div class="card-title">${m.name}</div><div class="card-subtitle">ÙˆØ§Ø±ÛŒØ²ÛŒ: ${formatNumber(dep)} ØªÙˆÙ…Ø§Ù†</div></div>
                            </div>
                            <div style="display:flex;justify-content:space-between;font-size:0.85rem;color:var(--gray-light)">
                                <span>Ø³Ù‡Ù… Ù‡Ø²ÛŒÙ†Ù‡:</span><span>${formatNumber(Math.round(share))} ØªÙˆÙ…Ø§Ù†</span>
                            </div>
                            ${state.isAdmin ? `<div class="card-actions admin-only"><button class="btn btn-sm btn-outline" style="flex:1" onclick="deleteMember('${id}')">ğŸ—‘ï¸ Ø­Ø°Ù</button></div>` : ''}
                        </div>`;
                    });
                }
                html += `</div>`;
            }

            else if (state.currentTab === 'settlement') {
                const balances = {};
                Object.entries(members).forEach(([id, m]) => {
                    balances[id] = { member: m, deposited: 0, share: 0, paidExtra: 0 };
                });
                Object.values(deposits).forEach(d => { if (balances[d.memberId]) balances[d.memberId].deposited += d.amount; });
                Object.values(expenses).forEach(e => {
                    if (e.splits) Object.entries(e.splits).forEach(([id, amt]) => { if (balances[id]) balances[id].share += amt; });
                    if (e.paidBy !== 'fund' && balances[e.paidBy]) balances[e.paidBy].paidExtra += e.amount;
                });
                Object.values(balances).forEach(b => b.balance = (b.deposited + b.paidExtra) - b.share);

                html = `<div class="section"><div class="section-header"><h3 class="section-title">ğŸ“Š ØªØ±Ø§Ø²</h3></div>
                    <div style="display:grid;grid-template-columns:repeat(2,1fr);gap:12px">`;
                Object.values(balances).forEach(b => {
                    let cls = 'zero', status = 'ØªØ³ÙˆÛŒÙ‡ âœ…';
                    if (b.balance > 10) { cls = 'positive'; status = 'Ø·Ù„Ø¨Ú©Ø§Ø± ğŸ’š'; }
                    else if (b.balance < -10) { cls = 'negative'; status = 'Ø¨Ø¯Ù‡Ú©Ø§Ø± â¤ï¸'; }
                    html += `<div class="balance-card ${cls}">
                        <div class="balance-avatar">${b.member.avatar}</div>
                        <div class="balance-name">${b.member.name}</div>
                        <div class="balance-amount" style="color:${b.balance > 0 ? 'var(--success)' : b.balance < 0 ? 'var(--danger)' : 'var(--gray)'}">${b.balance >= 0 ? '+' : ''}${formatNumber(Math.round(b.balance))}</div>
                        <div style="font-size:0.8rem;margin-top:4px">${status}</div>
                    </div>`;
                });
                html += `</div></div>`;

                // Settlement transactions
                const creditors = [], debtors = [];
                Object.entries(balances).forEach(([id, b]) => {
                    if (b.balance > 10) creditors.push({ id, ...b.member, amount: b.balance });
                    else if (b.balance < -10) debtors.push({ id, ...b.member, amount: Math.abs(b.balance) });
                });
                creditors.sort((a, b) => b.amount - a.amount);
                debtors.sort((a, b) => b.amount - a.amount);

                const settlements = [];
                while (debtors.length && creditors.length) {
                    const d = debtors[0], c = creditors[0];
                    const amt = Math.min(d.amount, c.amount);
                    settlements.push({ from: d, to: c, amount: Math.round(amt) });
                    d.amount -= amt; c.amount -= amt;
                    if (d.amount < 10) debtors.shift();
                    if (c.amount < 10) creditors.shift();
                }

                window.currentSettlements = settlements;

                html += `<div class="section"><div class="section-header"><h3 class="section-title">ğŸ”„ ØªØ³ÙˆÛŒÙ‡</h3></div>`;
                if (settlements.length === 0) {
                    html += `<div class="empty-state"><div class="icon">âœ…</div><p>Ù‡Ù…Ù‡ ØªØ³ÙˆÛŒÙ‡â€ŒØ§Ù†Ø¯!</p></div>`;
                } else {
                    settlements.forEach(s => {
                        html += `<div class="settlement-card"><div class="settlement-flow">
                            <div class="settlement-person"><div class="avatar">${s.from.avatar}</div><div class="name">${s.from.name}</div></div>
                            <div style="text-align:center"><div>â¡ï¸</div><div class="settlement-amount">${formatNumber(s.amount)}</div></div>
                            <div class="settlement-person"><div class="avatar">${s.to.avatar}</div><div class="name">${s.to.name}</div></div>
                        </div></div>`;
                    });
                }
                html += `</div>`;
            }

            else if (state.currentTab === 'reports') {
                const totalDep = Object.values(deposits).reduce((s, d) => s + d.amount, 0);
                const totalExp = Object.values(expenses).reduce((s, e) => s + e.amount, 0);
                const memCount = Object.keys(members).length;
                const perPerson = memCount ? Math.round(totalExp / memCount) : 0;

                html = `<div class="section">
                    <div class="section-header"><h3 class="section-title">ğŸ“Š Ú¯Ø²Ø§Ø±Ø´</h3>
                        <button class="btn btn-sm btn-success" onclick="openModal('reportShare')">ğŸ“¤</button>
                    </div>
                    <div class="report-summary">
                        <div class="report-item"><div class="value">${formatNumber(totalDep)}</div><div class="label">Ú©Ù„ ÙˆØ§Ø±ÛŒØ²ÛŒ</div></div>
                        <div class="report-item"><div class="value">${formatNumber(totalExp)}</div><div class="label">Ú©Ù„ Ù‡Ø²ÛŒÙ†Ù‡</div></div>
                        <div class="report-item"><div class="value">${formatNumber(perPerson)}</div><div class="label">Ø³Ù‡Ù… Ù‡Ø± Ù†ÙØ±</div></div>
                        <div class="report-item"><div class="value">${Object.keys(expenses).length}</div><div class="label">ØªØ¹Ø¯Ø§Ø¯ Ù‡Ø²ÛŒÙ†Ù‡</div></div>
                    </div>
                </div>`;
            }

            container.innerHTML = html;
        }

        // Share Functions
        function generateShareLink() {
            const url = `${location.origin}${location.pathname}?trip=${state.tripId}`;
            document.getElementById('shareLink').value = url;
        }

        window.copyLink = () => {
            navigator.clipboard.writeText(document.getElementById('shareLink').value);
            showToast('Ú©Ù¾ÛŒ Ø´Ø¯! ğŸ“‹');
        };

        window.shareWhatsApp = () => {
            const url = document.getElementById('shareLink').value;
            const text = `ğŸï¸ *${state.tripData?.name}*\n\nØ¨Ø±Ø§ÛŒ Ù…Ø´Ø§Ù‡Ø¯Ù‡ Ù‡Ø²ÛŒÙ†Ù‡â€ŒÙ‡Ø§:\n${url}\n\nğŸ“± Ø³ÙØ±ÛŒÙ†Ùˆ`;
            window.open(`https://wa.me/?text=${encodeURIComponent(text)}`, '_blank');
        };

        window.shareReport = type => {
            const data = state.tripData;
            const members = data?.members || {};
            const deposits = data?.deposits || {};
            const expenses = data?.expenses || {};
            const totalDep = Object.values(deposits).reduce((s, d) => s + d.amount, 0);
            const totalExp = Object.values(expenses).reduce((s, e) => s + e.amount, 0);

            let text = '';
            if (type === 'summary') {
                text = `ğŸï¸ *${data?.name}*\nğŸ“… ${getJalaliDate()}\n\nğŸ’° ÙˆØ§Ø±ÛŒØ²ÛŒ: ${formatNumber(totalDep)}\nğŸ›’ Ù‡Ø²ÛŒÙ†Ù‡: ${formatNumber(totalExp)}\nğŸ’µ Ù…Ø§Ù†Ø¯Ù‡: ${formatNumber(totalDep - totalExp)}\n\nğŸ“± Ø³ÙØ±ÛŒÙ†Ùˆ - Ù…Ø­Ù…Ø¯ Ø¹Ø¨Ø§Ø³ÛŒ`;
            } else if (type === 'settlement') {
                const s = window.currentSettlements || [];
                text = `âš–ï¸ *ØªØ³ÙˆÛŒÙ‡ ${data?.name}*\n\n`;
                if (s.length === 0) text += 'âœ… Ù‡Ù…Ù‡ ØªØ³ÙˆÛŒÙ‡â€ŒØ§Ù†Ø¯!';
                else s.forEach((t, i) => { text += `${i + 1}. ${t.from.name} â¡ï¸ ${t.to.name}: ${formatNumber(t.amount)} ØªÙˆÙ…Ø§Ù†\n`; });
                text += `\nğŸ“± Ø³ÙØ±ÛŒÙ†Ùˆ - Ù…Ø­Ù…Ø¯ Ø¹Ø¨Ø§Ø³ÛŒ`;
            } else {
                text = `ğŸï¸ *${data?.name}*\nğŸ“… ${getJalaliDate()}\n\nğŸ‘¥ Ø§Ø¹Ø¶Ø§: ${Object.values(members).map(m => m.name).join('ØŒ ')}\n\nğŸ’° ÙˆØ§Ø±ÛŒØ²ÛŒ: ${formatNumber(totalDep)}\nğŸ›’ Ù‡Ø²ÛŒÙ†Ù‡: ${formatNumber(totalExp)}\n\nğŸ“± Ø³ÙØ±ÛŒÙ†Ùˆ - Ù…Ø­Ù…Ø¯ Ø¹Ø¨Ø§Ø³ÛŒ`;
            }
            window.open(`https://wa.me/?text=${encodeURIComponent(text)}`, '_blank');
            closeModal('reportShare');
        };

        // Init
        function init() {
            initUI();

            const urlParams = new URLSearchParams(location.search);
            const tripId = urlParams.get('trip');

            if (tripId) {
                get(ref(db, 'trips/' + tripId)).then(snap => {
                    if (snap.exists()) {
                        state.tripId = tripId;
                        state.tripData = snap.val();
                        state.isAdmin = localStorage.getItem('admin_' + tripId) === 'true';
                        showMainScreen();
                    }
                });
            } else {
                const last = localStorage.getItem('lastTrip');
                if (last) {
                    get(ref(db, 'trips/' + last)).then(snap => {
                        if (snap.exists()) {
                            state.tripId = last;
                            state.tripData = snap.val();
                            state.isAdmin = localStorage.getItem('admin_' + last) === 'true';
                            showMainScreen();
                        }
                    });
                }
            }
        }

        init();
    </script>
</body>
</html>
