<!DOCTYPE html>
<html lang="fa" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <meta name="theme-color" content="#0D9488">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    
    <title>ğŸï¸ Ø³ÙØ±ÛŒÙ†Ùˆ - Ù…Ø¯ÛŒØ±ÛŒØª Ù‡Ø²ÛŒÙ†Ù‡â€ŒÙ‡Ø§ÛŒ Ø³ÙØ±</title>
    
    <!-- PWA Manifest -->
    <link rel="manifest" href="data:application/json,{
        &quot;name&quot;: &quot;Ø³ÙØ±ÛŒÙ†Ùˆ - Ø­Ø³Ø§Ø¨â€ŒÚ©ØªØ§Ø¨ Ø³ÙØ±&quot;,
        &quot;short_name&quot;: &quot;Ø³ÙØ±ÛŒÙ†Ùˆ&quot;,
        &quot;start_url&quot;: &quot;.&quot;,
        &quot;display&quot;: &quot;standalone&quot;,
        &quot;theme_color&quot;: &quot;#0D9488&quot;,
        &quot;background_color&quot;: &quot;#0F172A&quot;
    }">
    
    <!-- Favicon -->
    <link rel="icon" href="data:image/svg+xml,<svg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 100 100'><text y='.9em' font-size='90'>ğŸï¸</text></svg>">
    
    <!-- Vazir Font -->
    <link href="https://cdn.jsdelivr.net/gh/rastikerdar/vazirmatn@v33.003/Vazirmatn-font-face.css" rel="stylesheet">
    
    <!-- Jalali Date -->
    <script src="https://cdn.jsdelivr.net/npm/jalaali-js@1.2.6/dist/jalaali.min.js"></script>
    
    <!-- QR Code -->
    <script src="https://cdn.jsdelivr.net/npm/qrcode@1.5.3/build/qrcode.min.js"></script>
    
    <!-- Chart.js -->
    <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.1/dist/chart.umd.min.js"></script>

    <style>
        :root {
            /* Primary - Teal */
            --primary: #0D9488;
            --primary-light: #14B8A6;
            --primary-dark: #0F766E;
            --primary-bg: #CCFBF1;
            
            /* Secondary - Coral */
            --secondary: #F97316;
            --secondary-light: #FB923C;
            --secondary-dark: #EA580C;
            --secondary-bg: #FFF7ED;
            
            /* Accent - Gold */
            --accent: #EAB308;
            --accent-light: #FACC15;
            --accent-dark: #CA8A04;
            --accent-bg: #FEFCE8;
            
            /* Status */
            --success: #10B981;
            --success-bg: #D1FAE5;
            --danger: #EF4444;
            --danger-bg: #FEE2E2;
            --warning: #F59E0B;
            --warning-bg: #FEF3C7;
            
            /* Neutral */
            --dark: #0F172A;
            --dark-light: #1E293B;
            --gray: #64748B;
            --gray-light: #94A3B8;
            --light: #F1F5F9;
            --white: #FFFFFF;
            
            /* Glass */
            --glass: rgba(255, 255, 255, 0.1);
            --glass-border: rgba(255, 255, 255, 0.2);
            
            /* Shadows */
            --shadow-sm: 0 1px 2px rgba(0, 0, 0, 0.05);
            --shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1);
            --shadow-lg: 0 10px 15px -3px rgba(0, 0, 0, 0.1);
            --shadow-xl: 0 20px 25px -5px rgba(0, 0, 0, 0.1);
            
            /* Radius */
            --radius-sm: 8px;
            --radius: 12px;
            --radius-lg: 16px;
            --radius-xl: 24px;
            --radius-full: 9999px;
            
            /* Transitions */
            --transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
        }

        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Vazirmatn', system-ui, -apple-system, sans-serif;
            background: linear-gradient(135deg, var(--dark) 0%, var(--dark-light) 100%);
            min-height: 100vh;
            color: var(--white);
            line-height: 1.6;
            overflow-x: hidden;
        }

        /* Animated Background */
        .bg-pattern {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            pointer-events: none;
            z-index: 0;
            opacity: 0.03;
            background-image: url("data:image/svg+xml,%3Csvg width='60' height='60' viewBox='0 0 60 60' xmlns='http://www.w3.org/2000/svg'%3E%3Cg fill='none' fill-rule='evenodd'%3E%3Cg fill='%23ffffff' fill-opacity='1'%3E%3Cpath d='M36 34v-4h-2v4h-4v2h4v4h2v-4h4v-2h-4zm0-30V0h-2v4h-4v2h4v4h2V6h4V4h-4zM6 34v-4H4v4H0v2h4v4h2v-4h4v-2H6zM6 4V0H4v4H0v2h4v4h2V6h4V4H6z'/%3E%3C/g%3E%3C/g%3E%3C/svg%3E");
        }

        /* Container */
        .container {
            max-width: 480px;
            margin: 0 auto;
            padding: 0 16px;
            position: relative;
            z-index: 1;
        }

        /* Screens */
        .screen {
            display: none;
            min-height: 100vh;
            padding-bottom: 100px;
            animation: fadeIn 0.4s ease;
        }

        .screen.active {
            display: block;
        }

        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(20px); }
            to { opacity: 1; transform: translateY(0); }
        }

        /* Header */
        .header {
            padding: 24px 0 16px;
            text-align: center;
        }

        .header-title {
            font-size: 1.75rem;
            font-weight: 800;
            background: linear-gradient(135deg, var(--primary-light), var(--accent));
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
            margin-bottom: 4px;
        }

        .header-subtitle {
            color: var(--gray-light);
            font-size: 0.9rem;
        }

        /* Trip Header */
        .trip-header {
            background: linear-gradient(135deg, var(--primary) 0%, var(--primary-dark) 100%);
            border-radius: var(--radius-xl);
            padding: 24px;
            margin-bottom: 20px;
            position: relative;
            overflow: hidden;
        }

        .trip-header::before {
            content: 'ğŸï¸';
            position: absolute;
            top: -20px;
            left: -20px;
            font-size: 120px;
            opacity: 0.1;
        }

        .trip-name {
            font-size: 1.5rem;
            font-weight: 700;
            margin-bottom: 8px;
        }

        .trip-info {
            display: flex;
            gap: 16px;
            font-size: 0.85rem;
            opacity: 0.9;
        }

        .trip-info span {
            display: flex;
            align-items: center;
            gap: 4px;
        }

        /* Stats Grid */
        .stats-grid {
            display: grid;
            grid-template-columns: repeat(2, 1fr);
            gap: 12px;
            margin-bottom: 20px;
        }

        .stat-card {
            background: var(--glass);
            backdrop-filter: blur(10px);
            border: 1px solid var(--glass-border);
            border-radius: var(--radius-lg);
            padding: 16px;
            text-align: center;
            transition: var(--transition);
        }

        .stat-card:hover {
            transform: translateY(-2px);
            border-color: var(--primary);
        }

        .stat-icon {
            font-size: 1.5rem;
            margin-bottom: 8px;
        }

        .stat-value {
            font-size: 1.25rem;
            font-weight: 700;
            color: var(--white);
            margin-bottom: 2px;
        }

        .stat-label {
            font-size: 0.75rem;
            color: var(--gray-light);
        }

        .stat-card.success .stat-value { color: var(--success); }
        .stat-card.danger .stat-value { color: var(--danger); }
        .stat-card.warning .stat-value { color: var(--accent); }

        /* Section */
        .section {
            background: var(--glass);
            backdrop-filter: blur(10px);
            border: 1px solid var(--glass-border);
            border-radius: var(--radius-xl);
            padding: 20px;
            margin-bottom: 16px;
        }

        .section-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 16px;
        }

        .section-title {
            font-size: 1.1rem;
            font-weight: 600;
            display: flex;
            align-items: center;
            gap: 8px;
        }

        /* Buttons */
        .btn {
            display: inline-flex;
            align-items: center;
            justify-content: center;
            gap: 8px;
            padding: 12px 24px;
            border-radius: var(--radius-full);
            font-size: 0.95rem;
            font-weight: 600;
            font-family: inherit;
            border: none;
            cursor: pointer;
            transition: var(--transition);
            text-decoration: none;
        }

        .btn-primary {
            background: linear-gradient(135deg, var(--primary) 0%, var(--primary-dark) 100%);
            color: var(--white);
            box-shadow: 0 4px 15px rgba(13, 148, 136, 0.4);
        }

        .btn-primary:hover {
            transform: translateY(-2px);
            box-shadow: 0 6px 20px rgba(13, 148, 136, 0.5);
        }

        .btn-secondary {
            background: linear-gradient(135deg, var(--secondary) 0%, var(--secondary-dark) 100%);
            color: var(--white);
            box-shadow: 0 4px 15px rgba(249, 115, 22, 0.4);
        }

        .btn-success {
            background: linear-gradient(135deg, var(--success) 0%, #059669 100%);
            color: var(--white);
        }

        .btn-outline {
            background: transparent;
            border: 2px solid var(--glass-border);
            color: var(--white);
        }

        .btn-outline:hover {
            background: var(--glass);
            border-color: var(--primary);
        }

        .btn-sm {
            padding: 8px 16px;
            font-size: 0.85rem;
        }

        .btn-icon {
            width: 40px;
            height: 40px;
            padding: 0;
            border-radius: var(--radius);
        }

        .btn-fab {
            position: fixed;
            bottom: 90px;
            left: 50%;
            transform: translateX(-50%);
            width: 56px;
            height: 56px;
            border-radius: 50%;
            font-size: 1.5rem;
            padding: 0;
            z-index: 100;
            box-shadow: 0 4px 20px rgba(13, 148, 136, 0.5);
        }

        /* Bottom Navigation */
        .bottom-nav {
            position: fixed;
            bottom: 0;
            left: 0;
            right: 0;
            background: var(--dark-light);
            backdrop-filter: blur(20px);
            border-top: 1px solid var(--glass-border);
            display: flex;
            justify-content: space-around;
            padding: 8px 0;
            padding-bottom: max(8px, env(safe-area-inset-bottom));
            z-index: 1000;
        }

        .nav-item {
            display: flex;
            flex-direction: column;
            align-items: center;
            gap: 4px;
            padding: 8px 16px;
            color: var(--gray);
            text-decoration: none;
            font-size: 0.7rem;
            transition: var(--transition);
            cursor: pointer;
            border: none;
            background: none;
            font-family: inherit;
        }

        .nav-item.active {
            color: var(--primary-light);
        }

        .nav-item .icon {
            font-size: 1.4rem;
        }

        /* Forms */
        .form-group {
            margin-bottom: 16px;
        }

        .form-label {
            display: block;
            margin-bottom: 8px;
            font-size: 0.9rem;
            font-weight: 500;
            color: var(--gray-light);
        }

        .form-input {
            width: 100%;
            padding: 14px 16px;
            background: var(--dark);
            border: 2px solid var(--glass-border);
            border-radius: var(--radius);
            color: var(--white);
            font-size: 1rem;
            font-family: inherit;
            transition: var(--transition);
        }

        .form-input:focus {
            outline: none;
            border-color: var(--primary);
            box-shadow: 0 0 0 3px rgba(13, 148, 136, 0.2);
        }

        .form-input::placeholder {
            color: var(--gray);
        }

        /* Select */
        .form-select {
            appearance: none;
            background-image: url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' fill='none' viewBox='0 0 24 24' stroke='%2394A3B8'%3E%3Cpath stroke-linecap='round' stroke-linejoin='round' stroke-width='2' d='M19 9l-7 7-7-7'%3E%3C/path%3E%3C/svg%3E");
            background-repeat: no-repeat;
            background-position: left 12px center;
            background-size: 20px;
            padding-left: 40px;
        }

        /* Checkbox Group */
        .checkbox-group {
            display: flex;
            flex-wrap: wrap;
            gap: 8px;
        }

        .checkbox-item {
            display: flex;
            align-items: center;
            gap: 8px;
            padding: 10px 14px;
            background: var(--dark);
            border: 2px solid var(--glass-border);
            border-radius: var(--radius-full);
            cursor: pointer;
            transition: var(--transition);
            font-size: 0.9rem;
        }

        .checkbox-item:has(input:checked) {
            background: var(--primary);
            border-color: var(--primary);
        }

        .checkbox-item input {
            display: none;
        }

        /* Avatar Picker */
        .avatar-grid {
            display: grid;
            grid-template-columns: repeat(6, 1fr);
            gap: 8px;
        }

        .avatar-option {
            aspect-ratio: 1;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 1.8rem;
            background: var(--dark);
            border: 2px solid var(--glass-border);
            border-radius: var(--radius);
            cursor: pointer;
            transition: var(--transition);
        }

        .avatar-option:hover {
            border-color: var(--primary);
        }

        .avatar-option.selected {
            background: var(--primary);
            border-color: var(--primary);
        }

        /* Cards */
        .card {
            background: var(--dark);
            border: 1px solid var(--glass-border);
            border-radius: var(--radius-lg);
            padding: 16px;
            margin-bottom: 12px;
            transition: var(--transition);
        }

        .card:hover {
            border-color: var(--primary);
        }

        .card-header {
            display: flex;
            align-items: center;
            gap: 12px;
            margin-bottom: 12px;
        }

        .card-avatar {
            width: 48px;
            height: 48px;
            background: var(--primary-bg);
            border-radius: var(--radius);
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 1.5rem;
        }

        .card-title {
            font-weight: 600;
            margin-bottom: 2px;
        }

        .card-subtitle {
            font-size: 0.8rem;
            color: var(--gray-light);
        }

        .card-amount {
            font-size: 1.25rem;
            font-weight: 700;
        }

        .card-amount.positive { color: var(--success); }
        .card-amount.negative { color: var(--danger); }

        .card-actions {
            display: flex;
            gap: 8px;
            margin-top: 12px;
            padding-top: 12px;
            border-top: 1px solid var(--glass-border);
        }

        /* List */
        .list-item {
            display: flex;
            align-items: center;
            gap: 12px;
            padding: 14px;
            background: var(--dark);
            border-radius: var(--radius);
            margin-bottom: 8px;
            transition: var(--transition);
        }

        .list-item:hover {
            background: var(--dark-light);
        }

        .list-icon {
            width: 44px;
            height: 44px;
            border-radius: var(--radius);
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 1.3rem;
        }

        .list-icon.food { background: #FEE2E2; }
        .list-icon.transport { background: #DBEAFE; }
        .list-icon.stay { background: #E0E7FF; }
        .list-icon.fun { background: #FCE7F3; }
        .list-icon.shopping { background: #FEF3C7; }
        .list-icon.other { background: #E2E8F0; }

        .list-content {
            flex: 1;
            min-width: 0;
        }

        .list-title {
            font-weight: 500;
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
        }

        .list-meta {
            font-size: 0.8rem;
            color: var(--gray-light);
        }

        .list-amount {
            font-weight: 700;
            text-align: left;
        }

        /* Tabs */
        .tabs {
            display: flex;
            gap: 8px;
            margin-bottom: 16px;
            overflow-x: auto;
            padding-bottom: 4px;
        }

        .tabs::-webkit-scrollbar {
            display: none;
        }

        .tab {
            padding: 10px 20px;
            background: var(--dark);
            border: 2px solid var(--glass-border);
            border-radius: var(--radius-full);
            color: var(--gray-light);
            font-size: 0.9rem;
            font-weight: 500;
            white-space: nowrap;
            cursor: pointer;
            transition: var(--transition);
            font-family: inherit;
        }

        .tab.active {
            background: var(--primary);
            border-color: var(--primary);
            color: var(--white);
        }

        /* Modal */
        .modal {
            display: none;
            position: fixed;
            inset: 0;
            background: rgba(0, 0, 0, 0.8);
            backdrop-filter: blur(4px);
            z-index: 2000;
            align-items: flex-end;
            justify-content: center;
        }

        .modal.active {
            display: flex;
        }

        .modal-content {
            background: var(--dark-light);
            border-radius: var(--radius-xl) var(--radius-xl) 0 0;
            width: 100%;
            max-width: 480px;
            max-height: 90vh;
            overflow-y: auto;
            animation: slideUp 0.3s ease;
        }

        @keyframes slideUp {
            from { transform: translateY(100%); }
            to { transform: translateY(0); }
        }

        .modal-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 20px;
            border-bottom: 1px solid var(--glass-border);
            position: sticky;
            top: 0;
            background: var(--dark-light);
            z-index: 10;
        }

        .modal-title {
            font-size: 1.2rem;
            font-weight: 600;
        }

        .modal-close {
            width: 36px;
            height: 36px;
            display: flex;
            align-items: center;
            justify-content: center;
            background: var(--dark);
            border: none;
            border-radius: 50%;
            color: var(--gray-light);
            font-size: 1.25rem;
            cursor: pointer;
            transition: var(--transition);
        }

        .modal-close:hover {
            background: var(--danger);
            color: var(--white);
        }

        .modal-body {
            padding: 20px;
        }

        .modal-footer {
            padding: 20px;
            border-top: 1px solid var(--glass-border);
        }

        /* Split Type Toggle */
        .split-type-toggle {
            display: flex;
            background: var(--dark);
            border-radius: var(--radius-full);
            padding: 4px;
            margin-bottom: 16px;
        }

        .split-type-btn {
            flex: 1;
            padding: 10px;
            background: none;
            border: none;
            border-radius: var(--radius-full);
            color: var(--gray-light);
            font-family: inherit;
            font-size: 0.9rem;
            cursor: pointer;
            transition: var(--transition);
        }

        .split-type-btn.active {
            background: var(--primary);
            color: var(--white);
        }

        /* Custom Split */
        .custom-split-item {
            display: flex;
            align-items: center;
            gap: 12px;
            padding: 12px;
            background: var(--dark);
            border-radius: var(--radius);
            margin-bottom: 8px;
        }

        .custom-split-item .avatar {
            font-size: 1.5rem;
        }

        .custom-split-item .name {
            flex: 1;
        }

        .custom-split-item input {
            width: 100px;
            padding: 8px 12px;
            background: var(--dark-light);
            border: 1px solid var(--glass-border);
            border-radius: var(--radius);
            color: var(--white);
            font-family: inherit;
            text-align: center;
        }

        /* Settlement Card */
        .settlement-card {
            background: linear-gradient(135deg, var(--success) 0%, #059669 100%);
            border-radius: var(--radius-lg);
            padding: 20px;
            margin-bottom: 12px;
        }

        .settlement-flow {
            display: flex;
            align-items: center;
            justify-content: space-between;
            gap: 12px;
        }

        .settlement-person {
            text-align: center;
        }

        .settlement-person .avatar {
            font-size: 2rem;
            margin-bottom: 4px;
        }

        .settlement-person .name {
            font-size: 0.85rem;
        }

        .settlement-arrow {
            display: flex;
            flex-direction: column;
            align-items: center;
            gap: 4px;
        }

        .settlement-amount {
            background: var(--white);
            color: var(--success);
            padding: 6px 16px;
            border-radius: var(--radius-full);
            font-weight: 700;
        }

        /* Balance Card */
        .balance-card {
            border-radius: var(--radius-lg);
            padding: 16px;
            text-align: center;
        }

        .balance-card.positive {
            background: linear-gradient(135deg, rgba(16, 185, 129, 0.2), rgba(16, 185, 129, 0.1));
            border: 2px solid var(--success);
        }

        .balance-card.negative {
            background: linear-gradient(135deg, rgba(239, 68, 68, 0.2), rgba(239, 68, 68, 0.1));
            border: 2px solid var(--danger);
        }

        .balance-card.zero {
            background: var(--dark);
            border: 2px solid var(--gray);
        }

        .balance-avatar {
            font-size: 2.5rem;
            margin-bottom: 8px;
        }

        .balance-name {
            font-weight: 600;
            margin-bottom: 4px;
        }

        .balance-amount {
            font-size: 1.1rem;
            font-weight: 700;
        }

        .balance-status {
            font-size: 0.8rem;
            margin-top: 4px;
        }

        /* Empty State */
        .empty-state {
            text-align: center;
            padding: 40px 20px;
            color: var(--gray);
        }

        .empty-state .icon {
            font-size: 4rem;
            margin-bottom: 16px;
            opacity: 0.5;
        }

        .empty-state p {
            margin-bottom: 20px;
        }

        /* Toast */
        .toast {
            position: fixed;
            bottom: 100px;
            left: 50%;
            transform: translateX(-50%) translateY(100px);
            background: var(--dark-light);
            border: 1px solid var(--glass-border);
            padding: 14px 24px;
            border-radius: var(--radius-full);
            font-size: 0.9rem;
            z-index: 3000;
            opacity: 0;
            transition: var(--transition);
            box-shadow: var(--shadow-lg);
        }

        .toast.show {
            transform: translateX(-50%) translateY(0);
            opacity: 1;
        }

        .toast.success {
            border-color: var(--success);
        }

        .toast.error {
            border-color: var(--danger);
        }

        /* Category Icons */
        .category-grid {
            display: grid;
            grid-template-columns: repeat(3, 1fr);
            gap: 8px;
        }

        .category-option {
            display: flex;
            flex-direction: column;
            align-items: center;
            gap: 6px;
            padding: 14px 8px;
            background: var(--dark);
            border: 2px solid var(--glass-border);
            border-radius: var(--radius);
            cursor: pointer;
            transition: var(--transition);
        }

        .category-option:hover {
            border-color: var(--primary);
        }

        .category-option.selected {
            background: var(--primary);
            border-color: var(--primary);
        }

        .category-option .icon {
            font-size: 1.5rem;
        }

        .category-option .label {
            font-size: 0.75rem;
        }

        /* Intro Screen */
        .intro-container {
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            min-height: 100vh;
            padding: 40px 20px;
            text-align: center;
        }

        .intro-logo {
            font-size: 5rem;
            margin-bottom: 20px;
            animation: float 3s ease-in-out infinite;
        }

        @keyframes float {
            0%, 100% { transform: translateY(0); }
            50% { transform: translateY(-10px); }
        }

        .intro-title {
            font-size: 2rem;
            font-weight: 800;
            background: linear-gradient(135deg, var(--primary-light), var(--accent));
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
            margin-bottom: 8px;
        }

        .intro-subtitle {
            color: var(--gray-light);
            margin-bottom: 40px;
        }

        .intro-buttons {
            display: flex;
            flex-direction: column;
            gap: 12px;
            width: 100%;
            max-width: 300px;
        }

        /* Admin Login */
        .admin-badge {
            display: inline-flex;
            align-items: center;
            gap: 6px;
            padding: 6px 12px;
            background: var(--accent-bg);
            color: var(--accent-dark);
            border-radius: var(--radius-full);
            font-size: 0.8rem;
            font-weight: 600;
            margin-bottom: 16px;
        }

        /* Share */
        .share-box {
            background: var(--dark);
            border-radius: var(--radius);
            padding: 16px;
            margin-bottom: 16px;
        }

        .share-link {
            display: flex;
            gap: 8px;
            margin-bottom: 12px;
        }

        .share-link input {
            flex: 1;
            padding: 12px;
            background: var(--dark-light);
            border: 1px solid var(--glass-border);
            border-radius: var(--radius);
            color: var(--white);
            font-family: inherit;
            font-size: 0.85rem;
        }

        .share-buttons {
            display: flex;
            gap: 8px;
        }

        .share-buttons .btn {
            flex: 1;
        }

        /* QR Code */
        .qr-container {
            background: var(--white);
            border-radius: var(--radius);
            padding: 20px;
            display: flex;
            justify-content: center;
            margin-bottom: 16px;
        }

        /* Chart Container */
        .chart-container {
            background: var(--dark);
            border-radius: var(--radius);
            padding: 16px;
            margin-bottom: 16px;
            height: 250px;
        }

        /* Report */
        .report-summary {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 12px;
            margin-bottom: 20px;
        }

        .report-item {
            background: var(--dark);
            padding: 16px;
            border-radius: var(--radius);
            text-align: center;
        }

        .report-item .value {
            font-size: 1.3rem;
            font-weight: 700;
            color: var(--primary-light);
        }

        .report-item .label {
            font-size: 0.8rem;
            color: var(--gray-light);
            margin-top: 4px;
        }

        /* Footer Credit */
        .footer-credit {
            text-align: center;
            padding: 20px;
            color: var(--gray);
            font-size: 0.8rem;
        }

        .footer-credit a {
            color: var(--primary-light);
            text-decoration: none;
        }

        /* Loading */
        .loading {
            display: flex;
            align-items: center;
            justify-content: center;
            padding: 40px;
        }

        .spinner {
            width: 40px;
            height: 40px;
            border: 3px solid var(--glass-border);
            border-top-color: var(--primary);
            border-radius: 50%;
            animation: spin 1s linear infinite;
        }

        @keyframes spin {
            to { transform: rotate(360deg); }
        }

        /* Connection Status */
        .connection-status {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            padding: 8px;
            text-align: center;
            font-size: 0.8rem;
            z-index: 3000;
            transform: translateY(-100%);
            transition: var(--transition);
        }

        .connection-status.offline {
            background: var(--danger);
            color: var(--white);
            transform: translateY(0);
        }

        .connection-status.online {
            background: var(--success);
            color: var(--white);
            transform: translateY(0);
            animation: hideAfter 2s forwards;
        }

        @keyframes hideAfter {
            0%, 80% { transform: translateY(0); }
            100% { transform: translateY(-100%); }
        }

        /* Scrollbar */
        ::-webkit-scrollbar {
            width: 6px;
        }

        ::-webkit-scrollbar-track {
            background: var(--dark);
        }

        ::-webkit-scrollbar-thumb {
            background: var(--gray);
            border-radius: 3px;
        }

        /* Admin Actions */
        .admin-actions {
            display: none;
        }

        .is-admin .admin-actions {
            display: flex;
        }

        /* Responsive */
        @media (min-width: 768px) {
            .modal-content {
                border-radius: var(--radius-xl);
                margin: 20px;
                max-height: calc(100vh - 40px);
            }

            .modal {
                align-items: center;
            }
        }
    </style>
</head>
<body>
    <div class="bg-pattern"></div>
    
    <!-- Connection Status -->
    <div class="connection-status" id="connectionStatus"></div>
    
    <!-- Toast -->
    <div class="toast" id="toast"></div>

    <!-- ============================================ -->
    <!-- INTRO SCREEN -->
    <!-- ============================================ -->
    <div class="screen active" id="introScreen">
        <div class="container">
            <div class="intro-container">
                <div class="intro-logo">ğŸï¸</div>
                <h1 class="intro-title">Ø³ÙØ±ÛŒÙ†Ùˆ</h1>
                <p class="intro-subtitle">Ù…Ø¯ÛŒØ±ÛŒØª Ù‡Ø²ÛŒÙ†Ù‡â€ŒÙ‡Ø§ÛŒ Ú¯Ø±ÙˆÙ‡ÛŒ Ø³ÙØ±</p>
                
                <div class="intro-buttons">
                    <button class="btn btn-primary" onclick="openModal('createTrip')">
                        âœ¨ Ø§ÛŒØ¬Ø§Ø¯ Ø³ÙØ± Ø¬Ø¯ÛŒØ¯
                    </button>
                    <button class="btn btn-outline" onclick="openModal('joinTrip')">
                        ğŸ”— ÙˆØ±ÙˆØ¯ Ø¨Ø§ Ù„ÛŒÙ†Ú©
                    </button>
                </div>

                <div class="footer-credit" style="margin-top: 60px;">
                    <p>Ø·Ø±Ø§Ø­ÛŒ Ùˆ Ø¨Ø±Ù†Ø§Ù…Ù‡â€ŒÙ†ÙˆÛŒØ³ÛŒ</p>
                    <p><strong>Ù…Ø­Ù…Ø¯ Ø¹Ø¨Ø§Ø³ÛŒ</strong> | Mohamad Abbasi</p>
                </div>
            </div>
        </div>
    </div>

    <!-- ============================================ -->
    <!-- MAIN APP SCREEN -->
    <!-- ============================================ -->
    <div class="screen" id="mainScreen">
        <div class="container">
            <!-- Header -->
            <div class="header">
                <h1 class="header-title">Ø³ÙØ±ÛŒÙ†Ùˆ</h1>
                <p class="header-subtitle" id="tripSubtitle">Ù…Ø¯ÛŒØ±ÛŒØª Ù‡Ø²ÛŒÙ†Ù‡â€ŒÙ‡Ø§ÛŒ Ø³ÙØ±</p>
            </div>

            <!-- Trip Header -->
            <div class="trip-header">
                <h2 class="trip-name" id="tripName">Ø³ÙØ± Ù‚Ø´Ù…</h2>
                <div class="trip-info">
                    <span>ğŸ‘¥ <span id="memberCountHeader">0</span> Ù†ÙØ±</span>
                    <span>ğŸ“… <span id="tripDate"></span></span>
                </div>
                <div style="margin-top: 12px; display: flex; gap: 8px;">
                    <button class="btn btn-sm btn-outline" onclick="openModal('share')" style="flex: 1;">
                        ğŸ“¤ Ø§Ø´ØªØ±Ø§Ú©â€ŒÚ¯Ø°Ø§Ø±ÛŒ
                    </button>
                    <button class="btn btn-sm btn-outline admin-actions" onclick="openModal('adminLogin')" id="adminBtn">
                        ğŸ”
                    </button>
                </div>
            </div>

            <!-- Stats Grid -->
            <div class="stats-grid">
                <div class="stat-card success">
                    <div class="stat-icon">ğŸ’°</div>
                    <div class="stat-value" id="totalDeposits">Û°</div>
                    <div class="stat-label">Ú©Ù„ ÙˆØ§Ø±ÛŒØ²ÛŒ</div>
                </div>
                <div class="stat-card danger">
                    <div class="stat-icon">ğŸ›’</div>
                    <div class="stat-value" id="totalExpenses">Û°</div>
                    <div class="stat-label">Ú©Ù„ Ù‡Ø²ÛŒÙ†Ù‡</div>
                </div>
                <div class="stat-card warning">
                    <div class="stat-icon">ğŸ’µ</div>
                    <div class="stat-value" id="fundBalance">Û°</div>
                    <div class="stat-label">Ù…Ø§Ù†Ø¯Ù‡ ØµÙ†Ø¯ÙˆÙ‚</div>
                </div>
                <div class="stat-card">
                    <div class="stat-icon">ğŸ‘¥</div>
                    <div class="stat-value" id="memberCount">Û°</div>
                    <div class="stat-label">ØªØ¹Ø¯Ø§Ø¯ Ø§Ø¹Ø¶Ø§</div>
                </div>
            </div>

            <!-- Tab Content Container -->
            <div id="tabContent">
                <!-- Content will be loaded here -->
            </div>

            <!-- Footer Credit -->
            <div class="footer-credit">
                <p>Ø·Ø±Ø§Ø­ÛŒ Ùˆ Ø¨Ø±Ù†Ø§Ù…Ù‡â€ŒÙ†ÙˆÛŒØ³ÛŒ: <a href="#">Ù…Ø­Ù…Ø¯ Ø¹Ø¨Ø§Ø³ÛŒ</a> | Mohamad Abbasi</p>
            </div>
        </div>

        <!-- FAB Button (Admin Only) -->
        <button class="btn btn-primary btn-fab admin-actions" id="fabBtn" onclick="showFabMenu()">
            â•
        </button>

        <!-- Bottom Navigation -->
        <nav class="bottom-nav">
            <button class="nav-item active" data-tab="expenses" onclick="switchTab('expenses')">
                <span class="icon">ğŸ›’</span>
                <span>Ù‡Ø²ÛŒÙ†Ù‡â€ŒÙ‡Ø§</span>
            </button>
            <button class="nav-item" data-tab="members" onclick="switchTab('members')">
                <span class="icon">ğŸ‘¥</span>
                <span>Ø§Ø¹Ø¶Ø§</span>
            </button>
            <button class="nav-item" data-tab="settlement" onclick="switchTab('settlement')">
                <span class="icon">âš–ï¸</span>
                <span>ØªØ³ÙˆÛŒÙ‡</span>
            </button>
            <button class="nav-item" data-tab="reports" onclick="switchTab('reports')">
                <span class="icon">ğŸ“Š</span>
                <span>Ú¯Ø²Ø§Ø±Ø´</span>
            </button>
        </nav>
    </div>

    <!-- ============================================ -->
    <!-- MODALS -->
    <!-- ============================================ -->

    <!-- Create Trip Modal -->
    <div class="modal" id="createTrip-modal">
        <div class="modal-content">
            <div class="modal-header">
                <h3 class="modal-title">âœ¨ Ø§ÛŒØ¬Ø§Ø¯ Ø³ÙØ± Ø¬Ø¯ÛŒØ¯</h3>
                <button class="modal-close" onclick="closeModal('createTrip')">Ã—</button>
            </div>
            <div class="modal-body">
                <form id="createTripForm" onsubmit="createTrip(event)">
                    <div class="form-group">
                        <label class="form-label">Ù†Ø§Ù… Ø³ÙØ±</label>
                        <input type="text" class="form-input" id="newTripName" required placeholder="Ù…Ø«Ø§Ù„: Ø³ÙØ± Ù‚Ø´Ù…">
                    </div>
                    <div class="form-group">
                        <label class="form-label">Ø±Ù…Ø² Ø¹Ø¨ÙˆØ± Ù…Ø¯ÛŒØ± (Û´ ØªØ§ Û¶ Ø±Ù‚Ù…)</label>
                        <input type="password" class="form-input" id="newTripPassword" required 
                               pattern="[0-9]{4,6}" inputmode="numeric" placeholder="Ù…Ø«Ø§Ù„: Û±Û²Û³Û´">
                        <small style="color: var(--gray-light); font-size: 0.8rem;">
                            Ø§ÛŒÙ† Ø±Ù…Ø² Ø¨Ø±Ø§ÛŒ ÙˆÛŒØ±Ø§ÛŒØ´ Ùˆ Ø­Ø°Ù Ù‡Ø²ÛŒÙ†Ù‡â€ŒÙ‡Ø§ Ù†ÛŒØ§Ø² Ø§Ø³Øª
                        </small>
                    </div>
                    <button type="submit" class="btn btn-primary" style="width: 100%;">
                        ğŸš€ Ø§ÛŒØ¬Ø§Ø¯ Ø³ÙØ±
                    </button>
                </form>
            </div>
        </div>
    </div>

    <!-- Join Trip Modal -->
    <div class="modal" id="joinTrip-modal">
        <div class="modal-content">
            <div class="modal-header">
                <h3 class="modal-title">ğŸ”— ÙˆØ±ÙˆØ¯ Ø¨Ø§ Ù„ÛŒÙ†Ú©</h3>
                <button class="modal-close" onclick="closeModal('joinTrip')">Ã—</button>
            </div>
            <div class="modal-body">
                <form onsubmit="joinTripByCode(event)">
                    <div class="form-group">
                        <label class="form-label">Ú©Ø¯ Ø³ÙØ± ÛŒØ§ Ù„ÛŒÙ†Ú©</label>
                        <input type="text" class="form-input" id="tripCodeInput" required 
                               placeholder="Ú©Ø¯ ÛŒØ§ Ù„ÛŒÙ†Ú© Ø³ÙØ± Ø±Ø§ ÙˆØ§Ø±Ø¯ Ú©Ù†ÛŒØ¯">
                    </div>
                    <button type="submit" class="btn btn-primary" style="width: 100%;">
                        ÙˆØ±ÙˆØ¯ Ø¨Ù‡ Ø³ÙØ±
                    </button>
                </form>
            </div>
        </div>
    </div>

    <!-- Admin Login Modal -->
    <div class="modal" id="adminLogin-modal">
        <div class="modal-content">
            <div class="modal-header">
                <h3 class="modal-title">ğŸ” ÙˆØ±ÙˆØ¯ Ù…Ø¯ÛŒØ±</h3>
                <button class="modal-close" onclick="closeModal('adminLogin')">Ã—</button>
            </div>
            <div class="modal-body">
                <form onsubmit="adminLogin(event)">
                    <div class="form-group">
                        <label class="form-label">Ø±Ù…Ø² Ø¹Ø¨ÙˆØ± Ù…Ø¯ÛŒØ±</label>
                        <input type="password" class="form-input" id="adminPasswordInput" required 
                               inputmode="numeric" placeholder="Ø±Ù…Ø² Û´ ØªØ§ Û¶ Ø±Ù‚Ù…ÛŒ">
                    </div>
                    <button type="submit" class="btn btn-primary" style="width: 100%;">
                        ÙˆØ±ÙˆØ¯
                    </button>
                </form>
            </div>
        </div>
    </div>

    <!-- Add Member Modal -->
    <div class="modal" id="addMember-modal">
        <div class="modal-content">
            <div class="modal-header">
                <h3 class="modal-title">ğŸ‘¤ Ø§ÙØ²ÙˆØ¯Ù† Ø¹Ø¶Ùˆ</h3>
                <button class="modal-close" onclick="closeModal('addMember')">Ã—</button>
            </div>
            <div class="modal-body">
                <form onsubmit="addMember(event)">
                    <div class="form-group">
                        <label class="form-label">Ù†Ø§Ù…</label>
                        <input type="text" class="form-input" id="memberName" required placeholder="Ù†Ø§Ù… Ø´Ø®Øµ">
                    </div>
                    <div class="form-group">
                        <label class="form-label">Ø¢ÙˆØ§ØªØ§Ø±</label>
                        <div class="avatar-grid" id="avatarGrid">
                            <div class="avatar-option selected" data-avatar="ğŸ‘¨">ğŸ‘¨</div>
                            <div class="avatar-option" data-avatar="ğŸ‘©">ğŸ‘©</div>
                            <div class="avatar-option" data-avatar="ğŸ‘¦">ğŸ‘¦</div>
                            <div class="avatar-option" data-avatar="ğŸ‘§">ğŸ‘§</div>
                            <div class="avatar-option" data-avatar="ğŸ§”">ğŸ§”</div>
                            <div class="avatar-option" data-avatar="ğŸ‘´">ğŸ‘´</div>
                            <div class="avatar-option" data-avatar="ğŸ‘µ">ğŸ‘µ</div>
                            <div class="avatar-option" data-avatar="ğŸ§‘">ğŸ§‘</div>
                            <div class="avatar-option" data-avatar="ğŸ‘±">ğŸ‘±</div>
                            <div class="avatar-option" data-avatar="ğŸ‘²">ğŸ‘²</div>
                            <div class="avatar-option" data-avatar="ğŸ§•">ğŸ§•</div>
                            <div class="avatar-option" data-avatar="ğŸ¤µ">ğŸ¤µ</div>
                        </div>
                    </div>
                    <button type="submit" class="btn btn-primary" style="width: 100%;">
                        âœ… Ø§ÙØ²ÙˆØ¯Ù†
                    </button>
                </form>
            </div>
        </div>
    </div>

    <!-- Add Deposit Modal -->
    <div class="modal" id="addDeposit-modal">
        <div class="modal-content">
            <div class="modal-header">
                <h3 class="modal-title">ğŸ’³ Ø«Ø¨Øª ÙˆØ§Ø±ÛŒØ²ÛŒ</h3>
                <button class="modal-close" onclick="closeModal('addDeposit')">Ã—</button>
            </div>
            <div class="modal-body">
                <form onsubmit="addDeposit(event)">
                    <div class="form-group">
                        <label class="form-label">ÙˆØ§Ø±ÛŒØ²Ú©Ù†Ù†Ø¯Ù‡</label>
                        <select class="form-input form-select" id="depositMember" required>
                            <option value="">Ø§Ù†ØªØ®Ø§Ø¨ Ú©Ù†ÛŒØ¯...</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <label class="form-label">Ù…Ø¨Ù„Øº (ØªÙˆÙ…Ø§Ù†)</label>
                        <input type="number" class="form-input" id="depositAmount" required 
                               inputmode="numeric" placeholder="Ù…Ø«Ø§Ù„: Û±Û°Û°Û°Û°Û°Û°">
                    </div>
                    <div class="form-group">
                        <label class="form-label">ØªÙˆØ¶ÛŒØ­Ø§Øª (Ø§Ø®ØªÛŒØ§Ø±ÛŒ)</label>
                        <input type="text" class="form-input" id="depositDesc" placeholder="ØªÙˆØ¶ÛŒØ­Ø§Øª">
                    </div>
                    <button type="submit" class="btn btn-success" style="width: 100%;">
                        âœ… Ø«Ø¨Øª ÙˆØ§Ø±ÛŒØ²ÛŒ
                    </button>
                </form>
            </div>
        </div>
    </div>

    <!-- Add Expense Modal -->
    <div class="modal" id="addExpense-modal">
        <div class="modal-content">
            <div class="modal-header">
                <h3 class="modal-title">ğŸ›’ Ø«Ø¨Øª Ù‡Ø²ÛŒÙ†Ù‡</h3>
                <button class="modal-close" onclick="closeModal('addExpense')">Ã—</button>
            </div>
            <div class="modal-body">
                <form onsubmit="addExpense(event)">
                    <div class="form-group">
                        <label class="form-label">Ø¹Ù†ÙˆØ§Ù†</label>
                        <input type="text" class="form-input" id="expenseTitle" required placeholder="Ù…Ø«Ø§Ù„: Ù†Ø§Ù‡Ø§Ø±">
                    </div>
                    
                    <div class="form-group">
                        <label class="form-label">Ø¯Ø³ØªÙ‡â€ŒØ¨Ù†Ø¯ÛŒ</label>
                        <div class="category-grid" id="categoryGrid">
                            <div class="category-option selected" data-category="food">
                                <span class="icon">ğŸ”</span>
                                <span class="label">ØºØ°Ø§</span>
                            </div>
                            <div class="category-option" data-category="transport">
                                <span class="icon">ğŸš—</span>
                                <span class="label">Ø­Ù…Ù„â€ŒÙˆÙ†Ù‚Ù„</span>
                            </div>
                            <div class="category-option" data-category="stay">
                                <span class="icon">ğŸ¨</span>
                                <span class="label">Ø§Ù‚Ø§Ù…Øª</span>
                            </div>
                            <div class="category-option" data-category="fun">
                                <span class="icon">ğŸ¢</span>
                                <span class="label">ØªÙØ±ÛŒØ­</span>
                            </div>
                            <div class="category-option" data-category="shopping">
                                <span class="icon">ğŸ›ï¸</span>
                                <span class="label">Ø®Ø±ÛŒØ¯</span>
                            </div>
                            <div class="category-option" data-category="other">
                                <span class="icon">ğŸ“¦</span>
                                <span class="label">Ø³Ø§ÛŒØ±</span>
                            </div>
                        </div>
                    </div>

                    <div class="form-group">
                        <label class="form-label">Ù…Ø¨Ù„Øº Ú©Ù„ (ØªÙˆÙ…Ø§Ù†)</label>
                        <input type="number" class="form-input" id="expenseAmount" required 
                               inputmode="numeric" placeholder="Ù…Ø«Ø§Ù„: ÛµÛ°Û°Û°Û°Û°">
                    </div>

                    <div class="form-group">
                        <label class="form-label">Ù¾Ø±Ø¯Ø§Ø®Øª Ø´Ø¯Ù‡ ØªÙˆØ³Ø·</label>
                        <select class="form-input form-select" id="expensePaidBy" required>
                            <option value="fund">ğŸ’° ØµÙ†Ø¯ÙˆÙ‚ Ù…Ø´ØªØ±Ú©</option>
                        </select>
                    </div>

                    <div class="form-group">
                        <label class="form-label">Ù†Ø­ÙˆÙ‡ ØªÙ‚Ø³ÛŒÙ…</label>
                        <div class="split-type-toggle">
                            <button type="button" class="split-type-btn active" data-split="equal" onclick="setSplitType('equal')">
                                Ù…Ø³Ø§ÙˆÛŒ
                            </button>
                            <button type="button" class="split-type-btn" data-split="custom" onclick="setSplitType('custom')">
                                Ø³ÙØ§Ø±Ø´ÛŒ
                            </button>
                        </div>
                    </div>

                    <div class="form-group" id="equalSplitGroup">
                        <label class="form-label">
                            Ø´Ø§Ù…Ù„ Ú†Ù‡ Ú©Ø³Ø§Ù†ÛŒ Ù…ÛŒâ€ŒØ´ÙˆØ¯ØŸ
                            <button type="button" class="btn btn-sm btn-outline" onclick="selectAllMembers()" style="float: left;">
                                Ø§Ù†ØªØ®Ø§Ø¨ Ù‡Ù…Ù‡
                            </button>
                        </label>
                        <div class="checkbox-group" id="expenseSplitMembers"></div>
                    </div>

                    <div class="form-group" id="customSplitGroup" style="display: none;">
                        <label class="form-label">Ù…Ø¨Ù„Øº Ø³Ù‡Ù… Ù‡Ø± Ù†ÙØ±</label>
                        <div id="customSplitList"></div>
                        <small style="color: var(--gray-light);">
                            Ø¬Ù…Ø¹: <span id="customSplitTotal">Û°</span> ØªÙˆÙ…Ø§Ù†
                        </small>
                    </div>

                    <button type="submit" class="btn btn-secondary" style="width: 100%;">
                        âœ… Ø«Ø¨Øª Ù‡Ø²ÛŒÙ†Ù‡
                    </button>
                </form>
            </div>
        </div>
    </div>

    <!-- Share Modal -->
    <div class="modal" id="share-modal">
        <div class="modal-content">
            <div class="modal-header">
                <h3 class="modal-title">ğŸ“¤ Ø§Ø´ØªØ±Ø§Ú©â€ŒÚ¯Ø°Ø§Ø±ÛŒ</h3>
                <button class="modal-close" onclick="closeModal('share')">Ã—</button>
            </div>
            <div class="modal-body">
                <div class="share-box">
                    <p style="margin-bottom: 12px; color: var(--gray-light);">Ù„ÛŒÙ†Ú© Ø³ÙØ±:</p>
                    <div class="share-link">
                        <input type="text" id="shareLink" readonly>
                        <button type="button" class="btn btn-primary btn-icon" onclick="copyLink()">ğŸ“‹</button>
                    </div>
                    <div class="share-buttons">
                        <button class="btn btn-success" onclick="shareToWhatsApp('link')">
                            ÙˆØ§ØªØ³Ø§Ù¾ ğŸ’¬
                        </button>
                        <button class="btn btn-outline" onclick="shareNative()">
                            Ø§Ø´ØªØ±Ø§Ú© ğŸ“¤
                        </button>
                    </div>
                </div>

                <div class="qr-container" id="qrContainer"></div>

                <p style="text-align: center; color: var(--gray-light); font-size: 0.85rem;">
                    Ø¨Ø§ Ø§ÛŒÙ† Ù„ÛŒÙ†Ú©ØŒ Ø¯ÛŒÚ¯Ø±Ø§Ù† Ù…ÛŒâ€ŒØªÙˆØ§Ù†Ù†Ø¯ Ù‡Ø²ÛŒÙ†Ù‡â€ŒÙ‡Ø§ Ø±Ø§ Ù…Ø´Ø§Ù‡Ø¯Ù‡ Ú©Ù†Ù†Ø¯
                </p>
            </div>
        </div>
    </div>

    <!-- FAB Menu Modal -->
    <div class="modal" id="fabMenu-modal">
        <div class="modal-content" style="max-height: auto;">
            <div class="modal-body" style="padding: 24px;">
                <div style="display: flex; flex-direction: column; gap: 12px;">
                    <button class="btn btn-primary" onclick="closeModal('fabMenu'); openModal('addExpense');" style="justify-content: flex-start;">
                        ğŸ›’ Ø«Ø¨Øª Ù‡Ø²ÛŒÙ†Ù‡
                    </button>
                    <button class="btn btn-success" onclick="closeModal('fabMenu'); openModal('addDeposit');" style="justify-content: flex-start;">
                        ğŸ’³ Ø«Ø¨Øª ÙˆØ§Ø±ÛŒØ²ÛŒ
                    </button>
                    <button class="btn btn-outline" onclick="closeModal('fabMenu'); openModal('addMember');" style="justify-content: flex-start;">
                        ğŸ‘¤ Ø§ÙØ²ÙˆØ¯Ù† Ø¹Ø¶Ùˆ
                    </button>
                </div>
            </div>
        </div>
    </div>

    <!-- Report Share Modal -->
    <div class="modal" id="reportShare-modal">
        <div class="modal-content">
            <div class="modal-header">
                <h3 class="modal-title">ğŸ“¤ Ø§Ø±Ø³Ø§Ù„ Ú¯Ø²Ø§Ø±Ø´</h3>
                <button class="modal-close" onclick="closeModal('reportShare')">Ã—</button>
            </div>
            <div class="modal-body">
                <div style="display: flex; flex-direction: column; gap: 12px;">
                    <button class="btn btn-success" onclick="shareToWhatsApp('summary')">
                        ğŸ“Š Ø§Ø±Ø³Ø§Ù„ Ø®Ù„Ø§ØµÙ‡ Ø¨Ù‡ ÙˆØ§ØªØ³Ø§Ù¾
                    </button>
                    <button class="btn btn-success" onclick="shareToWhatsApp('settlement')">
                        âš–ï¸ Ø§Ø±Ø³Ø§Ù„ ØªØ³ÙˆÛŒÙ‡ Ø­Ø³Ø§Ø¨ Ø¨Ù‡ ÙˆØ§ØªØ³Ø§Ù¾
                    </button>
                    <button class="btn btn-success" onclick="shareToWhatsApp('full')">
                        ğŸ“‹ Ø§Ø±Ø³Ø§Ù„ Ú¯Ø²Ø§Ø±Ø´ Ú©Ø§Ù…Ù„ Ø¨Ù‡ ÙˆØ§ØªØ³Ø§Ù¾
                    </button>
                </div>
            </div>
        </div>
    </div>

    <!-- ============================================ -->
    <!-- FIREBASE & APP LOGIC -->
    <!-- ============================================ -->
    <script type="module">
        // Firebase imports
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.0.1/firebase-app.js";
        import { getDatabase, ref, set, get, push, remove, onValue, update } 
            from "https://www.gstatic.com/firebasejs/11.0.1/firebase-database.js";

        // Firebase config
        const firebaseConfig = {
            apiKey: "AIzaSyDbe52llu3IoCyjtyT4-QAnsJV0z7VWmbo",
            authDomain: "qeshm-trip.firebaseapp.com",
            databaseURL: "https://qeshm-trip-default-rtdb.firebaseio.com",
            projectId: "qeshm-trip",
            storageBucket: "qeshm-trip.firebasestorage.app",
            messagingSenderId: "1017400189320",
            appId: "1:1017400189320:web:62fbe9d077fc91be1cda3d"
        };

        // Initialize Firebase
        const app = initializeApp(firebaseConfig);
        const db = getDatabase(app);

        // ============================================
        // APP STATE
        // ============================================
        window.appState = {
            tripId: null,
            tripData: null,
            isAdmin: false,
            currentTab: 'expenses',
            splitType: 'equal',
            selectedCategory: 'food',
            selectedAvatar: 'ğŸ‘¨'
        };

        // ============================================
        // UTILITY FUNCTIONS
        // ============================================
        window.formatNumber = (num) => {
            return new Intl.NumberFormat('fa-IR').format(num || 0);
        };

        window.formatMoney = (num) => {
            return formatNumber(num) + ' ØªÙˆÙ…Ø§Ù†';
        };

        window.generateId = () => {
            return Date.now().toString(36) + Math.random().toString(36).substr(2, 9);
        };

        window.getJalaliDate = () => {
            const today = new Date();
            if (typeof jalaali !== 'undefined') {
                const j = jalaali.toJalaali(today.getFullYear(), today.getMonth() + 1, today.getDate());
                const months = ['ÙØ±ÙˆØ±Ø¯ÛŒÙ†', 'Ø§Ø±Ø¯ÛŒØ¨Ù‡Ø´Øª', 'Ø®Ø±Ø¯Ø§Ø¯', 'ØªÛŒØ±', 'Ù…Ø±Ø¯Ø§Ø¯', 'Ø´Ù‡Ø±ÛŒÙˆØ±', 
                               'Ù…Ù‡Ø±', 'Ø¢Ø¨Ø§Ù†', 'Ø¢Ø°Ø±', 'Ø¯ÛŒ', 'Ø¨Ù‡Ù…Ù†', 'Ø§Ø³ÙÙ†Ø¯'];
                return `${j.jd} ${months[j.jm - 1]} ${j.jy}`;
            }
            return today.toLocaleDateString('fa-IR');
        };

        window.showToast = (message, type = 'success') => {
            const toast = document.getElementById('toast');
            toast.textContent = message;
            toast.className = 'toast ' + type + ' show';
            setTimeout(() => toast.classList.remove('show'), 3000);
        };

        window.getCategoryInfo = (cat) => {
            const categories = {
                food: { icon: 'ğŸ”', label: 'ØºØ°Ø§', class: 'food' },
                transport: { icon: 'ğŸš—', label: 'Ø­Ù…Ù„â€ŒÙˆÙ†Ù‚Ù„', class: 'transport' },
                stay: { icon: 'ğŸ¨', label: 'Ø§Ù‚Ø§Ù…Øª', class: 'stay' },
                fun: { icon: 'ğŸ¢', label: 'ØªÙØ±ÛŒØ­', class: 'fun' },
                shopping: { icon: 'ğŸ›ï¸', label: 'Ø®Ø±ÛŒØ¯', class: 'shopping' },
                other: { icon: 'ğŸ“¦', label: 'Ø³Ø§ÛŒØ±', class: 'other' }
            };
            return categories[cat] || categories.other;
        };

        // ============================================
        // MODAL FUNCTIONS
        // ============================================
        window.openModal = (id) => {
            document.getElementById(id + '-modal').classList.add('active');
            if (id === 'addDeposit' || id === 'addExpense') {
                populateMemberSelects();
            }
            if (id === 'share') {
                generateShareContent();
            }
        };

        window.closeModal = (id) => {
            document.getElementById(id + '-modal').classList.remove('active');
        };

        window.showFabMenu = () => {
            openModal('fabMenu');
        };

        // Close modal on backdrop click
        document.querySelectorAll('.modal').forEach(modal => {
            modal.addEventListener('click', (e) => {
                if (e.target === modal) {
                    modal.classList.remove('active');
                }
            });
        });

        // ============================================
        // AVATAR & CATEGORY SELECTION
        // ============================================
        document.querySelectorAll('.avatar-option').forEach(opt => {
            opt.addEventListener('click', () => {
                document.querySelectorAll('.avatar-option').forEach(o => o.classList.remove('selected'));
                opt.classList.add('selected');
                appState.selectedAvatar = opt.dataset.avatar;
            });
        });

        document.querySelectorAll('.category-option').forEach(opt => {
            opt.addEventListener('click', () => {
                document.querySelectorAll('.category-option').forEach(o => o.classList.remove('selected'));
                opt.classList.add('selected');
                appState.selectedCategory = opt.dataset.category;
            });
        });

        // ============================================
        // SPLIT TYPE
        // ============================================
        window.setSplitType = (type) => {
            appState.splitType = type;
            document.querySelectorAll('.split-type-btn').forEach(btn => {
                btn.classList.toggle('active', btn.dataset.split === type);
            });
            document.getElementById('equalSplitGroup').style.display = type === 'equal' ? 'block' : 'none';
            document.getElementById('customSplitGroup').style.display = type === 'custom' ? 'block' : 'none';
            
            if (type === 'custom') {
                populateCustomSplit();
            }
        };

        window.selectAllMembers = () => {
            document.querySelectorAll('#expenseSplitMembers input').forEach(cb => cb.checked = true);
        };

        // ============================================
        // TRIP MANAGEMENT
        // ============================================
        window.createTrip = async (e) => {
            e.preventDefault();
            const name = document.getElementById('newTripName').value;
            const password = document.getElementById('newTripPassword').value;

            const tripId = generateId();
            const tripData = {
                name: name,
                password: password,
                createdAt: Date.now(),
                members: {},
                deposits: {},
                expenses: {}
            };

            try {
                await set(ref(db, 'trips/' + tripId), tripData);
                appState.tripId = tripId;
                appState.tripData = tripData;
                appState.isAdmin = true;
                
                localStorage.setItem('lastTripId', tripId);
                localStorage.setItem('isAdmin_' + tripId, 'true');
                
                closeModal('createTrip');
                showMainScreen();
                showToast('Ø³ÙØ± Ø¨Ø§ Ù…ÙˆÙÙ‚ÛŒØª Ø§ÛŒØ¬Ø§Ø¯ Ø´Ø¯! âœ¨');
            } catch (error) {
                showToast('Ø®Ø·Ø§ Ø¯Ø± Ø§ÛŒØ¬Ø§Ø¯ Ø³ÙØ±', 'error');
                console.error(error);
            }
        };

        window.joinTripByCode = async (e) => {
            e.preventDefault();
            let input = document.getElementById('tripCodeInput').value.trim();
            
            // Extract trip ID from URL if needed
            if (input.includes('trip=')) {
                input = input.split('trip=')[1].split('&')[0];
            }

            try {
                const snapshot = await get(ref(db, 'trips/' + input));
                if (snapshot.exists()) {
                    appState.tripId = input;
                    appState.tripData = snapshot.val();
                    appState.isAdmin = localStorage.getItem('isAdmin_' + input) === 'true';
                    
                    localStorage.setItem('lastTripId', input);
                    
                    closeModal('joinTrip');
                    showMainScreen();
                    listenToTrip();
                    showToast('Ø¨Ù‡ Ø³ÙØ± Ø®ÙˆØ´ Ø¢Ù…Ø¯ÛŒØ¯! ğŸ‰');
                } else {
                    showToast('Ø³ÙØ± ÛŒØ§ÙØª Ù†Ø´Ø¯', 'error');
                }
            } catch (error) {
                showToast('Ø®Ø·Ø§ Ø¯Ø± Ù¾ÛŒØ¯Ø§ Ú©Ø±Ø¯Ù† Ø³ÙØ±', 'error');
                console.error(error);
            }
        };

        window.adminLogin = (e) => {
            e.preventDefault();
            const password = document.getElementById('adminPasswordInput').value;
            
            if (appState.tripData && appState.tripData.password === password) {
                appState.isAdmin = true;
                localStorage.setItem('isAdmin_' + appState.tripId, 'true');
                closeModal('adminLogin');
                updateAdminUI();
                showToast('ÙˆØ±ÙˆØ¯ Ù…ÙˆÙÙ‚! ğŸ”“');
            } else {
                showToast('Ø±Ù…Ø² Ø¹Ø¨ÙˆØ± Ø§Ø´ØªØ¨Ø§Ù‡ Ø§Ø³Øª', 'error');
            }
        };

        // ============================================
        // REALTIME LISTENER
        // ============================================
        function listenToTrip() {
            if (!appState.tripId) return;
            
            onValue(ref(db, 'trips/' + appState.tripId), (snapshot) => {
                if (snapshot.exists()) {
                    appState.tripData = snapshot.val();
                    updateUI();
                }
            });
        }

        // ============================================
        // MEMBER MANAGEMENT
        // ============================================
        window.addMember = async (e) => {
            e.preventDefault();
            const name = document.getElementById('memberName').value;
            
            const memberId = generateId();
            const member = {
                name: name,
                avatar: appState.selectedAvatar,
                createdAt: Date.now()
            };

            try {
                await set(ref(db, `trips/${appState.tripId}/members/${memberId}`), member);
                closeModal('addMember');
                document.getElementById('memberName').value = '';
                showToast('Ø¹Ø¶Ùˆ Ø§Ø¶Ø§ÙÙ‡ Ø´Ø¯! ğŸ‘¤');
            } catch (error) {
                showToast('Ø®Ø·Ø§ Ø¯Ø± Ø§ÙØ²ÙˆØ¯Ù† Ø¹Ø¶Ùˆ', 'error');
            }
        };

        window.deleteMember = async (memberId) => {
            if (!confirm('Ø¢ÛŒØ§ Ø§Ø² Ø­Ø°Ù Ø§ÛŒÙ† Ø¹Ø¶Ùˆ Ù…Ø·Ù…Ø¦Ù†ÛŒØ¯ØŸ')) return;
            
            try {
                await remove(ref(db, `trips/${appState.tripId}/members/${memberId}`));
                showToast('Ø¹Ø¶Ùˆ Ø­Ø°Ù Ø´Ø¯');
            } catch (error) {
                showToast('Ø®Ø·Ø§ Ø¯Ø± Ø­Ø°Ù Ø¹Ø¶Ùˆ', 'error');
            }
        };

        // ============================================
        // DEPOSIT MANAGEMENT
        // ============================================
        window.addDeposit = async (e) => {
            e.preventDefault();
            const memberId = document.getElementById('depositMember').value;
            const amount = parseInt(document.getElementById('depositAmount').value);
            const desc = document.getElementById('depositDesc').value;

            const depositId = generateId();
            const deposit = {
                memberId: memberId,
                amount: amount,
                description: desc || 'ÙˆØ§Ø±ÛŒØ² Ø¨Ù‡ ØµÙ†Ø¯ÙˆÙ‚',
                date: Date.now()
            };

            try {
                await set(ref(db, `trips/${appState.tripId}/deposits/${depositId}`), deposit);
                closeModal('addDeposit');
                document.getElementById('depositAmount').value = '';
                document.getElementById('depositDesc').value = '';
                showToast('ÙˆØ§Ø±ÛŒØ²ÛŒ Ø«Ø¨Øª Ø´Ø¯! ğŸ’³');
            } catch (error) {
                showToast('Ø®Ø·Ø§ Ø¯Ø± Ø«Ø¨Øª ÙˆØ§Ø±ÛŒØ²ÛŒ', 'error');
            }
        };

        window.deleteDeposit = async (depositId) => {
            if (!confirm('Ø¢ÛŒØ§ Ø§Ø² Ø­Ø°Ù Ø§ÛŒÙ† ÙˆØ§Ø±ÛŒØ²ÛŒ Ù…Ø·Ù…Ø¦Ù†ÛŒØ¯ØŸ')) return;
            
            try {
                await remove(ref(db, `trips/${appState.tripId}/deposits/${depositId}`));
                showToast('ÙˆØ§Ø±ÛŒØ²ÛŒ Ø­Ø°Ù Ø´Ø¯');
            } catch (error) {
                showToast('Ø®Ø·Ø§ Ø¯Ø± Ø­Ø°Ù ÙˆØ§Ø±ÛŒØ²ÛŒ', 'error');
            }
        };

        // ============================================
        // EXPENSE MANAGEMENT
        // ============================================
        window.addExpense = async (e) => {
            e.preventDefault();
            const title = document.getElementById('expenseTitle').value;
            const amount = parseInt(document.getElementById('expenseAmount').value);
            const paidBy = document.getElementById('expensePaidBy').value;
            
            let splits = {};
            
            if (appState.splitType === 'equal') {
                const selectedMembers = [];
                document.querySelectorAll('#expenseSplitMembers input:checked').forEach(cb => {
                    selectedMembers.push(cb.value);
                });
                
                if (selectedMembers.length === 0) {
                    showToast('Ø­Ø¯Ø§Ù‚Ù„ ÛŒÚ© Ù†ÙØ± Ø±Ø§ Ø§Ù†ØªØ®Ø§Ø¨ Ú©Ù†ÛŒØ¯', 'error');
                    return;
                }
                
                const splitAmount = amount / selectedMembers.length;
                selectedMembers.forEach(memberId => {
                    splits[memberId] = splitAmount;
                });
            } else {
                document.querySelectorAll('#customSplitList input').forEach(input => {
                    const memberId = input.dataset.member;
                    const val = parseInt(input.value) || 0;
                    if (val > 0) {
                        splits[memberId] = val;
                    }
                });
            }

            const expenseId = generateId();
            const expense = {
                title: title,
                amount: amount,
                category: appState.selectedCategory,
                paidBy: paidBy,
                splits: splits,
                date: Date.now()
            };

            try {
                await set(ref(db, `trips/${appState.tripId}/expenses/${expenseId}`), expense);
                closeModal('addExpense');
                document.getElementById('expenseTitle').value = '';
                document.getElementById('expenseAmount').value = '';
                showToast('Ù‡Ø²ÛŒÙ†Ù‡ Ø«Ø¨Øª Ø´Ø¯! ğŸ›’');
            } catch (error) {
                showToast('Ø®Ø·Ø§ Ø¯Ø± Ø«Ø¨Øª Ù‡Ø²ÛŒÙ†Ù‡', 'error');
            }
        };

        window.deleteExpense = async (expenseId) => {
            if (!confirm('Ø¢ÛŒØ§ Ø§Ø² Ø­Ø°Ù Ø§ÛŒÙ† Ù‡Ø²ÛŒÙ†Ù‡ Ù…Ø·Ù…Ø¦Ù†ÛŒØ¯ØŸ')) return;
            
            try {
                await remove(ref(db, `trips/${appState.tripId}/expenses/${expenseId}`));
                showToast('Ù‡Ø²ÛŒÙ†Ù‡ Ø­Ø°Ù Ø´Ø¯');
            } catch (error) {
                showToast('Ø®Ø·Ø§ Ø¯Ø± Ø­Ø°Ù Ù‡Ø²ÛŒÙ†Ù‡', 'error');
            }
        };

        // ============================================
        // POPULATE SELECTS
        // ============================================
        function populateMemberSelects() {
            const members = appState.tripData?.members || {};
            
            // Deposit member select
            const depositSelect = document.getElementById('depositMember');
            if (depositSelect) {
                depositSelect.innerHTML = '<option value="">Ø§Ù†ØªØ®Ø§Ø¨ Ú©Ù†ÛŒØ¯...</option>';
                Object.entries(members).forEach(([id, m]) => {
                    depositSelect.innerHTML += `<option value="${id}">${m.avatar} ${m.name}</option>`;
                });
            }
            
            // Expense paid by select
            const expenseSelect = document.getElementById('expensePaidBy');
            if (expenseSelect) {
                expenseSelect.innerHTML = '<option value="fund">ğŸ’° 
				                expenseSelect.innerHTML = '<option value="fund">ğŸ’° ØµÙ†Ø¯ÙˆÙ‚ Ù…Ø´ØªØ±Ú©</option>';
                Object.entries(members).forEach(([id, m]) => {
                    expenseSelect.innerHTML += `<option value="${id}">${m.avatar} ${m.name}</option>`;
                });
            }
            
            // Expense split members
            const splitDiv = document.getElementById('expenseSplitMembers');
            if (splitDiv) {
                splitDiv.innerHTML = '';
                Object.entries(members).forEach(([id, m]) => {
                    splitDiv.innerHTML += `
                        <label class="checkbox-item">
                            <input type="checkbox" value="${id}" checked>
                            ${m.avatar} ${m.name}
                        </label>
                    `;
                });
            }
        }

        function populateCustomSplit() {
            const members = appState.tripData?.members || {};
            const container = document.getElementById('customSplitList');
            container.innerHTML = '';
            
            Object.entries(members).forEach(([id, m]) => {
                container.innerHTML += `
                    <div class="custom-split-item">
                        <span class="avatar">${m.avatar}</span>
                        <span class="name">${m.name}</span>
                        <input type="number" data-member="${id}" placeholder="Û°" 
                               inputmode="numeric" onchange="updateCustomTotal()">
                    </div>
                `;
            });
        }

        window.updateCustomTotal = () => {
            let total = 0;
            document.querySelectorAll('#customSplitList input').forEach(input => {
                total += parseInt(input.value) || 0;
            });
            document.getElementById('customSplitTotal').textContent = formatNumber(total);
        };

        // ============================================
        // NAVIGATION & UI
        // ============================================
        window.switchTab = (tab) => {
            appState.currentTab = tab;
            
            document.querySelectorAll('.nav-item').forEach(item => {
                item.classList.toggle('active', item.dataset.tab === tab);
            });
            
            renderTabContent();
        };

        function showMainScreen() {
            document.getElementById('introScreen').classList.remove('active');
            document.getElementById('mainScreen').classList.add('active');
            updateAdminUI();
            listenToTrip();
            updateUI();
        }

        function updateAdminUI() {
            if (appState.isAdmin) {
                document.body.classList.add('is-admin');
                document.getElementById('adminBtn').innerHTML = 'ğŸ”“';
            } else {
                document.body.classList.remove('is-admin');
                document.getElementById('adminBtn').innerHTML = 'ğŸ”';
            }
        }

        function updateUI() {
            if (!appState.tripData) return;
            
            const data = appState.tripData;
            const members = data.members || {};
            const deposits = data.deposits || {};
            const expenses = data.expenses || {};
            
            // Update header
            document.getElementById('tripName').textContent = data.name || 'Ø³ÙØ± Ù…Ù†';
            document.getElementById('tripDate').textContent = getJalaliDate();
            document.getElementById('memberCountHeader').textContent = Object.keys(members).length;
            
            // Calculate stats
            const totalDeposits = Object.values(deposits).reduce((sum, d) => sum + (d.amount || 0), 0);
            const totalExpenses = Object.values(expenses)
                .filter(e => e.paidBy === 'fund')
                .reduce((sum, e) => sum + (e.amount || 0), 0);
            const fundBalance = totalDeposits - totalExpenses;
            
            document.getElementById('totalDeposits').textContent = formatNumber(totalDeposits);
            document.getElementById('totalExpenses').textContent = formatNumber(totalExpenses);
            document.getElementById('fundBalance').textContent = formatNumber(fundBalance);
            document.getElementById('memberCount').textContent = Object.keys(members).length;
            
            // Render current tab
            renderTabContent();
        }

        function renderTabContent() {
            const container = document.getElementById('tabContent');
            
            switch (appState.currentTab) {
                case 'expenses':
                    renderExpensesTab(container);
                    break;
                case 'members':
                    renderMembersTab(container);
                    break;
                case 'settlement':
                    renderSettlementTab(container);
                    break;
                case 'reports':
                    renderReportsTab(container);
                    break;
            }
        }

        // ============================================
        // RENDER TABS
        // ============================================
        function renderExpensesTab(container) {
            const expenses = appState.tripData?.expenses || {};
            const deposits = appState.tripData?.deposits || {};
            const members = appState.tripData?.members || {};
            
            let html = `
                <div class="section">
                    <div class="section-header">
                        <h3 class="section-title">ğŸ’³ ÙˆØ§Ø±ÛŒØ²ÛŒâ€ŒÙ‡Ø§</h3>
                    </div>
            `;
            
            const depositArr = Object.entries(deposits);
            if (depositArr.length === 0) {
                html += `<div class="empty-state"><p>Ù‡Ù†ÙˆØ² ÙˆØ§Ø±ÛŒØ²ÛŒ Ø«Ø¨Øª Ù†Ø´Ø¯Ù‡</p></div>`;
            } else {
                depositArr.forEach(([id, d]) => {
                    const member = members[d.memberId];
                    if (!member) return;
                    
                    html += `
                        <div class="list-item">
                            <div class="list-icon" style="background: var(--success-bg);">ğŸ’³</div>
                            <div class="list-content">
                                <div class="list-title">${member.avatar} ${member.name}</div>
                                <div class="list-meta">${d.description || 'ÙˆØ§Ø±ÛŒØ² Ø¨Ù‡ ØµÙ†Ø¯ÙˆÙ‚'}</div>
                            </div>
                            <div class="list-amount" style="color: var(--success);">
                                +${formatNumber(d.amount)}
                            </div>
                            ${appState.isAdmin ? `
                                <button class="btn btn-sm btn-outline" onclick="deleteDeposit('${id}')" 
                                        style="margin-right: 8px;">ğŸ—‘ï¸</button>
                            ` : ''}
                        </div>
                    `;
                });
            }
            
            html += `</div>`;
            
            // Expenses section
            html += `
                <div class="section">
                    <div class="section-header">
                        <h3 class="section-title">ğŸ›’ Ù‡Ø²ÛŒÙ†Ù‡â€ŒÙ‡Ø§</h3>
                    </div>
            `;
            
            const expenseArr = Object.entries(expenses);
            if (expenseArr.length === 0) {
                html += `<div class="empty-state"><p>Ù‡Ù†ÙˆØ² Ù‡Ø²ÛŒÙ†Ù‡â€ŒØ§ÛŒ Ø«Ø¨Øª Ù†Ø´Ø¯Ù‡</p></div>`;
            } else {
                expenseArr.sort((a, b) => b[1].date - a[1].date).forEach(([id, e]) => {
                    const cat = getCategoryInfo(e.category);
                    const paidByText = e.paidBy === 'fund' ? 'ğŸ’° ØµÙ†Ø¯ÙˆÙ‚' : 
                        (members[e.paidBy] ? `${members[e.paidBy].avatar} ${members[e.paidBy].name}` : 'Ù†Ø§Ù…Ø´Ø®Øµ');
                    
                    const splitCount = e.splits ? Object.keys(e.splits).length : 0;
                    
                    html += `
                        <div class="list-item">
                            <div class="list-icon ${cat.class}">${cat.icon}</div>
                            <div class="list-content">
                                <div class="list-title">${e.title}</div>
                                <div class="list-meta">${paidByText} â€¢ ${splitCount} Ù†ÙØ±</div>
                            </div>
                            <div class="list-amount" style="color: var(--danger);">
                                -${formatNumber(e.amount)}
                            </div>
                            ${appState.isAdmin ? `
                                <button class="btn btn-sm btn-outline" onclick="deleteExpense('${id}')"
                                        style="margin-right: 8px;">ğŸ—‘ï¸</button>
                            ` : ''}
                        </div>
                    `;
                });
            }
            
            html += `</div>`;
            container.innerHTML = html;
        }

        function renderMembersTab(container) {
            const members = appState.tripData?.members || {};
            const deposits = appState.tripData?.deposits || {};
            const expenses = appState.tripData?.expenses || {};
            
            let html = `
                <div class="section">
                    <div class="section-header">
                        <h3 class="section-title">ğŸ‘¥ Ø§Ø¹Ø¶Ø§ÛŒ Ø³ÙØ±</h3>
                    </div>
            `;
            
            const memberArr = Object.entries(members);
            if (memberArr.length === 0) {
                html += `
                    <div class="empty-state">
                        <div class="icon">ğŸ‘¥</div>
                        <p>Ù‡Ù†ÙˆØ² Ø¹Ø¶ÙˆÛŒ Ø§Ø¶Ø§ÙÙ‡ Ù†Ø´Ø¯Ù‡</p>
                        ${appState.isAdmin ? `
                            <button class="btn btn-primary" onclick="openModal('addMember')">
                                â• Ø§ÙØ²ÙˆØ¯Ù† Ø¹Ø¶Ùˆ
                            </button>
                        ` : ''}
                    </div>
                `;
            } else {
                html += `<div style="display: grid; gap: 12px;">`;
                
                memberArr.forEach(([id, m]) => {
                    // Calculate member's deposits
                    const memberDeposits = Object.values(deposits)
                        .filter(d => d.memberId === id)
                        .reduce((sum, d) => sum + d.amount, 0);
                    
                    // Calculate member's share in expenses
                    let memberShare = 0;
                    Object.values(expenses).forEach(e => {
                        if (e.splits && e.splits[id]) {
                            memberShare += e.splits[id];
                        }
                    });
                    
                    html += `
                        <div class="card">
                            <div class="card-header">
                                <div class="card-avatar">${m.avatar}</div>
                                <div>
                                    <div class="card-title">${m.name}</div>
                                    <div class="card-subtitle">ÙˆØ§Ø±ÛŒØ²ÛŒ: ${formatNumber(memberDeposits)} ØªÙˆÙ…Ø§Ù†</div>
                                </div>
                            </div>
                            <div style="display: flex; justify-content: space-between; font-size: 0.85rem; color: var(--gray-light);">
                                <span>Ø³Ù‡Ù… Ø§Ø² Ù‡Ø²ÛŒÙ†Ù‡â€ŒÙ‡Ø§:</span>
                                <span>${formatNumber(Math.round(memberShare))} ØªÙˆÙ…Ø§Ù†</span>
                            </div>
                            ${appState.isAdmin ? `
                                <div class="card-actions admin-actions">
                                    <button class="btn btn-sm btn-outline" style="flex: 1;" onclick="deleteMember('${id}')">
                                        ğŸ—‘ï¸ Ø­Ø°Ù
                                    </button>
                                </div>
                            ` : ''}
                        </div>
                    `;
                });
                
                html += `</div>`;
            }
            
            html += `</div>`;
            container.innerHTML = html;
        }

        function renderSettlementTab(container) {
            const members = appState.tripData?.members || {};
            const deposits = appState.tripData?.deposits || {};
            const expenses = appState.tripData?.expenses || {};
            
            // Calculate balances
            const balances = {};
            
            Object.keys(members).forEach(id => {
                balances[id] = {
                    member: members[id],
                    deposited: 0,
                    share: 0,
                    paidExtra: 0,
                    balance: 0
                };
            });
            
            // Add deposits
            Object.values(deposits).forEach(d => {
                if (balances[d.memberId]) {
                    balances[d.memberId].deposited += d.amount;
                }
            });
            
            // Calculate shares and extra payments
            Object.values(expenses).forEach(e => {
                if (e.splits) {
                    Object.entries(e.splits).forEach(([memberId, amount]) => {
                        if (balances[memberId]) {
                            balances[memberId].share += amount;
                        }
                    });
                }
                
                if (e.paidBy !== 'fund' && balances[e.paidBy]) {
                    balances[e.paidBy].paidExtra += e.amount;
                }
            });
            
            // Calculate final balance
            Object.keys(balances).forEach(id => {
                const b = balances[id];
                b.balance = (b.deposited + b.paidExtra) - b.share;
            });
            
            // Render balances
            let html = `
                <div class="section">
                    <div class="section-header">
                        <h3 class="section-title">ğŸ“Š ØªØ±Ø§Ø² Ù‡Ø± Ù†ÙØ±</h3>
                    </div>
                    <div style="display: grid; grid-template-columns: repeat(2, 1fr); gap: 12px;">
            `;
            
            Object.values(balances).forEach(b => {
                let cardClass = 'zero';
                let statusText = 'ØªØ³ÙˆÛŒÙ‡ âœ…';
                
                if (b.balance > 10) {
                    cardClass = 'positive';
                    statusText = `Ø·Ù„Ø¨Ú©Ø§Ø± ğŸ’š`;
                } else if (b.balance < -10) {
                    cardClass = 'negative';
                    statusText = `Ø¨Ø¯Ù‡Ú©Ø§Ø± â¤ï¸`;
                }
                
                html += `
                    <div class="balance-card ${cardClass}">
                        <div class="balance-avatar">${b.member.avatar}</div>
                        <div class="balance-name">${b.member.name}</div>
                        <div class="balance-amount" style="color: ${b.balance > 0 ? 'var(--success)' : b.balance < 0 ? 'var(--danger)' : 'var(--gray)'}">
                            ${b.balance >= 0 ? '+' : ''}${formatNumber(Math.round(b.balance))}
                        </div>
                        <div class="balance-status">${statusText}</div>
                    </div>
                `;
            });
            
            html += `</div></div>`;
            
            // Calculate settlements
            const creditors = [];
            const debtors = [];
            
            Object.entries(balances).forEach(([id, b]) => {
                if (b.balance > 10) {
                    creditors.push({ id, ...b.member, amount: b.balance });
                } else if (b.balance < -10) {
                    debtors.push({ id, ...b.member, amount: Math.abs(b.balance) });
                }
            });
            
            creditors.sort((a, b) => b.amount - a.amount);
            debtors.sort((a, b) => b.amount - a.amount);
            
            const settlements = [];
            
            while (debtors.length > 0 && creditors.length > 0) {
                const debtor = debtors[0];
                const creditor = creditors[0];
                const amount = Math.min(debtor.amount, creditor.amount);
                
                settlements.push({
                    from: debtor,
                    to: creditor,
                    amount: Math.round(amount)
                });
                
                debtor.amount -= amount;
                creditor.amount -= amount;
                
                if (debtor.amount < 10) debtors.shift();
                if (creditor.amount < 10) creditors.shift();
            }
            
            // Render settlements
            html += `
                <div class="section">
                    <div class="section-header">
                        <h3 class="section-title">ğŸ”„ ØªØ±Ø§Ú©Ù†Ø´â€ŒÙ‡Ø§ÛŒ ØªØ³ÙˆÛŒÙ‡</h3>
                    </div>
            `;
            
            if (settlements.length === 0) {
                html += `
                    <div class="empty-state">
                        <div class="icon">âœ…</div>
                        <p>Ù‡Ù…Ù‡ Ø­Ø³Ø§Ø¨â€ŒÙ‡Ø§ ØªØ³ÙˆÛŒÙ‡ Ø§Ø³Øª!</p>
                    </div>
                `;
            } else {
                settlements.forEach(s => {
                    html += `
                        <div class="settlement-card">
                            <div class="settlement-flow">
                                <div class="settlement-person">
                                    <div class="avatar">${s.from.avatar}</div>
                                    <div class="name">${s.from.name}</div>
                                </div>
                                <div class="settlement-arrow">
                                    <span>â¡ï¸</span>
                                    <div class="settlement-amount">${formatNumber(s.amount)}</div>
                                </div>
                                <div class="settlement-person">
                                    <div class="avatar">${s.to.avatar}</div>
                                    <div class="name">${s.to.name}</div>
                                </div>
                            </div>
                        </div>
                    `;
                });
            }
            
            html += `</div>`;
            
            // Store settlements for sharing
            window.currentSettlements = settlements;
            
            container.innerHTML = html;
        }

        function renderReportsTab(container) {
            const members = appState.tripData?.members || {};
            const deposits = appState.tripData?.deposits || {};
            const expenses = appState.tripData?.expenses || {};
            
            const totalDeposits = Object.values(deposits).reduce((sum, d) => sum + d.amount, 0);
            const totalExpenses = Object.values(expenses).reduce((sum, e) => sum + e.amount, 0);
            const memberCount = Object.keys(members).length;
            const perPerson = memberCount > 0 ? totalExpenses / memberCount : 0;
            
            // Category breakdown
            const categoryTotals = {};
            Object.values(expenses).forEach(e => {
                const cat = e.category || 'other';
                categoryTotals[cat] = (categoryTotals[cat] || 0) + e.amount;
            });
            
            let html = `
                <div class="section">
                    <div class="section-header">
                        <h3 class="section-title">ğŸ“Š Ú¯Ø²Ø§Ø±Ø´ Ø³ÙØ±</h3>
                        <button class="btn btn-sm btn-success" onclick="openModal('reportShare')">
                            ğŸ“¤ Ø§Ø±Ø³Ø§Ù„
                        </button>
                    </div>
                    
                    <div class="report-summary">
                        <div class="report-item">
                            <div class="value">${formatNumber(totalDeposits)}</div>
                            <div class="label">Ú©Ù„ ÙˆØ§Ø±ÛŒØ²ÛŒ (ØªÙˆÙ…Ø§Ù†)</div>
                        </div>
                        <div class="report-item">
                            <div class="value">${formatNumber(totalExpenses)}</div>
                            <div class="label">Ú©Ù„ Ù‡Ø²ÛŒÙ†Ù‡ (ØªÙˆÙ…Ø§Ù†)</div>
                        </div>
                        <div class="report-item">
                            <div class="value">${formatNumber(Math.round(perPerson))}</div>
                            <div class="label">Ø³Ù‡Ù… Ù‡Ø± Ù†ÙØ± (ØªÙˆÙ…Ø§Ù†)</div>
                        </div>
                        <div class="report-item">
                            <div class="value">${Object.keys(expenses).length}</div>
                            <div class="label">ØªØ¹Ø¯Ø§Ø¯ Ù‡Ø²ÛŒÙ†Ù‡</div>
                        </div>
                    </div>
                </div>
                
                <div class="section">
                    <div class="section-header">
                        <h3 class="section-title">ğŸ“ˆ Ù‡Ø²ÛŒÙ†Ù‡ Ø¨Ù‡ ØªÙÚ©ÛŒÚ© Ø¯Ø³ØªÙ‡</h3>
                    </div>
                    <div class="chart-container">
                        <canvas id="categoryChart"></canvas>
                    </div>
                </div>
            `;
            
            container.innerHTML = html;
            
            // Render chart
            setTimeout(() => {
                const ctx = document.getElementById('categoryChart');
                if (ctx && Object.keys(categoryTotals).length > 0) {
                    const labels = [];
                    const data = [];
                    const colors = [];
                    
                    const colorMap = {
                        food: '#EF4444',
                        transport: '#3B82F6',
                        stay: '#8B5CF6',
                        fun: '#EC4899',
                        shopping: '#F59E0B',
                        other: '#6B7280'
                    };
                    
                    Object.entries(categoryTotals).forEach(([cat, amount]) => {
                        const info = getCategoryInfo(cat);
                        labels.push(info.icon + ' ' + info.label);
                        data.push(amount);
                        colors.push(colorMap[cat] || '#6B7280');
                    });
                    
                    new Chart(ctx, {
                        type: 'doughnut',
                        data: {
                            labels: labels,
                            datasets: [{
                                data: data,
                                backgroundColor: colors,
                                borderWidth: 0
                            }]
                        },
                        options: {
                            responsive: true,
                            maintainAspectRatio: false,
                            plugins: {
                                legend: {
                                    position: 'bottom',
                                    labels: {
                                        color: '#94A3B8',
                                        font: { family: 'Vazirmatn' },
                                        padding: 15
                                    }
                                }
                            }
                        }
                    });
                }
            }, 100);
        }

        // ============================================
        // SHARE FUNCTIONS
        // ============================================
        function generateShareContent() {
            const baseUrl = window.location.origin + window.location.pathname;
            const shareUrl = `${baseUrl}?trip=${appState.tripId}`;
            
            document.getElementById('shareLink').value = shareUrl;
            
            // Generate QR Code
            const qrContainer = document.getElementById('qrContainer');
            qrContainer.innerHTML = '';
            
            if (typeof QRCode !== 'undefined') {
                QRCode.toCanvas(shareUrl, { width: 200, margin: 2 }, (err, canvas) => {
                    if (!err) {
                        qrContainer.appendChild(canvas);
                    }
                });
            }
        }

        window.copyLink = () => {
            const link = document.getElementById('shareLink').value;
            navigator.clipboard.writeText(link).then(() => {
                showToast('Ù„ÛŒÙ†Ú© Ú©Ù¾ÛŒ Ø´Ø¯! ğŸ“‹');
            });
        };

        window.shareNative = () => {
            const link = document.getElementById('shareLink').value;
            if (navigator.share) {
                navigator.share({
                    title: 'Ø³ÙØ±ÛŒÙ†Ùˆ - ' + (appState.tripData?.name || 'Ø³ÙØ±'),
                    text: 'Ø¨Ø±Ø§ÛŒ Ù…Ø´Ø§Ù‡Ø¯Ù‡ Ù‡Ø²ÛŒÙ†Ù‡â€ŒÙ‡Ø§ÛŒ Ø³ÙØ± Ú©Ù„ÛŒÚ© Ú©Ù†ÛŒØ¯',
                    url: link
                });
            } else {
                copyLink();
            }
        };

        window.shareToWhatsApp = (type) => {
            let text = '';
            const data = appState.tripData;
            const members = data?.members || {};
            const deposits = data?.deposits || {};
            const expenses = data?.expenses || {};
            
            const totalDeposits = Object.values(deposits).reduce((sum, d) => sum + d.amount, 0);
            const totalExpenses = Object.values(expenses).reduce((sum, e) => sum + e.amount, 0);
            const fundBalance = totalDeposits - Object.values(expenses)
                .filter(e => e.paidBy === 'fund')
                .reduce((sum, e) => sum + e.amount, 0);
            
            if (type === 'link') {
                const link = `${window.location.origin}${window.location.pathname}?trip=${appState.tripId}`;
                text = `ğŸï¸ *${data?.name || 'Ø³ÙØ±'}*

Ø¨Ø±Ø§ÛŒ Ù…Ø´Ø§Ù‡Ø¯Ù‡ Ù‡Ø²ÛŒÙ†Ù‡â€ŒÙ‡Ø§ Ùˆ Ú¯Ø²Ø§Ø±Ø´ Ø³ÙØ± Ø±ÙˆÛŒ Ù„ÛŒÙ†Ú© Ø²ÛŒØ± Ú©Ù„ÛŒÚ© Ú©Ù†ÛŒØ¯:

${link}

ğŸ“± _Ø³ÙØ±ÛŒÙ†Ùˆ - Ù…Ø¯ÛŒØ±ÛŒØª Ù‡Ø²ÛŒÙ†Ù‡â€ŒÙ‡Ø§ÛŒ Ø³ÙØ±_`;
            } 
            else if (type === 'summary') {
                const memberCount = Object.keys(members).length;
                const perPerson = memberCount > 0 ? Math.round(totalExpenses / memberCount) : 0;
                
                text = `ğŸï¸ *Ú¯Ø²Ø§Ø±Ø´ ${data?.name || 'Ø³ÙØ±'}*
ğŸ“… ${getJalaliDate()}

ğŸ‘¥ *Ø§Ø¹Ø¶Ø§:* ${Object.values(members).map(m => m.name).join('ØŒ ')}

ğŸ’° *Ø®Ù„Ø§ØµÙ‡ Ù…Ø§Ù„ÛŒ:*
â”œ Ú©Ù„ ÙˆØ§Ø±ÛŒØ²ÛŒ: ${formatNumber(totalDeposits)} ØªÙˆÙ…Ø§Ù†
â”œ Ú©Ù„ Ù‡Ø²ÛŒÙ†Ù‡: ${formatNumber(totalExpenses)} ØªÙˆÙ…Ø§Ù†
â”œ Ù…Ø§Ù†Ø¯Ù‡ ØµÙ†Ø¯ÙˆÙ‚: ${formatNumber(fundBalance)} ØªÙˆÙ…Ø§Ù†
â”” Ø³Ù‡Ù… Ù‡Ø± Ù†ÙØ±: ${formatNumber(perPerson)} ØªÙˆÙ…Ø§Ù†

ğŸ“± _Ø³ÙØ±ÛŒÙ†Ùˆ - Ø·Ø±Ø§Ø­ÛŒ: Ù…Ø­Ù…Ø¯ Ø¹Ø¨Ø§Ø³ÛŒ_`;
            }
            else if (type === 'settlement') {
                const settlements = window.currentSettlements || [];
                
                text = `âš–ï¸ *ØªØ³ÙˆÛŒÙ‡ Ø­Ø³Ø§Ø¨ ${data?.name || 'Ø³ÙØ±'}*
ğŸ“… ${getJalaliDate()}

`;
                if (settlements.length === 0) {
                    text += `âœ… Ù‡Ù…Ù‡ Ø­Ø³Ø§Ø¨â€ŒÙ‡Ø§ ØªØ³ÙˆÛŒÙ‡ Ø§Ø³Øª!`;
                } else {
                    text += `ğŸ”„ *ØªØ±Ø§Ú©Ù†Ø´â€ŒÙ‡Ø§ÛŒ Ù„Ø§Ø²Ù…:*\n`;
                    settlements.forEach((s, i) => {
                        text += `\n${i + 1}. ${s.from.avatar} ${s.from.name} â¡ï¸ ${s.to.avatar} ${s.to.name}
   ğŸ’µ *${formatNumber(s.amount)} ØªÙˆÙ…Ø§Ù†*`;
                    });
                }
                
                text += `\n\nğŸ“± _Ø³ÙØ±ÛŒÙ†Ùˆ - Ø·Ø±Ø§Ø­ÛŒ: Ù…Ø­Ù…Ø¯ Ø¹Ø¨Ø§Ø³ÛŒ_`;
            }
            else if (type === 'full') {
                text = `ğŸï¸ *Ú¯Ø²Ø§Ø±Ø´ Ú©Ø§Ù…Ù„ ${data?.name || 'Ø³ÙØ±'}*
ğŸ“… ${getJalaliDate()}

ğŸ‘¥ *Ø§Ø¹Ø¶Ø§ (${Object.keys(members).length} Ù†ÙØ±):*
${Object.values(members).map(m => `â€¢ ${m.avatar} ${m.name}`).join('\n')}

ğŸ’³ *ÙˆØ§Ø±ÛŒØ²ÛŒâ€ŒÙ‡Ø§:*
${Object.values(deposits).map(d => {
    const m = members[d.memberId];
    return `â€¢ ${m?.avatar || ''} ${m?.name || 'Ù†Ø§Ù…Ø´Ø®Øµ'}: ${formatNumber(d.amount)} ØªÙˆÙ…Ø§Ù†`;
}).join('\n') || 'â€¢ Ø¨Ø¯ÙˆÙ† ÙˆØ§Ø±ÛŒØ²ÛŒ'}

ğŸ›’ *Ù‡Ø²ÛŒÙ†Ù‡â€ŒÙ‡Ø§:*
${Object.values(expenses).map(e => {
    const cat = getCategoryInfo(e.category);
    return `â€¢ ${cat.icon} ${e.title}: ${formatNumber(e.amount)} ØªÙˆÙ…Ø§Ù†`;
}).join('\n') || 'â€¢ Ø¨Ø¯ÙˆÙ† Ù‡Ø²ÛŒÙ†Ù‡'}

ğŸ’° *Ø¬Ù…Ø¹â€ŒØ¨Ù†Ø¯ÛŒ:*
â”œ Ú©Ù„ ÙˆØ§Ø±ÛŒØ²ÛŒ: ${formatNumber(totalDeposits)} ØªÙˆÙ…Ø§Ù†
â”œ Ú©Ù„ Ù‡Ø²ÛŒÙ†Ù‡: ${formatNumber(totalExpenses)} ØªÙˆÙ…Ø§Ù†
â”” Ù…Ø§Ù†Ø¯Ù‡ ØµÙ†Ø¯ÙˆÙ‚: ${formatNumber(fundBalance)} ØªÙˆÙ…Ø§Ù†

ğŸ“± _Ø³ÙØ±ÛŒÙ†Ùˆ - Ø·Ø±Ø§Ø­ÛŒ: Ù…Ø­Ù…Ø¯ Ø¹Ø¨Ø§Ø³ÛŒ_`;
            }
            
            const whatsappUrl = `https://wa.me/?text=${encodeURIComponent(text)}`;
            window.open(whatsappUrl, '_blank');
            closeModal('reportShare');
            closeModal('share');
        };

        // ============================================
        // INITIALIZATION
        // ============================================
        function init() {
            // Check URL for trip ID
            const urlParams = new URLSearchParams(window.location.search);
            const tripId = urlParams.get('trip');
            
            if (tripId) {
                // Join trip from URL
                get(ref(db, 'trips/' + tripId)).then(snapshot => {
                    if (snapshot.exists()) {
                        appState.tripId = tripId;
                        appState.tripData = snapshot.val();
                        appState.isAdmin = localStorage.getItem('isAdmin_' + tripId) === 'true';
                        showMainScreen();
                    } else {
                        showToast('Ø³ÙØ± ÛŒØ§ÙØª Ù†Ø´Ø¯', 'error');
                    }
                });
            } else {
                // Check for last trip
                const lastTripId = localStorage.getItem('lastTripId');
                if (lastTripId) {
                    get(ref(db, 'trips/' + lastTripId)).then(snapshot => {
                        if (snapshot.exists()) {
                            appState.tripId = lastTripId;
                            appState.tripData = snapshot.val();
                            appState.isAdmin = localStorage.getItem('isAdmin_' + lastTripId) === 'true';
                            showMainScreen();
                        }
                    });
                }
            }
            
            // Connection status
            const connRef = ref(db, '.info/connected');
            onValue(connRef, (snap) => {
                const status = document.getElementById('connectionStatus');
                if (snap.val() === true) {
                    status.textContent = 'âœ… Ø¢Ù†Ù„Ø§ÛŒÙ†';
                    status.className = 'connection-status online';
                } else {
                    status.textContent = 'âš ï¸ Ø¢ÙÙ„Ø§ÛŒÙ† - ØªØºÛŒÛŒØ±Ø§Øª Ø°Ø®ÛŒØ±Ù‡ Ù†Ù…ÛŒâ€ŒØ´ÙˆØ¯';
                    status.className = 'connection-status offline';
                }
            });
        }

        // Start app
        init();
    </script>
</body>
</html>
