<!DOCTYPE html>
<html lang="fa" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=5.0, user-scalable=yes">
    <meta name="theme-color" content="#0D9488">
    <title>ğŸï¸ Ø³ÙØ±ÛŒÙ†Ùˆ - Ù…Ø¯ÛŒØ±ÛŒØª Ù‡Ø²ÛŒÙ†Ù‡ Ø³ÙØ±</title>
    
    <link rel="icon" href="data:image/svg+xml,<svg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 100 100'><text y='.9em' font-size='90'>ğŸï¸</text></svg>">
    <link href="https://cdn.jsdelivr.net/gh/rastikerdar/vazirmatn@v33.003/Vazirmatn-font-face.css" rel="stylesheet">
    <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.1/dist/chart.umd.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>

    <style>
        :root {
            --primary: #0D9488;
            --primary-light: #14B8A6;
            --primary-dark: #0F766E;
            --secondary: #F97316;
            --success: #10B981;
            --danger: #EF4444;
            --warning: #F59E0B;
            --info: #3B82F6;
            
            --bg-primary: #0F172A;
            --bg-secondary: #1E293B;
            --bg-tertiary: #334155;
            
            --text-primary: #F8FAFC;
            --text-secondary: #CBD5E1;
            --text-muted: #64748B;
            
            --glass: rgba(255, 255, 255, 0.1);
            --glass-border: rgba(255, 255, 255, 0.15);
            
            --radius: 12px;
            --radius-lg: 16px;
            --radius-full: 50px;
            
            --shadow: 0 4px 20px rgba(0,0,0,0.3);
            --shadow-lg: 0 8px 40px rgba(0,0,0,0.4);
            
            --safe-bottom: env(safe-area-inset-bottom, 0px);
        }

        [data-theme="day"] {
            --bg-primary: #F1F5F9;
            --bg-secondary: #FFFFFF;
            --bg-tertiary: #E2E8F0;
            --text-primary: #0F172A;
            --text-secondary: #475569;
            --text-muted: #94A3B8;
            --glass: rgba(0, 0, 0, 0.05);
            --glass-border: rgba(0, 0, 0, 0.1);
        }

        [data-theme="sunset"] {
            --primary: #F97316;
            --primary-light: #FB923C;
            --bg-primary: #1C1917;
            --bg-secondary: #292524;
            --bg-tertiary: #44403C;
        }

        [data-theme="ocean"] {
            --primary: #0EA5E9;
            --primary-light: #38BDF8;
            --bg-primary: #0C1929;
            --bg-secondary: #152238;
            --bg-tertiary: #1E3A5F;
        }

        [data-theme="forest"] {
            --primary: #22C55E;
            --primary-light: #4ADE80;
            --bg-primary: #14201A;
            --bg-secondary: #1A2F23;
            --bg-tertiary: #264032;
        }

        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            -webkit-tap-highlight-color: transparent;
        }

        html { scroll-behavior: smooth; }

        body {
            font-family: 'Vazirmatn', system-ui, sans-serif;
            background: var(--bg-primary);
            color: var(--text-primary);
            line-height: 1.6;
            min-height: 100vh;
            overflow-x: hidden;
        }

        /* ===== LOADING ===== */
        .loading-overlay {
            position: fixed;
            inset: 0;
            background: var(--bg-primary);
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            z-index: 9999;
            transition: opacity 0.3s, visibility 0.3s;
        }

        .loading-overlay.hide {
            opacity: 0;
            visibility: hidden;
            pointer-events: none;
        }

        .loading-spinner {
            width: 50px;
            height: 50px;
            border: 4px solid var(--bg-tertiary);
            border-top-color: var(--primary);
            border-radius: 50%;
            animation: spin 1s linear infinite;
            margin-bottom: 16px;
        }

        @keyframes spin { to { transform: rotate(360deg); } }

        .loading-text {
            color: var(--text-muted);
            font-size: 14px;
        }

        /* ===== SCREENS ===== */
        .screen {
            display: none;
            min-height: 100vh;
            padding-bottom: calc(80px + var(--safe-bottom));
        }

        .screen.active {
            display: block;
            animation: fadeIn 0.3s ease;
        }

        @keyframes fadeIn {
            from { opacity: 0; }
            to { opacity: 1; }
        }

        /* ===== CONTAINER ===== */
        .container {
            max-width: 500px;
            margin: 0 auto;
            padding: 16px;
        }

        /* ===== TOAST ===== */
        .toast {
            position: fixed;
            top: 20px;
            left: 50%;
            transform: translateX(-50%) translateY(-100px);
            background: var(--bg-secondary);
            border: 1px solid var(--glass-border);
            color: var(--text-primary);
            padding: 12px 24px;
            border-radius: var(--radius-full);
            font-size: 14px;
            font-weight: 600;
            box-shadow: var(--shadow-lg);
            z-index: 10000;
            opacity: 0;
            transition: all 0.3s cubic-bezier(0.68, -0.55, 0.265, 1.55);
        }

        .toast.show {
            opacity: 1;
            transform: translateX(-50%) translateY(0);
        }

        .toast.success { background: linear-gradient(135deg, #10B981, #059669); color: white; border: none; }
        .toast.error { background: linear-gradient(135deg, #EF4444, #DC2626); color: white; border: none; }
        .toast.warning { background: linear-gradient(135deg, #F59E0B, #D97706); color: white; border: none; }
        .toast.info { background: linear-gradient(135deg, #3B82F6, #2563EB); color: white; border: none; }

        /* ===== TOP BAR ===== */
        .top-bar {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            height: 56px;
            background: var(--bg-secondary);
            border-bottom: 1px solid var(--glass-border);
            display: flex;
            align-items: center;
            justify-content: space-between;
            padding: 0 16px;
            z-index: 100;
        }

        .top-bar-title {
            font-size: 18px;
            font-weight: 700;
            background: linear-gradient(135deg, var(--primary-light), var(--primary));
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
        }

        .top-bar-actions {
            display: flex;
            gap: 8px;
        }

        /* ===== BUTTONS ===== */
        .btn {
            display: inline-flex;
            align-items: center;
            justify-content: center;
            gap: 8px;
            padding: 12px 20px;
            border-radius: var(--radius-full);
            font-size: 14px;
            font-weight: 600;
            font-family: inherit;
            border: none;
            cursor: pointer;
            transition: all 0.2s;
            text-decoration: none;
        }

        .btn:active { transform: scale(0.97); }

        .btn-primary {
            background: linear-gradient(135deg, var(--primary-light), var(--primary));
            color: white;
            box-shadow: 0 4px 15px rgba(13, 148, 136, 0.4);
        }

        .btn-secondary {
            background: var(--bg-tertiary);
            color: var(--text-primary);
        }

        .btn-success {
            background: linear-gradient(135deg, #34D399, #10B981);
            color: white;
        }

        .btn-danger {
            background: linear-gradient(135deg, #F87171, #EF4444);
            color: white;
        }

        .btn-outline {
            background: transparent;
            border: 2px solid var(--glass-border);
            color: var(--text-primary);
        }

        .btn-ghost {
            background: transparent;
            color: var(--text-muted);
            padding: 8px;
        }

        .btn-lg { padding: 16px 24px; font-size: 16px; }
        .btn-sm { padding: 8px 16px; font-size: 13px; }
        .btn-icon { width: 44px; height: 44px; padding: 0; border-radius: var(--radius); }

        /* ===== CARDS ===== */
        .card {
            background: var(--bg-secondary);
            border: 1px solid var(--glass-border);
            border-radius: var(--radius-lg);
            padding: 20px;
            margin-bottom: 16px;
        }

        .card-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 16px;
        }

        .card-title {
            font-size: 16px;
            font-weight: 700;
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .card-badge {
            background: var(--primary);
            color: white;
            font-size: 12px;
            padding: 2px 10px;
            border-radius: var(--radius-full);
        }

        /* ===== FORMS ===== */
        .form-group { margin-bottom: 20px; }

        .form-label {
            display: block;
            margin-bottom: 8px;
            font-size: 14px;
            font-weight: 600;
            color: var(--text-secondary);
        }

        .form-label .required { color: var(--danger); }

        .form-input {
            width: 100%;
            padding: 12px 16px;
            background: var(--bg-tertiary);
            border: 2px solid var(--glass-border);
            border-radius: var(--radius);
            color: var(--text-primary);
            font-size: 15px;
            font-family: inherit;
            transition: border-color 0.2s;
        }

        .form-input:focus {
            outline: none;
            border-color: var(--primary);
        }

        .form-input::placeholder { color: var(--text-muted); }

        .form-select {
            appearance: none;
            background-image: url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' fill='none' viewBox='0 0 24 24' stroke='%2394A3B8'%3E%3Cpath stroke-linecap='round' stroke-linejoin='round' stroke-width='2' d='M19 9l-7 7-7-7'/%3E%3C/svg%3E");
            background-repeat: no-repeat;
            background-position: left 12px center;
            background-size: 20px;
            padding-left: 40px;
        }

        /* ===== STATS ===== */
        .stats-grid {
            display: grid;
            grid-template-columns: repeat(2, 1fr);
            gap: 12px;
            margin-bottom: 20px;
        }

        .stat-card {
            background: var(--bg-secondary);
            border: 1px solid var(--glass-border);
            border-radius: var(--radius-lg);
            padding: 16px;
            text-align: center;
        }

        .stat-icon { font-size: 28px; margin-bottom: 8px; }
        .stat-value { font-size: 20px; font-weight: 800; }
        .stat-label { font-size: 12px; color: var(--text-muted); margin-top: 4px; }

        .stat-card.success { border-color: var(--success); }
        .stat-card.success .stat-value { color: var(--success); }
        .stat-card.danger { border-color: var(--danger); }
        .stat-card.danger .stat-value { color: var(--danger); }
        .stat-card.warning { border-color: var(--warning); }
        .stat-card.warning .stat-value { color: var(--warning); }
        .stat-card.info { border-color: var(--info); }
        .stat-card.info .stat-value { color: var(--info); }

        /* ===== LIST ITEMS ===== */
        .list-item {
            display: flex;
            align-items: center;
            gap: 12px;
            padding: 12px;
            background: var(--bg-tertiary);
            border-radius: var(--radius);
            margin-bottom: 8px;
            cursor: pointer;
            transition: all 0.2s;
        }

        .list-item:hover { transform: translateX(-4px); }
        .list-item:active { transform: scale(0.98); }

        .list-icon {
            width: 44px;
            height: 44px;
            border-radius: var(--radius);
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 20px;
            background: var(--glass);
        }

        .list-content { flex: 1; min-width: 0; }
        .list-title { font-weight: 600; font-size: 14px; }
        .list-meta { font-size: 12px; color: var(--text-muted); }
        .list-amount { font-weight: 700; font-size: 14px; }
        .list-amount.positive { color: var(--success); }
        .list-amount.negative { color: var(--danger); }

        /* ===== EMPTY STATE ===== */
        .empty-state {
            text-align: center;
            padding: 40px 20px;
            color: var(--text-muted);
        }

        .empty-state .icon { font-size: 48px; margin-bottom: 12px; opacity: 0.5; }
        .empty-state p { font-size: 14px; }

        /* ===== AVATAR GRID ===== */
        .avatar-grid {
            display: grid;
            grid-template-columns: repeat(6, 1fr);
            gap: 8px;
        }

        .avatar-option {
            aspect-ratio: 1;
            display: flex;
            align-items: center;
            justify-content: center;
            background: var(--bg-tertiary);
            border: 2px solid var(--glass-border);
            border-radius: var(--radius);
            font-size: 24px;
            cursor: pointer;
            transition: all 0.2s;
        }

        .avatar-option:hover { transform: scale(1.1); }
        .avatar-option.selected {
            border-color: var(--primary);
            background: rgba(13, 148, 136, 0.2);
        }

        /* ===== CATEGORY GRID ===== */
        .category-grid {
            display: grid;
            grid-template-columns: repeat(3, 1fr);
            gap: 8px;
        }

        .category-option {
            display: flex;
            flex-direction: column;
            align-items: center;
            gap: 4px;
            padding: 12px 8px;
            background: var(--bg-tertiary);
            border: 2px solid var(--glass-border);
            border-radius: var(--radius);
            cursor: pointer;
            transition: all 0.2s;
        }

        .category-option:hover { border-color: var(--primary); }
        .category-option.selected {
            border-color: var(--primary);
            background: rgba(13, 148, 136, 0.2);
        }

        .category-option .icon { font-size: 24px; }
        .category-option .label { font-size: 11px; color: var(--text-secondary); }

        /* ===== TRIP HEADER ===== */
        .trip-header {
            background: linear-gradient(135deg, var(--primary-light), var(--primary), var(--primary-dark));
            border-radius: var(--radius-lg);
            padding: 24px;
            margin-bottom: 20px;
            color: white;
            position: relative;
            overflow: hidden;
        }

        .trip-header::before {
            content: 'ğŸï¸';
            position: absolute;
            top: -20px;
            left: -20px;
            font-size: 120px;
            opacity: 0.1;
        }

        .trip-name { font-size: 24px; font-weight: 800; margin-bottom: 8px; position: relative; }
        .trip-info { display: flex; gap: 16px; font-size: 14px; opacity: 0.9; margin-bottom: 16px; position: relative; }

        .trip-actions {
            display: flex;
            gap: 8px;
            position: relative;
        }

        .trip-actions .btn {
            flex: 1;
            background: rgba(255,255,255,0.2);
            color: white;
            font-size: 13px;
        }

        /* ===== MODAL ===== */
        .modal {
            display: none;
            position: fixed;
            inset: 0;
            background: rgba(0, 0, 0, 0.8);
            backdrop-filter: blur(8px);
            z-index: 1000;
            align-items: flex-end;
            justify-content: center;
        }

        .modal.active {
            display: flex;
            animation: fadeIn 0.2s ease;
        }

        .modal-content {
            background: var(--bg-secondary);
            border-radius: var(--radius-lg) var(--radius-lg) 0 0;
            width: 100%;
            max-width: 500px;
            max-height: 90vh;
            overflow: hidden;
            display: flex;
            flex-direction: column;
            animation: slideUp 0.3s cubic-bezier(0.16, 1, 0.3, 1);
        }

        @keyframes slideUp {
            from { transform: translateY(100%); }
            to { transform: translateY(0); }
        }

        .modal-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 20px;
            border-bottom: 1px solid var(--glass-border);
            background: var(--bg-tertiary);
        }

        .modal-title { font-size: 18px; font-weight: 700; }

        .modal-close {
            width: 36px;
            height: 36px;
            display: flex;
            align-items: center;
            justify-content: center;
            background: var(--glass);
            border: none;
            border-radius: 50%;
            color: var(--text-muted);
            font-size: 20px;
            cursor: pointer;
            transition: all 0.2s;
        }

        .modal-close:hover { background: var(--danger); color: white; }

        .modal-body {
            padding: 20px;
            overflow-y: auto;
            flex: 1;
        }

        .modal-footer {
            padding: 16px 20px;
            border-top: 1px solid var(--glass-border);
            background: var(--bg-tertiary);
        }

        .modal-center .modal-content {
            border-radius: var(--radius-lg);
            max-width: 360px;
            margin: auto;
        }

        /* ===== BOTTOM NAV ===== */
        .bottom-nav {
            position: fixed;
            bottom: 0;
            left: 0;
            right: 0;
            background: var(--bg-secondary);
            border-top: 1px solid var(--glass-border);
            display: none;
            justify-content: space-around;
            padding: 8px 0;
            padding-bottom: calc(8px + var(--safe-bottom));
            z-index: 100;
        }

        .nav-item {
            display: flex;
            flex-direction: column;
            align-items: center;
            gap: 2px;
            padding: 8px 16px;
            color: var(--text-muted);
            font-size: 11px;
            cursor: pointer;
            border: none;
            background: none;
            font-family: inherit;
            transition: color 0.2s;
        }

        .nav-item .icon { font-size: 22px; }
        .nav-item.active { color: var(--primary); }

        /* ===== FAB ===== */
        .fab {
            position: fixed;
            bottom: calc(80px + var(--safe-bottom));
            left: 50%;
            transform: translateX(-50%);
            width: 60px;
            height: 60px;
            border-radius: 50%;
            background: linear-gradient(135deg, var(--primary-light), var(--primary));
            color: white;
            border: none;
            font-size: 24px;
            cursor: pointer;
            box-shadow: 0 6px 25px rgba(13, 148, 136, 0.5);
            display: none;
            align-items: center;
            justify-content: center;
            z-index: 99;
            transition: all 0.2s;
        }

        .fab:active { transform: translateX(-50%) scale(0.95); }

        /* ===== SETTLEMENT ===== */
        .settlement-item {
            display: flex;
            align-items: center;
            gap: 12px;
            padding: 16px;
            background: var(--bg-tertiary);
            border-radius: var(--radius);
            margin-bottom: 10px;
        }

        .settlement-person { text-align: center; min-width: 60px; }
        .settlement-person .avatar { font-size: 28px; }
        .settlement-person .name { font-size: 11px; color: var(--text-muted); margin-top: 4px; }
        .settlement-arrow { flex: 1; text-align: center; }
        .settlement-arrow .amount { font-size: 16px; font-weight: 800; color: var(--success); }
        .settlement-arrow .icon { font-size: 20px; color: var(--primary); }

        /* ===== CHECKBOX ===== */
        .checkbox-item {
            display: flex;
            align-items: center;
            gap: 12px;
            padding: 12px;
            background: var(--bg-tertiary);
            border-radius: var(--radius);
            margin-bottom: 8px;
            cursor: pointer;
        }

        .checkbox-item input[type="checkbox"] {
            width: 20px;
            height: 20px;
            accent-color: var(--primary);
        }

        /* ===== SPLIT TOGGLE ===== */
        .split-toggle {
            display: flex;
            background: var(--bg-tertiary);
            border-radius: var(--radius-full);
            padding: 4px;
            margin-bottom: 12px;
        }

        .split-toggle-btn {
            flex: 1;
            padding: 10px;
            border: none;
            background: transparent;
            border-radius: var(--radius-full);
            font-size: 13px;
            font-weight: 600;
            font-family: inherit;
            color: var(--text-muted);
            cursor: pointer;
        }

        .split-toggle-btn.active {
            background: var(--primary);
            color: white;
        }

        /* ===== CUSTOM SPLIT ===== */
        .custom-split-item {
            display: flex;
            align-items: center;
            gap: 12px;
            padding: 10px;
            background: var(--bg-tertiary);
            border-radius: var(--radius);
            margin-bottom: 8px;
        }

        .custom-split-item .info { flex: 1; display: flex; align-items: center; gap: 8px; }
        .custom-split-item .avatar { font-size: 20px; }
        .custom-split-item .name { font-size: 14px; }
        .custom-split-item input {
            width: 100px;
            padding: 8px;
            background: var(--bg-secondary);
            border: 1px solid var(--glass-border);
            border-radius: var(--radius);
            color: var(--text-primary);
            font-family: inherit;
            font-size: 14px;
            text-align: center;
        }

        /* ===== RECENT TRIPS ===== */
        .recent-trip-item {
            display: flex;
            align-items: center;
            gap: 12px;
            padding: 14px;
            background: var(--bg-secondary);
            border: 1px solid var(--glass-border);
            border-radius: var(--radius);
            margin-bottom: 10px;
            cursor: pointer;
            transition: all 0.2s;
        }

        .recent-trip-item:hover { border-color: var(--primary); }

        .recent-trip-icon { font-size: 32px; }
        .recent-trip-info { flex: 1; }
        .recent-trip-name { font-weight: 600; font-size: 15px; }
        .recent-trip-meta { font-size: 12px; color: var(--text-muted); }

        /* ===== EXPENSE ITEM ===== */
        .expense-item {
            display: flex;
            align-items: center;
            gap: 12px;
            padding: 14px;
            background: var(--bg-tertiary);
            border-radius: var(--radius);
            margin-bottom: 10px;
            cursor: pointer;
            transition: all 0.2s;
        }

        .expense-item:hover { transform: translateX(-4px); }

        .expense-icon {
            width: 44px;
            height: 44px;
            border-radius: var(--radius);
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 22px;
            background: var(--glass);
        }

        .expense-info { flex: 1; }
        .expense-title { font-weight: 600; font-size: 14px; }
        .expense-meta { font-size: 12px; color: var(--text-muted); }
        .expense-amount { font-weight: 700; font-size: 15px; color: var(--primary); }

        /* ===== MEMBER ITEM ===== */
        .member-item {
            display: flex;
            align-items: center;
            gap: 12px;
            padding: 14px;
            background: var(--bg-tertiary);
            border-radius: var(--radius);
            margin-bottom: 10px;
            cursor: pointer;
        }

        .member-avatar { font-size: 36px; }
        .member-info { flex: 1; }
        .member-name { font-weight: 600; font-size: 15px; display: flex; align-items: center; gap: 6px; }
        .member-balance { font-size: 13px; }
        .member-balance.positive { color: var(--success); }
        .member-balance.negative { color: var(--danger); }
        .admin-badge { font-size: 14px; }

        /* ===== BALANCE ITEM ===== */
        .balance-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 10px 0;
            border-bottom: 1px solid var(--glass-border);
        }

        .balance-item:last-child { border-bottom: none; }

        .balance-info { display: flex; align-items: center; gap: 8px; }
        .balance-avatar { font-size: 20px; }
        .balance-name { font-size: 14px; }
        .balance-amount { font-weight: 700; font-size: 14px; }
        .balance-amount.positive { color: var(--success); }
        .balance-amount.negative { color: var(--danger); }

        /* ===== REPORT ===== */
        .report-stat-row {
            display: flex;
            justify-content: space-between;
            padding: 12px 0;
            border-bottom: 1px solid var(--glass-border);
            font-size: 14px;
        }

        .report-stat-row:last-child { border-bottom: none; }

        .top-spender-item {
            display: flex;
            align-items: center;
            gap: 10px;
            padding: 10px 0;
        }

        .top-spender-item .rank { font-size: 20px; }
        .top-spender-item .spender-avatar { font-size: 24px; }
        .top-spender-item .spender-name { flex: 1; font-size: 14px; }
        .top-spender-item .spender-amount { font-weight: 700; font-size: 14px; color: var(--primary); }

        /* ===== CHART ===== */
        .chart-container {
            position: relative;
            height: 250px;
        }

        /* ===== EXPENSE DETAIL ===== */
        .expense-detail-info {
            background: var(--bg-tertiary);
            border-radius: var(--radius);
            padding: 16px;
            margin: 16px 0;
        }

        .info-row {
            display: flex;
            justify-content: space-between;
            padding: 8px 0;
            font-size: 14px;
        }

        .split-members-list {
            background: var(--bg-tertiary);
            border-radius: var(--radius);
            padding: 12px;
        }

        .split-member-item {
            display: flex;
            justify-content: space-between;
            padding: 8px 0;
            font-size: 13px;
            border-bottom: 1px solid var(--glass-border);
        }

        .split-member-item:last-child { border-bottom: none; }

        /* ===== DIVIDER ===== */
        .divider {
            display: flex;
            align-items: center;
            gap: 12px;
            margin: 20px 0;
            color: var(--text-muted);
            font-size: 13px;
        }

        .divider::before, .divider::after {
            content: '';
            flex: 1;
            height: 1px;
            background: var(--glass-border);
        }

        /* ===== SETTINGS ===== */
        .settings-panel {
            position: fixed;
            top: 56px;
            right: 16px;
            background: var(--bg-secondary);
            border: 1px solid var(--glass-border);
            border-radius: var(--radius-lg);
            padding: 16px;
            min-width: 220px;
            box-shadow: var(--shadow-lg);
            z-index: 99;
            display: none;
        }

        .settings-panel.show { display: block; animation: fadeIn 0.2s ease; }

        .settings-section { margin-bottom: 16px; }
        .settings-section:last-child { margin-bottom: 0; }
        .settings-label { font-size: 13px; color: var(--text-muted); margin-bottom: 8px; }

        .theme-options {
            display: grid;
            grid-template-columns: repeat(5, 1fr);
            gap: 6px;
        }

        .theme-option {
            aspect-ratio: 1;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 18px;
            background: var(--glass);
            border: 2px solid var(--glass-border);
            border-radius: var(--radius);
            cursor: pointer;
        }

        .theme-option:hover { transform: scale(1.1); }
        .theme-option.active { border-color: var(--primary); }

        /* ===== FOOTER ===== */
        .footer-credit {
            text-align: center;
            padding: 30px;
            color: var(--text-muted);
            font-size: 12px;
        }

        .footer-credit strong { color: var(--primary); }

        /* ===== UTILITIES ===== */
        .btn-group { display: flex; gap: 8px; }
        .btn-group .btn { flex: 1; }
        .text-center { text-align: center; }
        .admin-only { display: none !important; }
        body.is-admin .admin-only { display: flex !important; }
    </style>
</head>
<body>
    <!-- Loading -->
    <div id="loadingOverlay" class="loading-overlay">
        <div class="loading-spinner"></div>
        <div class="loading-text">Ø¯Ø± Ø­Ø§Ù„ Ø¨Ø§Ø±Ú¯Ø°Ø§Ø±ÛŒ...</div>
    </div>

    <!-- Toast -->
    <div id="toast" class="toast"></div>

    <!-- Top Bar -->
    <header class="top-bar">
        <span class="top-bar-title">ğŸï¸ Ø³ÙØ±ÛŒÙ†Ùˆ</span>
        <div class="top-bar-actions">
            <button class="btn btn-ghost btn-icon" onclick="toggleSettings()">âš™ï¸</button>
        </div>
    </header>

    <!-- Settings Panel -->
    <div class="settings-panel" id="settingsPanel">
        <div class="settings-section">
            <div class="settings-label">ğŸ¨ ØªÙ…</div>
            <div class="theme-options">
                <button class="theme-option active" data-theme="night" onclick="setTheme('night')">ğŸŒ™</button>
                <button class="theme-option" data-theme="day" onclick="setTheme('day')">â˜€ï¸</button>
                <button class="theme-option" data-theme="sunset" onclick="setTheme('sunset')">ğŸŒ…</button>
                <button class="theme-option" data-theme="ocean" onclick="setTheme('ocean')">ğŸŒŠ</button>
                <button class="theme-option" data-theme="forest" onclick="setTheme('forest')">ğŸŒ²</button>
            </div>
        </div>
    </div>

    <!-- Welcome Screen -->
    <div id="welcomeScreen" class="screen active">
        <div class="container" style="padding-top: 80px; text-align: center;">
            <div style="font-size: 80px; margin-bottom: 20px;">ğŸï¸</div>
            <h1 style="font-size: 32px; font-weight: 800; margin-bottom: 8px;">Ø³ÙØ±ÛŒÙ†Ùˆ</h1>
            <p style="color: var(--text-muted); margin-bottom: 40px;">Ù…Ø¯ÛŒØ±ÛŒØª Ù‡Ø²ÛŒÙ†Ù‡â€ŒÙ‡Ø§ÛŒ Ø³ÙØ± Ú¯Ø±ÙˆÙ‡ÛŒ</p>
            
            <div style="margin-bottom: 30px;">
                <button class="btn btn-primary btn-lg" style="width: 100%; margin-bottom: 12px;" onclick="showModal('createTripModal')">
                    âœ¨ Ø§ÛŒØ¬Ø§Ø¯ Ø³ÙØ± Ø¬Ø¯ÛŒØ¯
                </button>
                <button class="btn btn-outline btn-lg" style="width: 100%;" onclick="showModal('joinTripModal')">
                    ğŸ”— Ù¾ÛŒÙˆØ³ØªÙ† Ø¨Ù‡ Ø³ÙØ±
                </button>
            </div>

            <div id="recentTrips" style="display: none;">
                <div class="divider">Ø³ÙØ±Ù‡Ø§ÛŒ Ø§Ø®ÛŒØ±</div>
                <div id="recentTripsList"></div>
            </div>

            <div class="footer-credit">
                <p>Ø·Ø±Ø§Ø­ÛŒ Ùˆ ØªÙˆØ³Ø¹Ù‡ Ø¨Ø§ â¤ï¸</p>
                <p><strong>Ù…Ø­Ù…Ø¯ Ø¹Ø¨Ø§Ø³ÛŒ</strong></p>
            </div>
        </div>
    </div>

    <!-- Home Screen -->
    <div id="homeScreen" class="screen">
        <div class="container" style="padding-top: 70px;">
            <div class="trip-header">
                <h1 class="trip-name" id="tripNameDisplay">Ø³ÙØ±</h1>
                <div class="trip-info">
                    <span>ğŸ‘¥ <span id="memberCountDisplay">0</span> Ù†ÙØ±</span>
                    <span>ğŸ“… <span id="tripDateDisplay">-</span></span>
                </div>
                <div class="trip-actions admin-only">
                    <button class="btn" onclick="showModal('editTripModal')">âœï¸ ÙˆÛŒØ±Ø§ÛŒØ´</button>
                    <button class="btn" onclick="shareTripCode()">ğŸ“¤ Ø§Ø´ØªØ±Ø§Ú©</button>
                </div>
            </div>

            <div class="stats-grid">
                <div class="stat-card success">
                    <span class="stat-icon">ğŸ’°</span>
                    <div class="stat-value" id="totalExpenses">Û°</div>
                    <div class="stat-label">Ú©Ù„ Ù‡Ø²ÛŒÙ†Ù‡â€ŒÙ‡Ø§</div>
                </div>
                <div class="stat-card info">
                    <span class="stat-icon">ğŸ‘¤</span>
                    <div class="stat-value" id="perPersonAvg">Û°</div>
                    <div class="stat-label">Ø³Ù‡Ù… Ù‡Ø± Ù†ÙØ±</div>
                </div>
                <div class="stat-card warning">
                    <span class="stat-icon">ğŸ§¾</span>
                    <div class="stat-value" id="expenseCount">Û°</div>
                    <div class="stat-label">ØªØ¹Ø¯Ø§Ø¯ Ù‡Ø²ÛŒÙ†Ù‡</div>
                </div>
                <div class="stat-card" id="myBalanceCard">
                    <span class="stat-icon">âš–ï¸</span>
                    <div class="stat-value" id="myBalance">Û°</div>
                    <div class="stat-label">ÙˆØ¶Ø¹ÛŒØª Ù…Ù†</div>
                </div>
            </div>

            <div class="card">
                <div class="card-header">
                    <h3 class="card-title">ğŸ“Š ÙˆØ¶Ø¹ÛŒØª Ø§Ø¹Ø¶Ø§</h3>
                </div>
                <div id="quickBalanceList"></div>
            </div>

            <div class="card">
                <div class="card-header">
                    <h3 class="card-title">ğŸ• Ø¢Ø®Ø±ÛŒÙ† Ù‡Ø²ÛŒÙ†Ù‡â€ŒÙ‡Ø§</h3>
                    <button class="btn btn-sm btn-outline" onclick="switchTab('expenses')">Ù‡Ù…Ù‡</button>
                </div>
                <div id="recentExpensesList"></div>
            </div>

            <div class="footer-credit">
                <p>Ø·Ø±Ø§Ø­ÛŒ: <strong>Ù…Ø­Ù…Ø¯ Ø¹Ø¨Ø§Ø³ÛŒ</strong></p>
            </div>
        </div>
    </div>

    <!-- Expenses Screen -->
    <div id="expensesScreen" class="screen">
        <div class="container" style="padding-top: 70px;">
            <div class="card">
                <div class="card-header">
                    <h3 class="card-title">ğŸ§¾ Ù„ÛŒØ³Øª Ù‡Ø²ÛŒÙ†Ù‡â€ŒÙ‡Ø§</h3>
                    <span class="card-badge" id="expensesBadge">0</span>
                </div>
                <div id="expensesList"></div>
            </div>
        </div>
    </div>

    <!-- Members Screen -->
    <div id="membersScreen" class="screen">
        <div class="container" style="padding-top: 70px;">
            <div class="card">
                <div class="card-header">
                    <h3 class="card-title">ğŸ‘¥ Ø§Ø¹Ø¶Ø§ÛŒ Ø³ÙØ±</h3>
                    <button class="btn btn-sm btn-primary admin-only" onclick="showModal('addMemberModal')">+ Ø¹Ø¶Ùˆ</button>
                </div>
                <div id="membersList"></div>
            </div>

            <div class="card">
                <div class="card-header">
                    <h3 class="card-title">ğŸ’¸ ØªØ³ÙˆÛŒÙ‡ Ø­Ø³Ø§Ø¨</h3>
                </div>
                <div id="settlementList"></div>
            </div>
        </div>
    </div>

    <!-- Reports Screen -->
    <div id="reportsScreen" class="screen">
        <div class="container" style="padding-top: 70px;">
            <div class="card">
                <div class="card-header">
                    <h3 class="card-title">ğŸ“Š Ù†Ù…ÙˆØ¯Ø§Ø± Ù‡Ø²ÛŒÙ†Ù‡â€ŒÙ‡Ø§</h3>
                </div>
                <div class="chart-container">
                    <canvas id="expenseChart"></canvas>
                </div>
            </div>

            <div class="card">
                <div class="card-header">
                    <h3 class="card-title">ğŸ“ˆ Ø¢Ù…Ø§Ø± Ú©Ù„ÛŒ</h3>
                </div>
                <div id="reportStats"></div>
            </div>

            <div class="card">
                <div class="card-header">
                    <h3 class="card-title">ğŸ† Ø¨ÛŒØ´ØªØ±ÛŒÙ† Ù¾Ø±Ø¯Ø§Ø®Øª</h3>
                </div>
                <div id="topSpenders"></div>
            </div>

            <button class="btn btn-primary btn-lg" style="width: 100%; margin-top: 16px;" onclick="exportToPDF()">
                ğŸ“¥ Ø¯Ø§Ù†Ù„ÙˆØ¯ Ú¯Ø²Ø§Ø±Ø´ PDF
            </button>
        </div>
    </div>

    <!-- FAB -->
    <button class="fab admin-only" id="fabBtn" onclick="showModal('addExpenseModal')">â•</button>

    <!-- Bottom Nav -->
    <nav class="bottom-nav" id="bottomNav">
        <button class="nav-item active" data-tab="home" onclick="switchTab('home')">
            <span class="icon">ğŸ </span>
            <span>Ø®Ø§Ù†Ù‡</span>
        </button>
        <button class="nav-item" data-tab="expenses" onclick="switchTab('expenses')">
            <span class="icon">ğŸ§¾</span>
            <span>Ù‡Ø²ÛŒÙ†Ù‡â€ŒÙ‡Ø§</span>
        </button>
        <button class="nav-item" data-tab="members" onclick="switchTab('members')">
            <span class="icon">ğŸ‘¥</span>
            <span>Ø§Ø¹Ø¶Ø§</span>
        </button>
        <button class="nav-item" data-tab="reports" onclick="switchTab('reports')">
            <span class="icon">ğŸ“Š</span>
            <span>Ú¯Ø²Ø§Ø±Ø´</span>
        </button>
    </nav>

    <!-- Create Trip Modal -->
    <div id="createTripModal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h3 class="modal-title">âœ¨ Ø§ÛŒØ¬Ø§Ø¯ Ø³ÙØ± Ø¬Ø¯ÛŒØ¯</h3>
                <button class="modal-close" onclick="hideModal('createTripModal')">Ã—</button>
            </div>
            <div class="modal-body">
                <div class="form-group">
                    <label class="form-label">ğŸ·ï¸ Ù†Ø§Ù… Ø³ÙØ± <span class="required">*</span></label>
                    <input type="text" class="form-input" id="newTripName" placeholder="Ù…Ø«Ù„Ø§Ù‹: Ø³ÙØ± Ø´Ù…Ø§Ù„">
                </div>
                <div class="form-group">
                    <label class="form-label">ğŸ“… ØªØ§Ø±ÛŒØ®</label>
                    <input type="text" class="form-input" id="newTripDate" placeholder="Ù…Ø«Ù„Ø§Ù‹: Û±Ûµ Ø¯ÛŒ Û±Û´Û°Û³">
                </div>
                <div class="form-group">
                    <label class="form-label">ğŸ‘¤ Ù†Ø§Ù… Ø´Ù…Ø§ <span class="required">*</span></label>
                    <input type="text" class="form-input" id="adminName" placeholder="Ù†Ø§Ù… Ø´Ù…Ø§">
                </div>
                <div class="form-group">
                    <label class="form-label">ğŸ˜Š Ø¢ÙˆØ§ØªØ§Ø±</label>
                    <div class="avatar-grid" id="adminAvatarGrid"></div>
                </div>
            </div>
            <div class="modal-footer">
                <button class="btn btn-primary btn-lg" style="width: 100%;" onclick="createTrip()">ğŸš€ Ø§ÛŒØ¬Ø§Ø¯ Ø³ÙØ±</button>
            </div>
        </div>
    </div>

    <!-- Join Trip Modal -->
    <div id="joinTripModal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h3 class="modal-title">ğŸ”— Ù¾ÛŒÙˆØ³ØªÙ† Ø¨Ù‡ Ø³ÙØ±</h3>
                <button class="modal-close" onclick="hideModal('joinTripModal')">Ã—</button>
            </div>
            <div class="modal-body">
                <div class="form-group">
                    <label class="form-label">ğŸ”‘ Ú©Ø¯ Ø³ÙØ± <span class="required">*</span></label>
                    <input type="text" class="form-input" id="joinTripCode" placeholder="Ú©Ø¯ Û¶ Ø±Ù‚Ù…ÛŒ" style="text-align: center; font-size: 20px; letter-spacing: 6px;">
                </div>
                <div class="form-group">
                    <label class="form-label">ğŸ‘¤ Ù†Ø§Ù… Ø´Ù…Ø§ <span class="required">*</span></label>
                    <input type="text" class="form-input" id="joinMemberName" placeholder="Ù†Ø§Ù… Ø´Ù…Ø§">
                </div>
                <div class="form-group">
                    <label class="form-label">ğŸ˜Š Ø¢ÙˆØ§ØªØ§Ø±</label>
                    <div class="avatar-grid" id="joinAvatarGrid"></div>
                </div>
            </div>
            <div class="modal-footer">
                <button class="btn btn-primary btn-lg" style="width: 100%;" onclick="joinTrip()">ğŸ‰ Ù¾ÛŒÙˆØ³ØªÙ†</button>
            </div>
        </div>
    </div>

    <!-- Edit Trip Modal -->
    <div id="editTripModal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h3 class="modal-title">âœï¸ ÙˆÛŒØ±Ø§ÛŒØ´ Ø³ÙØ±</h3>
                <button class="modal-close" onclick="hideModal('editTripModal')">Ã—</button>
            </div>
            <div class="modal-body">
                <div class="form-group">
                    <label class="form-label">ğŸ·ï¸ Ù†Ø§Ù… Ø³ÙØ±</label>
                    <input type="text" class="form-input" id="editTripName">
                </div>
                <div class="form-group">
                    <label class="form-label">ğŸ“… ØªØ§Ø±ÛŒØ®</label>
                    <input type="text" class="form-input" id="editTripDate">
                </div>
                <div class="divider">âš ï¸ Ù…Ù†Ø·Ù‚Ù‡ Ø®Ø·Ø±</div>
                <button class="btn btn-danger" style="width: 100%;" onclick="confirmDeleteTrip()">ğŸ—‘ï¸ Ø­Ø°Ù Ø³ÙØ±</button>
            </div>
            <div class="modal-footer">
                <button class="btn btn-primary btn-lg" style="width: 100%;" onclick="saveTrip()">ğŸ’¾ Ø°Ø®ÛŒØ±Ù‡</button>
            </div>
        </div>
    </div>

    <!-- Add Expense Modal -->
    <div id="addExpenseModal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h3 class="modal-title">â• Ù‡Ø²ÛŒÙ†Ù‡ Ø¬Ø¯ÛŒØ¯</h3>
                <button class="modal-close" onclick="hideModal('addExpenseModal')">Ã—</button>
            </div>
            <div class="modal-body">
                <div class="form-group">
                    <label class="form-label">ğŸ“ Ø¹Ù†ÙˆØ§Ù† <span class="required">*</span></label>
                    <input type="text" class="form-input" id="expenseTitle" placeholder="Ù…Ø«Ù„Ø§Ù‹: Ù†Ø§Ù‡Ø§Ø± Ø±Ø³ØªÙˆØ±Ø§Ù†">
                </div>
                <div class="form-group">
                    <label class="form-label">ğŸ’µ Ù…Ø¨Ù„Øº (ØªÙˆÙ…Ø§Ù†) <span class="required">*</span></label>
                    <input type="text" class="form-input" id="expenseAmount" placeholder="Û°" inputmode="numeric">
                </div>
                <div class="form-group">
                    <label class="form-label">ğŸ·ï¸ Ø¯Ø³ØªÙ‡â€ŒØ¨Ù†Ø¯ÛŒ</label>
                    <div class="category-grid" id="categoryGrid"></div>
                </div>
                <div class="form-group">
                    <label class="form-label">ğŸ’³ Ù¾Ø±Ø¯Ø§Ø®Øªâ€ŒÚ©Ù†Ù†Ø¯Ù‡</label>
                    <select class="form-input form-select" id="expensePayer"></select>
                </div>
                <div class="form-group">
                    <label class="form-label">ğŸ‘¥ ØªÙ‚Ø³ÛŒÙ… Ø¨ÛŒÙ†</label>
                    <div class="split-toggle">
                        <button type="button" class="split-toggle-btn active" data-split="equal" onclick="setSplitType('equal')">Ù…Ø³Ø§ÙˆÛŒ</button>
                        <button type="button" class="split-toggle-btn" data-split="custom" onclick="setSplitType('custom')">Ø³ÙØ§Ø±Ø´ÛŒ</button>
                    </div>
                    <div id="splitEqualSection">
                        <div id="splitMembersList"></div>
                    </div>
                    <div id="splitCustomSection" style="display: none;">
                        <div id="customSplitList"></div>
                    </div>
                </div>
            </div>
            <div class="modal-footer">
                <button class="btn btn-primary btn-lg" style="width: 100%;" onclick="saveExpense()">âœ… Ø«Ø¨Øª Ù‡Ø²ÛŒÙ†Ù‡</button>
            </div>
        </div>
    </div>

    <!-- Expense Detail Modal -->
    <div id="expenseDetailModal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h3 class="modal-title">ğŸ“‹ Ø¬Ø²Ø¦ÛŒØ§Øª Ù‡Ø²ÛŒÙ†Ù‡</h3>
                <button class="modal-close" onclick="hideModal('expenseDetailModal')">Ã—</button>
            </div>
            <div class="modal-body" id="expenseDetailContent"></div>
            <div class="modal-footer admin-only">
                <div class="btn-group">
                    <button class="btn btn-outline" onclick="editCurrentExpense()">âœï¸ ÙˆÛŒØ±Ø§ÛŒØ´</button>
                    <button class="btn btn-danger" onclick="deleteCurrentExpense()">ğŸ—‘ï¸ Ø­Ø°Ù</button>
                </div>
            </div>
        </div>
    </div>

    <!-- Edit Expense Modal -->
    <div id="editExpenseModal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h3 class="modal-title">âœï¸ ÙˆÛŒØ±Ø§ÛŒØ´ Ù‡Ø²ÛŒÙ†Ù‡</h3>
                <button class="modal-close" onclick="hideModal('editExpenseModal')">Ã—</button>
            </div>
            <div class="modal-body">
                <input type="hidden" id="editExpenseId">
                <div class="form-group">
                    <label class="form-label">ğŸ“ Ø¹Ù†ÙˆØ§Ù†</label>
                    <input type="text" class="form-input" id="editExpenseTitle">
                </div>
                <div class="form-group">
                    <label class="form-label">ğŸ’µ Ù…Ø¨Ù„Øº (ØªÙˆÙ…Ø§Ù†)</label>
                    <input type="text" class="form-input" id="editExpenseAmount" inputmode="numeric">
                </div>
                <div class="form-group">
                    <label class="form-label">ğŸ·ï¸ Ø¯Ø³ØªÙ‡â€ŒØ¨Ù†Ø¯ÛŒ</label>
                    <div class="category-grid" id="editCategoryGrid"></div>
                </div>
                <div class="form-group">
                    <label class="form-label">ğŸ’³ Ù¾Ø±Ø¯Ø§Ø®Øªâ€ŒÚ©Ù†Ù†Ø¯Ù‡</label>
                    <select class="form-input form-select" id="editExpensePayer"></select>
                </div>
            </div>
            <div class="modal-footer">
                <button class="btn btn-primary btn-lg" style="width: 100%;" onclick="updateExpense()">ğŸ’¾ Ø°Ø®ÛŒØ±Ù‡</button>
            </div>
        </div>
    </div>

    <!-- Add Member Modal -->
    <div id="addMemberModal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h3 class="modal-title">ğŸ‘¤ Ø§ÙØ²ÙˆØ¯Ù† Ø¹Ø¶Ùˆ</h3>
                <button class="modal-close" onclick="hideModal('addMemberModal')">Ã—</button>
            </div>
            <div class="modal-body">
                <div class="form-group">
                    <label class="form-label">ğŸ‘¤ Ù†Ø§Ù… Ø¹Ø¶Ùˆ <span class="required">*</span></label>
                    <input type="text" class="form-input" id="newMemberName" placeholder="Ù†Ø§Ù… Ø¹Ø¶Ùˆ Ø¬Ø¯ÛŒØ¯">
                </div>
                <div class="form-group">
                    <label class="form-label">ğŸ˜Š Ø¢ÙˆØ§ØªØ§Ø±</label>
                    <div class="avatar-grid" id="newMemberAvatarGrid"></div>
                </div>
            </div>
            <div class="modal-footer">
                <button class="btn btn-primary btn-lg" style="width: 100%;" onclick="addMember()">â• Ø§ÙØ²ÙˆØ¯Ù†</button>
            </div>
        </div>
    </div>

    <!-- Member Detail Modal -->
    <div id="memberDetailModal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h3 class="modal-title">ğŸ‘¤ Ø¬Ø²Ø¦ÛŒØ§Øª Ø¹Ø¶Ùˆ</h3>
                <button class="modal-close" onclick="hideModal('memberDetailModal')">Ã—</button>
            </div>
            <div class="modal-body" id="memberDetailContent"></div>
            <div class="modal-footer admin-only">
                <div class="btn-group">
                    <button class="btn btn-outline" onclick="editCurrentMember()">âœï¸ ÙˆÛŒØ±Ø§ÛŒØ´</button>
                    <button class="btn btn-danger" onclick="removeCurrentMember()">ğŸšª Ø­Ø°Ù</button>
                </div>
            </div>
        </div>
    </div>

    <!-- Edit Member Modal -->
    <div id="editMemberModal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h3 class="modal-title">âœï¸ ÙˆÛŒØ±Ø§ÛŒØ´ Ø¹Ø¶Ùˆ</h3>
                <button class="modal-close" onclick="hideModal('editMemberModal')">Ã—</button>
            </div>
            <div class="modal-body">
                <input type="hidden" id="editMemberId">
                <div class="form-group">
                    <label class="form-label">ğŸ‘¤ Ù†Ø§Ù…</label>
                    <input type="text" class="form-input" id="editMemberName">
                </div>
                <div class="form-group">
                    <label class="form-label">ğŸ˜Š Ø¢ÙˆØ§ØªØ§Ø±</label>
                    <div class="avatar-grid" id="editMemberAvatarGrid"></div>
                </div>
            </div>
            <div class="modal-footer">
                <button class="btn btn-primary btn-lg" style="width: 100%;" onclick="updateMember()">ğŸ’¾ Ø°Ø®ÛŒØ±Ù‡</button>
            </div>
        </div>
    </div>

    <!-- Share Modal -->
    <div id="shareModal" class="modal modal-center">
        <div class="modal-content">
            <div class="modal-header">
                <h3 class="modal-title">ğŸ“¤ Ú©Ø¯ Ø³ÙØ±</h3>
                <button class="modal-close" onclick="hideModal('shareModal')">Ã—</button>
            </div>
            <div class="modal-body" style="text-align: center;">
                <p style="margin-bottom: 16px; color: var(--text-muted);">Ø§ÛŒÙ† Ú©Ø¯ Ø±Ø§ Ø¨Ø±Ø§ÛŒ Ø¯ÙˆØ³ØªØ§Ù†ØªØ§Ù† Ø¨ÙØ±Ø³ØªÛŒØ¯:</p>
                <div style="font-size: 32px; font-weight: 800; letter-spacing: 8px; color: var(--primary); margin-bottom: 20px; font-family: monospace;" id="shareCodeDisplay"></div>
                <button class="btn btn-primary" onclick="copyTripCode()">ğŸ“‹ Ú©Ù¾ÛŒ Ú©Ø¯</button>
            </div>
        </div>
    </div>

    <!-- Confirm Modal -->
    <div id="confirmModal" class="modal modal-center">
        <div class="modal-content">
            <div class="modal-header">
                <h3 class="modal-title" id="confirmTitle">âš ï¸ ØªØ£ÛŒÛŒØ¯</h3>
                <button class="modal-close" onclick="hideModal('confirmModal')">Ã—</button>
            </div>
            <div class="modal-body" style="text-align: center;">
                <p id="confirmMessage" style="color: var(--text-muted);"></p>
            </div>
            <div class="modal-footer">
                <div class="btn-group">
                    <button class="btn btn-outline" onclick="hideModal('confirmModal')">Ø§Ù†ØµØ±Ø§Ù</button>
                    <button class="btn btn-danger" id="confirmBtn">ØªØ£ÛŒÛŒØ¯</button>
                </div>
            </div>
        </div>
    </div>

    <script>
        // ========== CONSTANTS ==========
        const AVATARS = ['ğŸ˜€', 'ğŸ˜', 'ğŸ¤©', 'ğŸ˜Š', 'ğŸ¥³', 'ğŸ˜‡', 'ğŸ¤ ', 'ğŸ§‘â€ğŸ’¼', 'ğŸ‘¨â€ğŸ¨', 'ğŸ‘©â€ğŸš€', 'ğŸ§™â€â™‚ï¸', 'ğŸ¦¸â€â™€ï¸'];
        const CATEGORIES = [
            { id: 'food', name: 'ØºØ°Ø§', icon: 'ğŸ•' },
            { id: 'transport', name: 'Ø­Ù…Ù„â€ŒÙˆÙ†Ù‚Ù„', icon: 'ğŸš—' },
            { id: 'stay', name: 'Ø§Ù‚Ø§Ù…Øª', icon: 'ğŸ¨' },
            { id: 'shopping', name: 'Ø®Ø±ÛŒØ¯', icon: 'ğŸ›ï¸' },
            { id: 'fun', name: 'ØªÙØ±ÛŒØ­', icon: 'ğŸ¢' },
            { id: 'other', name: 'Ø³Ø§ÛŒØ±', icon: 'ğŸ“¦' }
        ];

        // ========== STATE ==========
        let currentTrip = null;
        let currentUser = null;
        let selectedAvatar = 'ğŸ˜€';
        let selectedCategory = 'food';
        let selectedEditCategory = 'food';
        let splitType = 'equal';
        let currentExpenseId = null;
        let currentMemberId = null;
        let expenseChart = null;

        // ========== UTILITIES ==========
        const generateId = () => Date.now().toString(36) + Math.random().toString(36).substr(2);
        const generateTripCode = () => Math.random().toString(36).substr(2, 6).toUpperCase();
        
        const toPersian = (num) => String(num).replace(/[0-9]/g, d => 'Û°Û±Û²Û³Û´ÛµÛ¶Û·Û¸Û¹'[d]);
        const formatNumber = (num) => num ? toPersian(num.toLocale
                                                      String('fa-IR')) : 'Û°';
        const parseNumber = (str) => parseInt(String(str).replace(/[^\d]/g, '')) || 0;

        function showToast(msg, type = 'info') {
            const toast = document.getElementById('toast');
            toast.textContent = msg;
            toast.className = `toast show ${type}`;
            setTimeout(() => toast.classList.remove('show'), 3000);
        }

        function showModal(id) {
            document.getElementById(id).classList.add('active');
            document.body.style.overflow = 'hidden';
        }

        function hideModal(id) {
            document.getElementById(id).classList.remove('active');
            document.body.style.overflow = '';
        }

        function hideLoading() {
            document.getElementById('loadingOverlay').classList.add('hide');
        }

        function showLoading() {
            document.getElementById('loadingOverlay').classList.remove('hide');
        }

        function toggleSettings() {
            document.getElementById('settingsPanel').classList.toggle('show');
        }

        function setTheme(theme) {
            document.documentElement.setAttribute('data-theme', theme);
            localStorage.setItem('theme', theme);
            document.querySelectorAll('.theme-option').forEach(btn => {
                btn.classList.toggle('active', btn.dataset.theme === theme);
            });
            document.getElementById('settingsPanel').classList.remove('show');
        }

        function isAdmin() {
            return currentTrip && currentUser && currentTrip.adminId === currentUser.id;
        }

        function updateAdminUI() {
            document.body.classList.toggle('is-admin', isAdmin());
        }

        // ========== STORAGE ==========
        function saveToStorage() {
            if (currentTrip) {
                localStorage.setItem(`trip_${currentTrip.code}`, JSON.stringify(currentTrip));
                
                let recent = JSON.parse(localStorage.getItem('recentTrips') || '[]');
                const idx = recent.findIndex(t => t.code === currentTrip.code);
                const info = {
                    code: currentTrip.code,
                    name: currentTrip.name,
                    date: currentTrip.date,
                    memberCount: currentTrip.members.length,
                    lastAccess: Date.now()
                };
                
                if (idx >= 0) recent[idx] = info;
                else recent.unshift(info);
                
                localStorage.setItem('recentTrips', JSON.stringify(recent.slice(0, 5)));
            }
            if (currentUser) {
                localStorage.setItem('currentUser', JSON.stringify(currentUser));
            }
        }

        function loadFromStorage(code) {
            const data = localStorage.getItem(`trip_${code}`);
            return data ? JSON.parse(data) : null;
        }

        // ========== NAVIGATION ==========
        function switchTab(tab) {
            document.querySelectorAll('.screen').forEach(s => s.classList.remove('active'));
            document.querySelectorAll('.nav-item').forEach(n => n.classList.remove('active'));
            
            document.getElementById(`${tab}Screen`).classList.add('active');
            document.querySelector(`.nav-item[data-tab="${tab}"]`)?.classList.add('active');
            
            if (tab === 'reports') setTimeout(renderChart, 100);
        }

        function showTripScreen() {
            document.getElementById('welcomeScreen').classList.remove('active');
            document.getElementById('homeScreen').classList.add('active');
            document.getElementById('bottomNav').style.display = 'flex';
            document.getElementById('fabBtn').style.display = 'flex';
            
            updateAdminUI();
            renderAll();
        }

        function showWelcomeScreen() {
            currentTrip = null;
            currentUser = null;
            
            document.querySelectorAll('.screen').forEach(s => s.classList.remove('active'));
            document.getElementById('welcomeScreen').classList.add('active');
            document.getElementById('bottomNav').style.display = 'none';
            document.getElementById('fabBtn').style.display = 'none';
            
            loadRecentTrips();
        }

        // ========== AVATARS ==========
        function renderAvatarGrid(containerId, selected = 'ğŸ˜€') {
            const container = document.getElementById(containerId);
            if (!container) return;
            
            container.innerHTML = AVATARS.map(a => `
                <div class="avatar-option ${a === selected ? 'selected' : ''}" onclick="selectAvatar('${containerId}', '${a}')">${a}</div>
            `).join('');
        }

        function selectAvatar(containerId, avatar) {
            selectedAvatar = avatar;
            document.querySelectorAll(`#${containerId} .avatar-option`).forEach(el => {
                el.classList.toggle('selected', el.textContent === avatar);
            });
        }

        // ========== CATEGORIES ==========
        function renderCategoryGrid(containerId, selected = 'food') {
            const container = document.getElementById(containerId);
            if (!container) return;
            
            container.innerHTML = CATEGORIES.map(c => `
                <div class="category-option ${c.id === selected ? 'selected' : ''}" onclick="selectCategory('${containerId}', '${c.id}')">
                    <span class="icon">${c.icon}</span>
                    <span class="label">${c.name}</span>
                </div>
            `).join('');
        }

        function selectCategory(containerId, catId) {
            if (containerId === 'editCategoryGrid') selectedEditCategory = catId;
            else selectedCategory = catId;
            
            document.querySelectorAll(`#${containerId} .category-option`).forEach(el => {
                const cat = CATEGORIES.find(c => c.icon === el.querySelector('.icon').textContent);
                el.classList.toggle('selected', cat && cat.id === catId);
            });
        }

        function getCategoryInfo(catId) {
            return CATEGORIES.find(c => c.id === catId) || CATEGORIES[5];
        }

        // ========== RECENT TRIPS ==========
        function loadRecentTrips() {
            const recent = JSON.parse(localStorage.getItem('recentTrips') || '[]');
            const container = document.getElementById('recentTripsList');
            const wrapper = document.getElementById('recentTrips');
            
            if (recent.length === 0) {
                wrapper.style.display = 'none';
                return;
            }
            
            wrapper.style.display = 'block';
            container.innerHTML = recent.map(trip => `
                <div class="recent-trip-item" onclick="loadTrip('${trip.code}')">
                    <div class="recent-trip-icon">ğŸï¸</div>
                    <div class="recent-trip-info">
                        <div class="recent-trip-name">${trip.name}</div>
                        <div class="recent-trip-meta">ğŸ‘¥ ${toPersian(trip.memberCount)} Ù†ÙØ± â€¢ ${trip.date || 'Ø¨Ø¯ÙˆÙ† ØªØ§Ø±ÛŒØ®'}</div>
                    </div>
                </div>
            `).join('');
        }

        function loadTrip(code) {
            showLoading();
            
            setTimeout(() => {
                const trip = loadFromStorage(code);
                const savedUser = JSON.parse(localStorage.getItem('currentUser') || 'null');
                
                if (!trip) {
                    hideLoading();
                    showToast('Ø³ÙØ± ÛŒØ§ÙØª Ù†Ø´Ø¯', 'error');
                    return;
                }

                currentTrip = trip;
                currentUser = (savedUser && trip.members.find(m => m.id === savedUser.id)) 
                    ? savedUser 
                    : trip.members[0];

                hideLoading();
                showTripScreen();
            }, 300);
        }

        // ========== TRIP MANAGEMENT ==========
        function createTrip() {
            const name = document.getElementById('newTripName').value.trim();
            const date = document.getElementById('newTripDate').value.trim();
            const adminName = document.getElementById('adminName').value.trim();

            if (!name || !adminName) {
                showToast('Ù†Ø§Ù… Ø³ÙØ± Ùˆ Ù†Ø§Ù… Ø®ÙˆØ¯ Ø±Ø§ ÙˆØ§Ø±Ø¯ Ú©Ù†ÛŒØ¯', 'error');
                return;
            }

            showLoading();

            setTimeout(() => {
                const tripCode = generateTripCode();
                const adminId = generateId();

                currentUser = {
                    id: adminId,
                    name: adminName,
                    avatar: selectedAvatar,
                    joinedAt: Date.now()
                };

                currentTrip = {
                    code: tripCode,
                    name: name,
                    date: date || 'Ø¨Ø¯ÙˆÙ† ØªØ§Ø±ÛŒØ®',
                    adminId: adminId,
                    members: [currentUser],
                    expenses: [],
                    createdAt: Date.now()
                };

                saveToStorage();
                hideLoading();
                hideModal('createTripModal');
                showTripScreen();
                showToast('Ø³ÙØ± Ø§ÛŒØ¬Ø§Ø¯ Ø´Ø¯! ğŸ‰', 'success');
                
                setTimeout(() => {
                    document.getElementById('shareCodeDisplay').textContent = tripCode;
                    showModal('shareModal');
                }, 500);
            }, 500);
        }

        function joinTrip() {
            const code = document.getElementById('joinTripCode').value.trim().toUpperCase();
            const memberName = document.getElementById('joinMemberName').value.trim();

            if (!code || !memberName) {
                showToast('Ú©Ø¯ Ø³ÙØ± Ùˆ Ù†Ø§Ù… Ø®ÙˆØ¯ Ø±Ø§ ÙˆØ§Ø±Ø¯ Ú©Ù†ÛŒØ¯', 'error');
                return;
            }

            showLoading();

            setTimeout(() => {
                const trip = loadFromStorage(code);
                
                if (!trip) {
                    hideLoading();
                    showToast('Ø³ÙØ± ÛŒØ§ÙØª Ù†Ø´Ø¯', 'error');
                    return;
                }

                const existing = trip.members.find(m => m.name === memberName);
                if (existing) {
                    currentUser = existing;
                } else {
                    currentUser = {
                        id: generateId(),
                        name: memberName,
                        avatar: selectedAvatar,
                        joinedAt: Date.now()
                    };
                    trip.members.push(currentUser);
                }

                currentTrip = trip;
                saveToStorage();
                hideLoading();
                hideModal('joinTripModal');
                showTripScreen();
                showToast(`Ø¨Ù‡ "${trip.name}" Ø®ÙˆØ´ Ø¢Ù…Ø¯ÛŒØ¯! ğŸ‰`, 'success');
            }, 500);
        }

        function saveTrip() {
            if (!currentTrip) return;
            
            currentTrip.name = document.getElementById('editTripName').value.trim() || currentTrip.name;
            currentTrip.date = document.getElementById('editTripDate').value.trim() || currentTrip.date;
            
            saveToStorage();
            hideModal('editTripModal');
            renderAll();
            showToast('Ø°Ø®ÛŒØ±Ù‡ Ø´Ø¯', 'success');
        }

        function confirmDeleteTrip() {
            document.getElementById('confirmTitle').textContent = 'âš ï¸ Ø­Ø°Ù Ø³ÙØ±';
            document.getElementById('confirmMessage').textContent = 'ØªÙ…Ø§Ù… Ø§Ø·Ù„Ø§Ø¹Ø§Øª Ø­Ø°Ù Ù…ÛŒâ€ŒØ´ÙˆØ¯. Ù…Ø·Ù…Ø¦Ù†ÛŒØ¯ØŸ';
            document.getElementById('confirmBtn').onclick = deleteTrip;
            showModal('confirmModal');
        }

        function deleteTrip() {
            localStorage.removeItem(`trip_${currentTrip.code}`);
            
            let recent = JSON.parse(localStorage.getItem('recentTrips') || '[]');
            recent = recent.filter(t => t.code !== currentTrip.code);
            localStorage.setItem('recentTrips', JSON.stringify(recent));
            
            hideModal('confirmModal');
            hideModal('editTripModal');
            showWelcomeScreen();
            showToast('Ø³ÙØ± Ø­Ø°Ù Ø´Ø¯', 'success');
        }

        function shareTripCode() {
            document.getElementById('shareCodeDisplay').textContent = currentTrip.code;
            showModal('shareModal');
        }

        function copyTripCode() {
            navigator.clipboard.writeText(currentTrip.code).then(() => {
                showToast('Ú©Ø¯ Ú©Ù¾ÛŒ Ø´Ø¯! ğŸ“‹', 'success');
            });
        }

        // ========== MEMBER MANAGEMENT ==========
        function addMember() {
            const name = document.getElementById('newMemberName').value.trim();
            
            if (!name) {
                showToast('Ù†Ø§Ù… Ø¹Ø¶Ùˆ Ø±Ø§ ÙˆØ§Ø±Ø¯ Ú©Ù†ÛŒØ¯', 'error');
                return;
            }

            if (currentTrip.members.find(m => m.name === name)) {
                showToast('Ø§ÛŒÙ† Ù†Ø§Ù… Ù‚Ø¨Ù„Ø§Ù‹ Ø«Ø¨Øª Ø´Ø¯Ù‡', 'error');
                return;
            }

            currentTrip.members.push({
                id: generateId(),
                name: name,
                avatar: selectedAvatar,
                joinedAt: Date.now()
            });

            saveToStorage();
            hideModal('addMemberModal');
            document.getElementById('newMemberName').value = '';
            renderAll();
            showToast('Ø¹Ø¶Ùˆ Ø§Ø¶Ø§ÙÙ‡ Ø´Ø¯', 'success');
        }

        function showMemberDetail(memberId) {
            const member = currentTrip.members.find(m => m.id === memberId);
            if (!member) return;

            currentMemberId = memberId;
            const balance = calculateMemberBalance(memberId);
            const paid = calculateMemberPaid(memberId);
            const share = calculateMemberShare(memberId);

            document.getElementById('memberDetailContent').innerHTML = `
                <div style="text-align: center; margin-bottom: 20px;">
                    <div style="font-size: 60px; margin-bottom: 12px;">${member.avatar}</div>
                    <h3 style="font-size: 20px; margin-bottom: 8px;">${member.name}</h3>
                    ${member.id === currentTrip.adminId ? '<span class="card-badge" style="background: var(--warning);">ğŸ‘‘ Ù…Ø¯ÛŒØ±</span>' : ''}
                </div>
                
                <div class="stats-grid">
                    <div class="stat-card info">
                        <div class="stat-value">${formatNumber(paid)}</div>
                        <div class="stat-label">Ù¾Ø±Ø¯Ø§Ø®Øª Ú©Ø±Ø¯Ù‡</div>
                    </div>
                    <div class="stat-card warning">
                        <div class="stat-value">${formatNumber(share)}</div>
                        <div class="stat-label">Ø³Ù‡Ù… Ø§Ø² Ù‡Ø²ÛŒÙ†Ù‡</div>
                    </div>
                </div>
                
                <div class="stat-card ${balance >= 0 ? 'success' : 'danger'}" style="margin-top: 12px;">
                    <div class="stat-value">${balance >= 0 ? '+' : ''}${formatNumber(balance)}</div>
                    <div class="stat-label">${balance >= 0 ? 'Ø·Ù„Ø¨Ú©Ø§Ø±' : 'Ø¨Ø¯Ù‡Ú©Ø§Ø±'}</div>
                </div>
            `;

            showModal('memberDetailModal');
        }

        function editCurrentMember() {
            const member = currentTrip.members.find(m => m.id === currentMemberId);
            if (!member) return;

            hideModal('memberDetailModal');
            document.getElementById('editMemberId').value = member.id;
            document.getElementById('editMemberName').value = member.name;
            selectedAvatar = member.avatar;
            renderAvatarGrid('editMemberAvatarGrid', member.avatar);
            showModal('editMemberModal');
        }

        function updateMember() {
            const memberId = document.getElementById('editMemberId').value;
            const idx = currentTrip.members.findIndex(m => m.id === memberId);
            
            if (idx < 0) return;

            currentTrip.members[idx].name = document.getElementById('editMemberName').value.trim();
            currentTrip.members[idx].avatar = selectedAvatar;
            
            if (currentUser.id === memberId) {
                currentUser = currentTrip.members[idx];
            }

            saveToStorage();
            hideModal('editMemberModal');
            renderAll();
            showToast('Ø¹Ø¶Ùˆ Ø¨Ø±ÙˆØ²Ø±Ø³Ø§Ù†ÛŒ Ø´Ø¯', 'success');
        }

        function removeCurrentMember() {
            const member = currentTrip.members.find(m => m.id === currentMemberId);
            if (!member) return;

            if (member.id === currentTrip.adminId) {
                showToast('Ù…Ø¯ÛŒØ± Ù‚Ø§Ø¨Ù„ Ø­Ø°Ù Ù†ÛŒØ³Øª', 'error');
                return;
            }

            document.getElementById('confirmTitle').textContent = 'ğŸšª Ø­Ø°Ù Ø¹Ø¶Ùˆ';
            document.getElementById('confirmMessage').textContent = `"${member.name}" Ø­Ø°Ù Ø´ÙˆØ¯ØŸ`;
            document.getElementById('confirmBtn').onclick = () => {
                // Ø­Ø°Ù Ø¹Ø¶Ùˆ Ø§Ø² Ù‡Ø²ÛŒÙ†Ù‡â€ŒÙ‡Ø§
                currentTrip.expenses.forEach(exp => {
                    exp.splitBetween = exp.splitBetween.filter(id => id !== currentMemberId);
                    if (exp.splitBetween.length === 0) {
                        exp.splitBetween = currentTrip.members.filter(m => m.id !== currentMemberId).map(m => m.id);
                    }
                    if (exp.payerId === currentMemberId) {
                        exp.payerId = currentTrip.adminId;
                    }
                });
                
                currentTrip.members = currentTrip.members.filter(m => m.id !== currentMemberId);
                saveToStorage();
                hideModal('confirmModal');
                hideModal('memberDetailModal');
                renderAll();
                showToast('Ø¹Ø¶Ùˆ Ø­Ø°Ù Ø´Ø¯', 'success');
            };
            showModal('confirmModal');
        }

        // ========== EXPENSE MANAGEMENT ==========
        function setSplitType(type) {
            splitType = type;
            document.querySelectorAll('.split-toggle-btn').forEach(btn => {
                btn.classList.toggle('active', btn.dataset.split === type);
            });
            document.getElementById('splitEqualSection').style.display = type === 'equal' ? 'block' : 'none';
            document.getElementById('splitCustomSection').style.display = type === 'custom' ? 'block' : 'none';
        }

        function renderExpenseForm() {
            const payerSelect = document.getElementById('expensePayer');
            payerSelect.innerHTML = currentTrip.members.map(m => 
                `<option value="${m.id}" ${m.id === currentUser.id ? 'selected' : ''}>${m.avatar} ${m.name}</option>`
            ).join('');

            document.getElementById('splitMembersList').innerHTML = currentTrip.members.map(m => `
                <label class="checkbox-item">
                    <input type="checkbox" value="${m.id}" checked>
                    <span>${m.avatar} ${m.name}</span>
                </label>
            `).join('');

            document.getElementById('customSplitList').innerHTML = currentTrip.members.map(m => `
                <div class="custom-split-item">
                    <div class="info">
                        <span class="avatar">${m.avatar}</span>
                        <span class="name">${m.name}</span>
                    </div>
                    <input type="text" data-member="${m.id}" placeholder="Û°" inputmode="numeric">
                </div>
            `).join('');

            renderCategoryGrid('categoryGrid', 'food');
            selectedCategory = 'food';
            splitType = 'equal';
            setSplitType('equal');
        }

        function saveExpense() {
            const title = document.getElementById('expenseTitle').value.trim();
            const amount = parseNumber(document.getElementById('expenseAmount').value);
            const payerId = document.getElementById('expensePayer').value;

            if (!title || !amount) {
                showToast('Ø¹Ù†ÙˆØ§Ù† Ùˆ Ù…Ø¨Ù„Øº Ø±Ø§ ÙˆØ§Ø±Ø¯ Ú©Ù†ÛŒØ¯', 'error');
                return;
            }

            let splitBetween = [];
            let customAmounts = {};

            if (splitType === 'equal') {
                document.querySelectorAll('#splitMembersList input:checked').forEach(cb => {
                    splitBetween.push(cb.value);
                });
            } else {
                document.querySelectorAll('#customSplitList input').forEach(input => {
                    const amt = parseNumber(input.value);
                    if (amt > 0) {
                        splitBetween.push(input.dataset.member);
                        customAmounts[input.dataset.member] = amt;
                    }
                });
            }

            if (splitBetween.length === 0) {
                showToast('Ø­Ø¯Ø§Ù‚Ù„ ÛŒÚ© Ù†ÙØ± Ø§Ù†ØªØ®Ø§Ø¨ Ú©Ù†ÛŒØ¯', 'error');
                return;
            }

            currentTrip.expenses.push({
                id: generateId(),
                title,
                amount,
                category: selectedCategory,
                payerId,
                splitBetween,
                splitType,
                customAmounts: splitType === 'custom' ? customAmounts : null,
                createdAt: Date.now()
            });

            saveToStorage();
            hideModal('addExpenseModal');
            document.getElementById('expenseTitle').value = '';
            document.getElementById('expenseAmount').value = '';
            renderAll();
            showToast('Ù‡Ø²ÛŒÙ†Ù‡ Ø«Ø¨Øª Ø´Ø¯ âœ…', 'success');
        }

        function showExpenseDetail(expenseId) {
            const expense = currentTrip.expenses.find(e => e.id === expenseId);
            if (!expense) return;

            currentExpenseId = expenseId;
            const payer = currentTrip.members.find(m => m.id === expense.payerId);
            const cat = getCategoryInfo(expense.category);
            const perPerson = Math.round(expense.amount / expense.splitBetween.length);

            document.getElementById('expenseDetailContent').innerHTML = `
                <div style="text-align: center; margin-bottom: 20px;">
                    <div style="font-size: 48px; margin-bottom: 12px;">${cat.icon}</div>
                    <h3 style="font-size: 18px; margin-bottom: 8px;">${expense.title}</h3>
                    <div style="font-size: 24px; font-weight: 800; color: var(--primary);">
                        ${formatNumber(expense.amount)} ØªÙˆÙ…Ø§Ù†
                    </div>
                </div>
                
                <div class="expense-detail-info">
                    <div class="info-row">
                        <span>ğŸ’³ Ù¾Ø±Ø¯Ø§Ø®Øªâ€ŒÚ©Ù†Ù†Ø¯Ù‡:</span>
                        <span>${payer?.avatar || 'ğŸ‘¤'} ${payer?.name || 'Ù†Ø§Ù…Ø´Ø®Øµ'}</span>
                    </div>
                    <div class="info-row">
                        <span>ğŸ·ï¸ Ø¯Ø³ØªÙ‡â€ŒØ¨Ù†Ø¯ÛŒ:</span>
                        <span>${cat.icon} ${cat.name}</span>
                    </div>
                    <div class="info-row">
                        <span>ğŸ‘¥ ØªÙ‚Ø³ÛŒÙ… Ø¨ÛŒÙ†:</span>
                        <span>${toPersian(expense.splitBetween.length)} Ù†ÙØ±</span>
                    </div>
                    <div class="info-row">
                        <span>ğŸ’° Ø³Ù‡Ù… Ù‡Ø± Ù†ÙØ±:</span>
                        <span>${formatNumber(perPerson)} ØªÙˆÙ…Ø§Ù†</span>
                    </div>
                </div>
                
                <div class="divider">Ø´Ø±ÛŒÚ©â€ŒÙ‡Ø§</div>
                <div class="split-members-list">
                    ${expense.splitBetween.map(id => {
                        const m = currentTrip.members.find(x => x.id === id);
                        const share = expense.customAmounts?.[id] || perPerson;
                        return `<div class="split-member-item">
                            <span>${m?.avatar || 'ğŸ‘¤'} ${m?.name || 'Ù†Ø§Ù…Ø´Ø®Øµ'}</span>
                            <span>${formatNumber(share)} ØªÙˆÙ…Ø§Ù†</span>
                        </div>`;
                    }).join('')}
                </div>
            `;

            showModal('expenseDetailModal');
        }

        function editCurrentExpense() {
            const expense = currentTrip.expenses.find(e => e.id === currentExpenseId);
            if (!expense) return;

            hideModal('expenseDetailModal');
            
            document.getElementById('editExpenseId').value = expense.id;
            document.getElementById('editExpenseTitle').value = expense.title;
            document.getElementById('editExpenseAmount').value = formatNumber(expense.amount);
            
            document.getElementById('editExpensePayer').innerHTML = currentTrip.members.map(m => 
                `<option value="${m.id}" ${m.id === expense.payerId ? 'selected' : ''}>${m.avatar} ${m.name}</option>`
            ).join('');
            
            selectedEditCategory = expense.category;
            renderCategoryGrid('editCategoryGrid', expense.category);
            
            showModal('editExpenseModal');
        }

        function updateExpense() {
            const expenseId = document.getElementById('editExpenseId').value;
            const idx = currentTrip.expenses.findIndex(e => e.id === expenseId);
            
            if (idx < 0) return;

            currentTrip.expenses[idx].title = document.getElementById('editExpenseTitle').value.trim();
            currentTrip.expenses[idx].amount = parseNumber(document.getElementById('editExpenseAmount').value);
            currentTrip.expenses[idx].category = selectedEditCategory;
            currentTrip.expenses[idx].payerId = document.getElementById('editExpensePayer').value;

            saveToStorage();
            hideModal('editExpenseModal');
            renderAll();
            showToast('Ù‡Ø²ÛŒÙ†Ù‡ Ø¨Ø±ÙˆØ²Ø±Ø³Ø§Ù†ÛŒ Ø´Ø¯', 'success');
        }

        function deleteCurrentExpense() {
            document.getElementById('confirmTitle').textContent = 'ğŸ—‘ï¸ Ø­Ø°Ù Ù‡Ø²ÛŒÙ†Ù‡';
            document.getElementById('confirmMessage').textContent = 'Ø§ÛŒÙ† Ù‡Ø²ÛŒÙ†Ù‡ Ø­Ø°Ù Ø´ÙˆØ¯ØŸ';
            document.getElementById('confirmBtn').onclick = () => {
                currentTrip.expenses = currentTrip.expenses.filter(e => e.id !== currentExpenseId);
                saveToStorage();
                hideModal('confirmModal');
                hideModal('expenseDetailModal');
                renderAll();
                showToast('Ù‡Ø²ÛŒÙ†Ù‡ Ø­Ø°Ù Ø´Ø¯', 'success');
            };
            showModal('confirmModal');
        }

        // ========== CALCULATIONS ==========
        function calculateMemberPaid(memberId) {
            return currentTrip.expenses
                .filter(e => e.payerId === memberId)
                .reduce((sum, e) => sum + e.amount, 0);
        }

        function calculateMemberShare(memberId) {
            return currentTrip.expenses.reduce((sum, exp) => {
                if (!exp.splitBetween.includes(memberId)) return sum;
                if (exp.customAmounts?.[memberId]) return sum + exp.customAmounts[memberId];
                return sum + Math.round(exp.amount / exp.splitBetween.length);
            }, 0);
        }

        function calculateMemberBalance(memberId) {
            return calculateMemberPaid(memberId) - calculateMemberShare(memberId);
        }

        function calculateSettlements() {
            const balances = currentTrip.members.map(m => ({
                ...m,
                balance: calculateMemberBalance(m.id)
            }));

            const debtors = balances.filter(b => b.balance < 0).sort((a, b) => a.balance - b.balance);
            const creditors = balances.filter(b => b.balance > 0).sort((a, b) => b.balance - a.balance);
            
            const settlements = [];
            let i = 0, j = 0;

            while (i < debtors.length && j < creditors.length) {
                const amount = Math.min(-debtors[i].balance, creditors[j].balance);
                
                if (amount > 0) {
                    settlements.push({
                        from: debtors[i],
                        to: creditors[j],
                        amount: Math.round(amount)
                    });
                }

                debtors[i].balance += amount;
                creditors[j].balance -= amount;

                if (Math.abs(debtors[i].balance) < 1) i++;
                if (Math.abs(creditors[j].balance) < 1) j++;
            }

            return settlements;
        }

        // ========== RENDERING ==========
        function renderAll() {
            if (!currentTrip) return;

            // Header
            document.getElementById('tripNameDisplay').textContent = currentTrip.name;
            document.getElementById('memberCountDisplay').textContent = toPersian(currentTrip.members.length);
            document.getElementById('tripDateDisplay').textContent = currentTrip.date;
            document.getElementById('editTripName').value = currentTrip.name;
            document.getElementById('editTripDate').value = currentTrip.date;

            // Stats
            const total = currentTrip.expenses.reduce((sum, e) => sum + e.amount, 0);
            const perPerson = currentTrip.members.length > 0 ? Math.round(total / currentTrip.members.length) : 0;
            const myBalance = currentUser ? calculateMemberBalance(currentUser.id) : 0;

            document.getElementById('totalExpenses').textContent = formatNumber(total);
            document.getElementById('perPersonAvg').textContent = formatNumber(perPerson);
            document.getElementById('expenseCount').textContent = toPersian(currentTrip.expenses.length);
            document.getElementById('expensesBadge').textContent = toPersian(currentTrip.expenses.length);
            
            const myBalanceEl = document.getElementById('myBalance');
            const myBalanceCard = document.getElementById('myBalanceCard');
            myBalanceEl.textContent = (myBalance >= 0 ? '+' : '') + formatNumber(myBalance);
            myBalanceCard.className = `stat-card ${myBalance >= 0 ? 'success' : 'danger'}`;

            renderQuickBalance();
            renderRecentExpenses();
            renderExpensesList();
            renderMembersList();
            renderSettlements();
            renderReportStats();
            renderExpenseForm();
            updateAdminUI();
        }

        function renderQuickBalance() {
            document.getElementById('quickBalanceList').innerHTML = currentTrip.members.slice(0, 4).map(m => {
                const balance = calculateMemberBalance(m.id);
                return `<div class="balance-item">
                    <div class="balance-info">
                        <span class="balance-avatar">${m.avatar}</span>
                        <span class="balance-name">${m.name}</span>
                    </div>
                    <span class="balance-amount ${balance >= 0 ? 'positive' : 'negative'}">
                        ${balance >= 0 ? '+' : ''}${formatNumber(balance)}
                    </span>
                </div>`;
            }).join('');
        }

        function renderRecentExpenses() {
            const recent = [...currentTrip.expenses].reverse().slice(0, 3);
            const container = document.getElementById('recentExpensesList');
            
            if (recent.length === 0) {
                container.innerHTML = '<div class="empty-state"><div class="icon">ğŸ“</div><p>Ù‡Ù†ÙˆØ² Ù‡Ø²ÛŒÙ†Ù‡â€ŒØ§ÛŒ Ø«Ø¨Øª Ù†Ø´Ø¯Ù‡</p></div>';
                return;
            }

            container.innerHTML = recent.map(exp => {
                const cat = getCategoryInfo(exp.category);
                const payer = currentTrip.members.find(m => m.id === exp.payerId);
                return `<div class="expense-item" onclick="showExpenseDetail('${exp.id}')">
                    <div class="expense-icon">${cat.icon}</div>
                    <div class="expense-info">
                        <div class="expense-title">${exp.title}</div>
                        <div class="expense-meta">${payer?.name || 'Ù†Ø§Ù…Ø´Ø®Øµ'} â€¢ ${cat.name}</div>
                    </div>
                    <div class="expense-amount">${formatNumber(exp.amount)}</div>
                </div>`;
            }).join('');
        }

        function renderExpensesList() {
            const container = document.getElementById('expensesList');
            
            if (currentTrip.expenses.length === 0) {
                container.innerHTML = '<div class="empty-state"><div class="icon">ğŸ§¾</div><p>Ù‡Ù†ÙˆØ² Ù‡Ø²ÛŒÙ†Ù‡â€ŒØ§ÛŒ Ø«Ø¨Øª Ù†Ø´Ø¯Ù‡</p></div>';
                return;
            }

            container.innerHTML = [...currentTrip.expenses].reverse().map(exp => {
                const cat = getCategoryInfo(exp.category);
                const payer = currentTrip.members.find(m => m.id === exp.payerId);
                return `<div class="expense-item" onclick="showExpenseDetail('${exp.id}')">
                    <div class="expense-icon">${cat.icon}</div>
                    <div class="expense-info">
                        <div class="expense-title">${exp.title}</div>
                        <div class="expense-meta">${payer?.name || 'Ù†Ø§Ù…Ø´Ø®Øµ'} â€¢ ${cat.name}</div>
                    </div>
                    <div class="expense-amount">${formatNumber(exp.amount)}</div>
                </div>`;
            }).join('');
        }

        function renderMembersList() {
            document.getElementById('membersList').innerHTML = currentTrip.members.map(m => {
                const balance = calculateMemberBalance(m.id);
                return `<div class="member-item" onclick="showMemberDetail('${m.id}')">
                    <div class="member-avatar">${m.avatar}</div>
                    <div class="member-info">
                        <div class="member-name">
                            ${m.name}
                            ${m.id === currentTrip.adminId ? '<span class="admin-badge">ğŸ‘‘</span>' : ''}
                        </div>
                        <div class="member-balance ${balance >= 0 ? 'positive' : 'negative'}">
                            ${balance >= 0 ? 'Ø·Ù„Ø¨Ú©Ø§Ø±' : 'Ø¨Ø¯Ù‡Ú©Ø§Ø±'}: ${formatNumber(Math.abs(balance))}
                        </div>
                    </div>
                </div>`;
            }).join('');
        }

        function renderSettlements() {
            const settlements = calculateSettlements();
            const container = document.getElementById('settlementList');
            
            if (settlements.length === 0) {
                container.innerHTML = '<div class="empty-state"><div class="icon">âœ…</div><p>Ù‡Ù…Ù‡ ØªØ³ÙˆÛŒÙ‡ Ø´Ø¯Ù‡â€ŒØ§Ù†Ø¯!</p></div>';
                return;
            }

            container.innerHTML = settlements.map(s => `
                <div class="settlement-item">
                    <div class="settlement-person">
                        <div class="avatar">${s.from.avatar}</div>
                        <div class="name">${s.from.name}</div>
                    </div>
                    <div class="settlement-arrow">
                        <div class="amount">${formatNumber(s.amount)}</div>
                        <div class="icon">â†</div>
                    </div>
                    <div class="settlement-person">
                        <div class="avatar">${s.to.avatar}</div>
                        <div class="name">${s.to.name}</div>
                    </div>
                </div>
            `).join('');
        }

        function renderReportStats() {
            const total = currentTrip.expenses.reduce((sum, e) => sum + e.amount, 0);
            const avg = currentTrip.expenses.length > 0 ? Math.round(total / currentTrip.expenses.length) : 0;
            const max = currentTrip.expenses.reduce((m, e) => e.amount > m.amount ? e : m, { amount: 0, title: '-' });
            
            document.getElementById('reportStats').innerHTML = `
                <div class="report-stat-row"><span>ğŸ’° Ú©Ù„ Ù‡Ø²ÛŒÙ†Ù‡â€ŒÙ‡Ø§:</span><strong>${formatNumber(total)} ØªÙˆÙ…Ø§Ù†</strong></div>
                <div class="report-stat-row"><span>ğŸ“Š Ù…ÛŒØ§Ù†Ú¯ÛŒÙ†:</span><strong>${formatNumber(avg)} ØªÙˆÙ…Ø§Ù†</strong></div>
                <div class="report-stat-row"><span>ğŸ” Ø¨ÛŒØ´ØªØ±ÛŒÙ†:</span><strong>${max.title} (${formatNumber(max.amount)})</strong></div>
                <div class="report-stat-row"><span>ğŸ‘¥ Ø§Ø¹Ø¶Ø§:</span><strong>${toPersian(currentTrip.members.length)} Ù†ÙØ±</strong></div>
            `;

            const spenders = currentTrip.members.map(m => ({
                ...m,
                paid: calculateMemberPaid(m.id)
            })).sort((a, b) => b.paid - a.paid).slice(0, 3);

            document.getElementById('topSpenders').innerHTML = spenders.map((s, i) => `
                <div class="top-spender-item">
                    <span class="rank">${['ğŸ¥‡', 'ğŸ¥ˆ', 'ğŸ¥‰'][i]}</span>
                    <span class="spender-avatar">${s.avatar}</span>
                    <span class="spender-name">${s.name}</span>
                    <span class="spender-amount">${formatNumber(s.paid)}</span>
                </div>
            `).join('');
        }

        function renderChart() {
            const canvas = document.getElementById('expenseChart');
            if (!canvas) return;

            const ctx = canvas.getContext('2d');
            
            const categoryTotals = {};
            CATEGORIES.forEach(cat => categoryTotals[cat.id] = 0);
            currentTrip.expenses.forEach(e => {
                categoryTotals[e.category] = (categoryTotals[e.category] || 0) + e.amount;
            });

            const data = CATEGORIES.map(cat => categoryTotals[cat.id]).filter(v => v > 0);
            const labels = CATEGORIES.filter(cat => categoryTotals[cat.id] > 0).map(cat => cat.name);
            const colors = ['#FF6B6B', '#4ECDC4', '#45B7D1', '#96CEB4', '#FFEAA7', '#DDA0DD'];

            if (expenseChart) expenseChart.destroy();

            if (data.length === 0) {
                ctx.clearRect(0, 0, canvas.width, canvas.height);
                ctx.font = '14px Vazirmatn';
                ctx.fillStyle = '#94A3B8';
                ctx.textAlign = 'center';
                ctx.fillText('Ø¯Ø§Ø¯Ù‡â€ŒØ§ÛŒ ÙˆØ¬ÙˆØ¯ Ù†Ø¯Ø§Ø±Ø¯', canvas.width / 2, canvas.height / 2);
                return;
            }

            expenseChart = new Chart(ctx, {
                type: 'doughnut',
                data: {
                    labels,
                    datasets: [{ data, backgroundColor: colors.slice(0, data.length), borderWidth: 0 }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: true,
                    plugins: {
                        legend: {
                            position: 'bottom',
                            labels: {
                                font: { family: 'Vazirmatn', size: 12 },
                                color: '#CBD5E1',
                                padding: 15
                            }
                        }
                    }
                }
            });
        }

        // ========== PDF EXPORT ==========
        async function exportToPDF() {
            showLoading();
            
            try {
                const { jsPDF } = window.jspdf;
                const doc = new jsPDF('p', 'mm', 'a4');
                
                let y = 20;
                const margin = 15;
                const pageWidth = doc.internal.pageSize.getWidth();
                
                doc.setFontSize(22);
                doc.setTextColor(13, 148, 136);
                doc.text('Safarino Report', pageWidth / 2, y, { align: 'center' });
                y += 12;
                
                doc.setFontSize(14);
                doc.setTextColor(51, 65, 85);
                doc.text(`Trip: ${currentTrip.name}`, pageWidth / 2, y, { align: 'center' });
                y += 8;
                
                doc.setFontSize(10);
                doc.setTextColor(100, 116, 139);
                doc.text(`Date: ${currentTrip.date} | Members: ${currentTrip.members.length}`, pageWidth / 2, y, { align: 'center' });
                y += 15;
                
                doc.setDrawColor(203, 213, 225);
                doc.line(margin, y, pageWidth - margin, y);
                y += 10;
                
                const total = currentTrip.expenses.reduce((s, e) => s + e.amount, 0);
                const perPerson = Math.round(total / currentTrip.members.length);
                
                doc.setFontSize(12);
                doc.setTextColor(51, 65, 85);
                doc.text('Summary:', margin, y);
                y += 7;
                
                doc.setFontSize(10);
                doc.text(`Total: ${total.toLocaleString()} Toman`, margin + 5, y); y += 5;
                doc.text(`Per Person: ${perPerson.toLocaleString()} Toman`, margin + 5, y); y += 5;
                doc.text(`Expenses: ${currentTrip.expenses.length}`, margin + 5, y); y += 12;
                
                doc.setFontSize(12);
                doc.text('Member Balances:', margin, y);
                y += 7;
                
                currentTrip.members.forEach(m => {
                    const bal = calculateMemberBalance(m.id);
                    doc.setFontSize(10);
                    doc.text(`${m.name}: ${bal >= 0 ? 'Creditor' : 'Debtor'} ${Math.abs(bal).toLocaleString()}`, margin + 5, y);
                    y += 5;
                    if (y > 270) { doc.addPage(); y = 20; }
                });
                y += 8;
                
                const settlements = calculateSettlements();
                if (settlements.length > 0) {
                    doc.setFontSize(12);
                    doc.text('Settlements:', margin, y);
                    y += 7;
                    
                    settlements.forEach(s => {
                        doc.setFontSize(10);
                        doc.text(`${s.from.name} -> ${s.to.name}: ${s.amount.toLocaleString()}`, margin + 5, y);
                        y += 5;
                        if (y > 270) { doc.addPage(); y = 20; }
                    });
                    y += 8;
                }
                
                if (currentTrip.expenses.length > 0) {
                    doc.setFontSize(12);
                    doc.text('Expenses:', margin, y);
                    y += 7;
                    
                    currentTrip.expenses.forEach((exp, i) => {
                        const payer = currentTrip.members.find(m => m.id === exp.payerId);
                        doc.setFontSize(9);
                        doc.text(`${i + 1}. ${exp.title} - ${exp.amount.toLocaleString()} (${payer?.name || '-'})`, margin + 5, y);
                        y += 5;
                        if (y > 270) { doc.addPage(); y = 20; }
                    });
                }
                
                const pages = doc.internal.getNumberOfPages();
                for (let i = 1; i <= pages; i++) {
                    doc.setPage(i);
                    doc.setFontSize(8);
                    doc.setTextColor(100, 116, 139);
                    doc.text('Safarino | Mohammad Abbasi', pageWidth / 2, 290, { align: 'center' });
                }
                
                doc.save(`Safarino_${currentTrip.name}.pdf`);
                hideLoading();
                showToast('PDF Ø¯Ø§Ù†Ù„ÙˆØ¯ Ø´Ø¯ ğŸ“¥', 'success');
                
            } catch (err) {
                hideLoading();
                console.error(err);
                showToast('Ø®Ø·Ø§ Ø¯Ø± Ø§ÛŒØ¬Ø§Ø¯ PDF', 'error');
            }
        }

        // ========== INIT ==========
        function init() {
            // Load theme
            const savedTheme = localStorage.getItem('theme') || 'night';
            setTheme(savedTheme);
            
            // Render avatar grids
            renderAvatarGrid('adminAvatarGrid');
            renderAvatarGrid('joinAvatarGrid');
            renderAvatarGrid('newMemberAvatarGrid');
            
            // Check for saved trip
            const savedUser = JSON.parse(localStorage.getItem('currentUser') || 'null');
            const recent = JSON.parse(localStorage.getItem('recentTrips') || '[]');
            
            if (savedUser && recent.length > 0) {
                const trip = loadFromStorage(recent[0].code);
                if (trip && trip.members.find(m => m.id === savedUser.id)) {
                    currentTrip = trip;
                    currentUser = savedUser;
                    showTripScreen();
                    hideLoading();
                    return;
                }
            }
            
            loadRecentTrips();
            hideLoading();
        }

        // Close settings on outside click
        document.addEventListener('click', (e) => {
            const panel = document.getElementById('settingsPanel');
            if (panel.classList.contains('show') && !panel.contains(e.target) && !e.target.closest('[onclick*="toggleSettings"]')) {
                panel.classList.remove('show');
            }
        });

        // Close modal on backdrop click
        document.addEventListener('click', (e) => {
            if (e.target.classList.contains('modal') && e.target.classList.contains('active')) {
                e.target.classList.remove('active');
                document.body.style.overflow = '';
            }
        });

        // Auto-format numbers
        document.addEventListener('input', (e) => {
            if (e.target.id === 'expenseAmount' || e.target.id === 'editExpenseAmount') {
                const num = parseNumber(e.target.value);
                if (num > 0) e.target.value = formatNumber(num);
            }
        });

        // Start app
        document.addEventListener('DOMContentLoaded', init);
    </script>
</body>
</html>
